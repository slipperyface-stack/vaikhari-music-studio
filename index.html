<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Vaikhari Music Studio</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>



:root {
  /* ── Paper tones ── */
  --bg:     #f2ede0;
  --bg2:    #e8e0ce;
  --panel:  #f9f5ec;
  --panel2: #e8dfc8;
  --panel3: #d8cdb4;

  /* Borders — strong and visible */
  --ink:    rgba(40,25,8,1);
  --border: rgba(40,25,8,0.55);
  --bord2:  rgba(40,25,8,0.35);

  /* Accent colours — deeper, richer */
  --forest: #0e3d1e;
  --forest2:#082a14;
  --indigo: #1e2d6e;
  --rust:   #5c1a08;
  --ochre:  #5c3c08;
  --umber:  #3a2406;

  /* Text — maximum contrast */
  --t1: #0a0502;
  --t2: #120a04;
  --t3: #241408;
  --t4: #3e2808;

  --mono: 'Helvetica Neue', Helvetica, Arial, sans-serif;
  --ui:   'Poppins', sans-serif;
  --head: 'Poppins', sans-serif;
  --hand: 'Poppins', sans-serif;

  --pencil-soft:   rgba(40,25,8,0.25);
  --pencil-mid:    rgba(40,25,8,0.50);
  --pencil-faint:  rgba(40,25,8,0.14);
  --pencil-2b:     #0a0502;
  --pencil-hb:     #241408;
  --pencil-hb2:    #3e2808;
  --pencil-h:      #5c3c18;
  --paper:         #f9f5ec;
  --paper2:        #e8dfc8;
  --red-ink:       #5c1808;
  --amber-ink:     #4a3008;

  --saffron:       #c0620a;
  --saffron-dim:   #9a4c06;
  --saffron-lt:    rgba(192,98,10,0.18);
  --saffron-faint: rgba(192,98,10,0.09);
}

/* ── Dark mode toggle button ── */
.dark-toggle {
  display: flex; align-items: center; gap: 6px;
  padding: 5px 13px; border: 1.5px solid var(--border); border-radius: 20px;
  background: transparent; font-family: var(--mono); font-size: 10px; letter-spacing: 1px;
  color: var(--t3); cursor: pointer; transition: all 0.2s; white-space: nowrap;
}
.dark-toggle:hover { border-color: var(--t3); color: var(--t2); }
.dark-toggle .dt-icon { font-size: 14px; transition: transform 0.4s; line-height: 1; }

/* ════════════════════════════════════════════
   DARK MODE — warm charcoal night
════════════════════════════════════════════ */
body.dark {
  --bg:     #111008;
  --bg2:    #18160e;
  --panel:  #1c1a10;
  --panel2: #232016;
  --panel3: #2c291c;

  /* Borders — clearly visible on dark */
  --ink:    rgba(245,228,195,1);
  --border: rgba(220,198,158,0.65);
  --bord2:  rgba(220,198,158,0.40);

  /* Accents — vivid, high contrast on dark */
  --forest: #52e878;
  --forest2:#3ec85a;
  --indigo: #9abcff;
  --rust:   #ff8870;
  --ochre:  #ffcc50;
  --umber:  #e0aa58;

  /* Text — strong contrast on dark */
  --t1: #faf2e2;
  --t2: #ecdabb;
  --t3: #d0b888;
  --t4: #a89060;

  --saffron:       #ff9640;
  --saffron-dim:   #d07828;
  --saffron-lt:    rgba(255,150,64,0.25);
  --saffron-faint: rgba(255,150,64,0.12);

  --pencil-soft:  rgba(220,198,158,0.20);
  --pencil-mid:   rgba(220,198,158,0.45);
  --pencil-2b:    #faf2e2;
  --pencil-hb:    #d0b888;
  --pencil-hb2:   #a89060;
  --pencil-h:     #807048;
  --paper:        #1c1a10;
  --paper2:       #232016;
  --red-ink:      #ff8870;
  --amber-ink:    #ffcc50;
}

body.dark { background-image: none; }

/* ── Header ── */
body.dark header {
  background: rgba(25,22,16,0.97);
  border-color: var(--border);
  box-shadow: 0 1px 12px rgba(0,0,0,0.5), 0 1px 0 rgba(200,178,140,0.06);
}

/* ── Sticky bars ── */
/* ── Sticky shell dark mode handled above ── */

/* ── Panels ── */
body.dark .panel,
body.dark .spl-panel {
  background: var(--panel);
  border-color: var(--border);
  box-shadow:
    0 2px 16px rgba(0,0,0,0.45),
    0 1px 0 rgba(200,178,140,0.06) inset;
}
body.dark .panel::before {
  background: linear-gradient(140deg, rgba(240,220,180,0.025) 0%, transparent 50%);
}
body.dark .ph {
  border-color: var(--bord2);
  background: rgba(0,0,0,0.25);
}
body.dark .ph-t { color: var(--t1); letter-spacing: 2px; font-weight: 800; }
body.dark .ph-r { color: var(--t2); font-weight: 700; }
body.dark .win-min-btn {
  border-color: var(--border); color: var(--t1); background: var(--panel3); font-weight: 700;
}
body.dark .win-min-btn:hover { background: var(--t3); color: var(--panel); border-color: var(--t2); }

/* ── Form elements ── */
body.dark select {
  background: var(--panel2); color: var(--t2);
  border-color: var(--border);
}
body.dark input[type=range],
body.dark .sl { accent-color: var(--ochre); }

/* ── Button groups (.b) ── */
body.dark .b {
  color: var(--t1); border-color: var(--border);
  background: rgba(220,198,158,0.08);
  font-weight: 600;
}
body.dark .b:hover {
  background: rgba(220,198,158,0.18);
  color: var(--t1);
  border-color: var(--t1);
}
body.dark .b.on {
  background: rgba(220,198,158,0.25);
  border-color: var(--t1);
  color: var(--t1);
  font-weight: 800;
}

/* ── Panel toggle pills ── */
body.dark .ptog {
  border-color: var(--border);
  color: var(--t1);
  background: var(--panel2);
  font-weight: 600;
}
body.dark .ptog:hover {
  background: var(--panel3);
  color: var(--t1);
  border-color: var(--t2);
}
body.dark .ptog.on {
  background: rgba(82,232,120,0.22);
  border-color: var(--forest);
  color: var(--forest);
  font-weight: 700;
}
body.dark .pbar-lbl { color: var(--t1); font-weight: 700; }
body.dark .pbar-sep { background: var(--border); }

/* ── Universal bar ── */
body.dark .ubar-lbl { color: var(--t1); font-weight: 700; }
body.dark .ubar-group { border-color: var(--border); }
body.dark .ubar-arr {
  background: var(--panel3); border-color: var(--border); color: var(--t1); font-weight: 700;
}
body.dark .ubar-arr:hover {
  background: var(--t3); color: var(--panel); border-color: var(--t2);
}
body.dark #ubarBpmNum { color: var(--t1); font-weight: 800; }
body.dark .ubar-bpm-unit { color: var(--t3); }
body.dark .ubar-key {
  border-color: var(--border); color: var(--t2); background: var(--panel2); font-weight: 600;
}
body.dark .ubar-key:hover {
  border-color: var(--forest); color: var(--forest);
  background: rgba(82,232,120,0.10);
}
body.dark .ubar-key.on {
  background: var(--forest); border-color: var(--forest);
  color: #0a0802; font-weight: 800;
}
body.dark #ubarTapBtn,
body.dark #ubarClapBtn {
  border-color: var(--border); color: var(--t2); font-weight: 600;
}
body.dark #ubarTapBtn:hover {
  border-color: var(--ochre); color: var(--ochre);
  background: rgba(255,204,80,0.10);
}

/* ── Dark mode toggle pill ── */
body.dark .dark-toggle {
  border-color: rgba(200,178,140,0.18); color: var(--t3);
}
body.dark .dark-toggle:hover {
  border-color: var(--ochre); color: var(--ochre);
}
body.dark .dark-toggle .dt-icon { transform: rotate(20deg); }

/* ── dB Meter ── */
body.dark .spl-bar-fill { background: rgba(25,22,16,0.82); }

/* ── Metronome ── */
body.dark .mlbl { color: var(--t2); font-weight: 600; }
body.dark .acc-lbl { color: var(--t2); font-weight: 600; }
body.dark .acc-b {
  border-color: var(--border); color: var(--t2); background: var(--panel2);
}
body.dark .acc-b.on {
  background: rgba(240,184,64,0.20);
  border-color: var(--ochre); color: var(--ochre);
}
body.dark .snd-b {
  border-color: var(--border); color: var(--t2); background: var(--panel2);
}
body.dark .snd-b.on {
  background: rgba(78,216,112,0.15);
  border-color: var(--forest); color: var(--forest);
}

/* ── Drum panel ── */
body.dark .drum-genre-btn {
  background: var(--panel2); border-color: var(--border); color: var(--t2);
}
body.dark .drum-genre-btn:hover {
  border-color: var(--indigo); color: var(--indigo);
  background: rgba(138,176,248,0.12);
}
body.dark .drum-genre-btn.on {
  background: rgba(138,176,248,0.18);
  border-color: var(--indigo); color: var(--indigo); font-weight: 700;
}
body.dark .dstep { background: var(--panel2); border-color: var(--border); }
body.dark .dstep:hover { border-color: var(--t2); background: var(--panel3); }
body.dark .dstep.on { background: var(--indigo); border-color: var(--indigo); }
body.dark .dstep.on:hover { background: #b8caff; }
body.dark .dstep.beat-start { border-left-color: rgba(210,188,148,0.30); }
body.dark .dstep.playing { box-shadow: 0 0 0 2px var(--ochre); }
body.dark .loop-len-btn {
  border-color: var(--border); color: var(--t2); background: var(--panel2);
}
body.dark .loop-len-btn.on {
  border-color: var(--indigo); color: var(--indigo);
  background: rgba(138,176,248,0.16); font-weight: 700;
}
body.dark .cplx-dot { background: var(--panel2); border-color: var(--border); }
body.dark .cplx-dot.on { background: var(--indigo); border-color: var(--indigo); }
body.dark .drum-row-lbl { color: var(--t2); }
body.dark .drum-ctrl-lbl { color: var(--t2); font-weight: 600; }
body.dark .drum-ctrl-val { color: var(--t1); }
body.dark .drum-shuffle-btn {
  border-color: var(--border); color: var(--t2); background: var(--panel2);
}
body.dark .drum-shuffle-btn:hover {
  border-color: var(--t1); color: var(--t1);
}
body.dark .drum-play-btn {
  background: rgba(138,176,248,0.10);
  border-color: var(--indigo); color: var(--indigo);
}
body.dark .drum-play-btn:hover {
  background: rgba(138,176,248,0.20);
}
body.dark .drum-play-btn.playing {
  background: rgba(240,120,96,0.14);
  border-color: var(--rust); color: var(--rust);
}

/* ── Indian panels ── */
body.dark .ir-bols {
  background: var(--saffron-faint); color: var(--saffron);
}
body.dark .ir-beat {
  border-color: var(--border); color: var(--t2); background: var(--panel2);
}
body.dark .ir-beat.sam {
  border-color: var(--saffron); color: var(--saffron);
  background: rgba(245,145,58,0.14);
}
body.dark .ir-beat.khali {
  border-color: var(--border); color: var(--t3);
}
body.dark .ir-beat.lit {
  background: var(--saffron) !important;
  color: #141008 !important;
}
body.dark .ir-taal-btn {
  background: var(--panel2); border-color: var(--border); color: var(--t2);
}
body.dark .ir-taal-btn:hover {
  border-color: var(--saffron); color: var(--saffron);
  background: var(--saffron-faint);
}
body.dark .ir-taal-btn.on {
  background: var(--saffron-lt);
  border-color: var(--saffron); color: var(--saffron); font-weight: 700;
}
body.dark .ir-play-btn {
  background: var(--saffron-faint);
  border-color: var(--saffron); color: var(--saffron);
}
body.dark .ir-play-btn.playing {
  background: rgba(240,120,96,0.14);
  border-color: var(--rust); color: var(--rust);
}

/* ── Theory panel ── */
body.dark .clbl { color: var(--t2); font-weight: 600; }
body.dark .tun-sel {
  background: var(--panel2); color: var(--t1); border-color: var(--border);
}

/* ── Canvas in dark mode ── */
body.dark #oscCvs,
body.dark #specCvs {
  border-color: var(--border);
  background: #0c0b07;
}

/* ── Scrollbars ── */
body.dark ::-webkit-scrollbar { width: 5px; }
body.dark ::-webkit-scrollbar-track { background: var(--bg); }
body.dark ::-webkit-scrollbar-thumb {
  background: var(--panel3); border-radius: 3px;
}
body.dark ::-webkit-scrollbar-thumb:hover { background: var(--t4); }

/* ── Misc text ── */
body.dark .vol-row .mlbl { color: var(--t2); font-weight: 600; }
body.dark .clbl { color: var(--t3); }
body.dark .ir-lbl { color: var(--t3); }
body.dark .ir-val { color: var(--t2); }

body.dark .ubar-bpm-right { color: var(--t3); }




*, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }
html { font-size:13px; }

body {
  background: var(--bg);
  color: var(--t1);
  font-family: var(--ui);
  min-height: 100vh;
  overflow-x: hidden;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  font-variant-numeric: tabular-nums;
  /* subtle paper texture */
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='400'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='4' stitchTiles='stitch'/%3E%3CfeColorMatrix type='saturate' values='0'/%3E%3C/filter%3E%3Crect width='400' height='400' filter='url(%23n)' opacity='0.045'/%3E%3C/svg%3E");
}

/* ── HEADER ── */
header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 12px 28px;
  border-bottom: 1.5px solid var(--border);
  background: rgba(247,243,233,0.95);
  backdrop-filter: blur(6px);
  position: sticky; top: 0; z-index: 300;
}
.logo { font-family: var(--head); font-size: 22px; font-weight: 800; color: var(--t1); letter-spacing: -0.3px; line-height: 1.1; }
.logo em { color: var(--forest); font-style: italic; }
.logo-sub { font-size: 11px; color: var(--t3); letter-spacing: 2px; display: block; margin-top: 1px; font-family: var(--mono); text-transform: uppercase; font-weight: 400; }
.hbar { display: flex; gap: 16px; align-items: center; font-size: 11px; color: var(--t3); font-family: var(--mono); }
.dot { display: inline-block; width: 6px; height: 6px; border-radius: 50%; background: var(--t4); margin-right: 5px; animation: blink 2s infinite; }
.dot.on { background: var(--forest); animation: none; }
@keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.25} }

/* ── STOPWATCH ── */
.stopwatch-wrap { display: flex; flex-direction: column; align-items: center; gap: 3px; }
.stopwatch-display {
  font-family: var(--mono); font-size: 18px; font-weight: 600;
  color: var(--t1); letter-spacing: 2px; cursor: pointer;
  padding: 2px 6px; border-radius: 3px;
  transition: color 0.15s;
  min-width: 86px; text-align: center;
}
.stopwatch-display.running { color: var(--forest); }
.stopwatch-display.paused  { color: var(--ochre); }
.stopwatch-lbl { font-size: 9px; color: var(--t4); letter-spacing: 1.5px; font-family: var(--mono); text-align: center; }
.stopwatch-btns { display: flex; gap: 4px; }
.sw-btn {
  font-size: 9px; font-family: var(--mono); letter-spacing: 0.5px;
  padding: 2px 7px; border: 1px solid var(--border);
  border-radius: 2px; background: transparent;
  color: var(--t3); cursor: pointer; transition: all 0.12s;
}
.sw-btn:hover { border-color: var(--forest); color: var(--forest); }
.sw-btn.start { border-color: var(--forest); color: var(--forest); }
.sw-btn.stop  { border-color: var(--rust); color: var(--rust); }

/* ── MIC BUTTON in header ── */
.header-mic-btn {
  display: flex; align-items: center; gap: 6px;
  padding: 6px 14px;
  background: rgba(45,90,61,0.06); border: 1.5px solid var(--forest);
  color: var(--forest); font-family: var(--mono); font-size: 10px; font-weight: 600;
  letter-spacing: 1.5px; cursor: pointer; border-radius: 3px; transition: all 0.2s;
  white-space: nowrap;
}
.header-mic-btn:hover { background: rgba(45,90,61,0.1); }
.header-mic-btn.act {
  background: rgba(45,90,61,0.12); border-color: var(--forest2);
  animation: mpulse 2s infinite;
}
.header-mic-dot { width: 7px; height: 7px; border-radius: 50%; background: var(--t4); transition: background 0.2s; flex-shrink: 0; }
.header-mic-btn.act .header-mic-dot { background: var(--forest); }

/* ════════════════════════════════════════════
   UNIVERSAL CONTROLS BAR
════════════════════════════════════════════ */
#universalBar {
  display: flex; align-items: center; gap: 0;
  padding: 0 24px;
  background: transparent;
  /* NOT sticky — parent stickyShell handles that */
  flex-wrap: wrap;
}
.ubar-group {
  display: flex; align-items: center; gap: 10px;
  padding: 7px 20px 7px 0; margin-right: 20px;
  border-right: 1px solid var(--bord2);
}
.ubar-group:last-child { border-right: none; margin-right: 0; }
.ubar-lbl {
  font-family: var(--mono); font-size: 9px; letter-spacing: 2px;
  color: var(--t2); text-transform: uppercase; white-space: nowrap; font-weight: 700;
}
/* BPM */
.ubar-bpm-block { display: flex; align-items: center; gap: 8px; }
.ubar-arrows { display: flex; flex-direction: column; gap: 2px; }
.ubar-arr {
  width: 24px; height: 17px; border: 1.5px solid var(--border); border-radius: 2px;
  background: var(--panel3); color: var(--t1); font-size: 10px; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  font-family: var(--mono); transition: all 0.1s; line-height: 1; font-weight: 800;
}
.ubar-arr:hover { background: var(--t1); color: var(--panel); border-color: var(--t1); }
#ubarBpmNum {
  font-family: var(--head); font-size: 32px; font-weight: 800;
  color: var(--t1); line-height: 1; min-width: 54px; text-align: center;
  letter-spacing: -1px; cursor: pointer; user-select: none;
}
.ubar-bpm-right { display: flex; flex-direction: column; gap: 4px; }
.ubar-bpm-unit { font-family: var(--mono); font-size: 9px; color: var(--t2); letter-spacing: 2px; font-weight: 700; }
#ubarBpmSl { width: 100px; }
#ubarTapBtn, #ubarClapBtn {
  padding: 5px 10px; border: 1.5px solid var(--border); border-radius: 3px;
  background: var(--panel2); font-family: var(--mono); font-size: 10px; letter-spacing: 1px;
  color: var(--t1); cursor: pointer; white-space: nowrap; transition: all 0.15s; font-weight: 600;
}
#ubarTapBtn:active, #ubarClapBtn:active { background: var(--panel3); border-style: solid; }

/* Clap — active / listening state */
#ubarClapBtn.listening {
  border-style: solid;
  border-color: var(--rust);
  color: var(--rust);
  background: rgba(122,48,32,0.07);
  box-shadow: 0 0 0 0 rgba(122,48,32,0.4);
  animation: clap-pulse 1.6s ease-in-out infinite;
}
/* Glow burst when a clap is detected */
#ubarClapBtn.clap-hit {
  animation: clap-hit-flash 0.35s ease-out forwards !important;
}
@keyframes clap-pulse {
  0%,100% { box-shadow: 0 0 0 0 rgba(122,48,32,0.35); }
  50%      { box-shadow: 0 0 0 5px rgba(122,48,32,0.0); }
}
@keyframes clap-hit-flash {
  0%   { background: rgba(122,48,32,0.55); box-shadow: 0 0 0 6px rgba(122,48,32,0.3); color: #fff; border-color: var(--rust); }
  100% { background: rgba(122,48,32,0.07); box-shadow: 0 0 0 0 rgba(122,48,32,0); color: var(--rust); border-color: var(--rust); }
}
body.dark #ubarClapBtn.listening {
  border-color: var(--red-ink); color: var(--red-ink);
  background: rgba(224,112,96,0.10);
  animation: clap-pulse-dark 1.6s ease-in-out infinite;
}
body.dark #ubarClapBtn.clap-hit {
  animation: clap-hit-flash-dark 0.35s ease-out forwards !important;
}
@keyframes clap-pulse-dark {
  0%,100% { box-shadow: 0 0 0 0 rgba(224,112,96,0.35); }
  50%      { box-shadow: 0 0 0 5px rgba(224,112,96,0.0); }
}
@keyframes clap-hit-flash-dark {
  0%   { background: rgba(224,112,96,0.45); box-shadow: 0 0 0 7px rgba(224,112,96,0.25); color: #fff; }
  100% { background: rgba(224,112,96,0.10); box-shadow: 0 0 0 0 rgba(224,112,96,0); color: var(--red-ink); }
}
/* Key buttons */
.ubar-keys { display: flex; flex-wrap: wrap; gap: 3px; }
.ubar-key {
  padding: 5px 9px; border: 1.5px solid var(--border); border-radius: 3px;
  background: var(--panel2); font-family: var(--mono); font-size: 11px;
  color: var(--t1); cursor: pointer; transition: all 0.12s; min-width: 36px; text-align: center; font-weight: 600;
}
.ubar-key:hover { border-color: var(--forest); color: var(--forest); background: var(--panel3); }
.ubar-key.on { background: var(--forest); border-color: var(--forest); color: #fff; font-weight: 800; }

/* ── LAYOUT — bounded window manager ── */
main { padding: 0; min-height: calc(100vh - 140px); }
#panelGrid {
  position: relative;
  width: 100%;
  min-height: calc(100vh - var(--header-h,140px));
  overflow: hidden;
  background: transparent;
}
/* Desktop: panels are absolute-positioned windows */
@media(min-width: 769px) {
  .panel, .spl-panel {
    position: absolute !important;
    min-width: 280px;
    min-height: 200px;
    box-shadow: 0 4px 20px rgba(55,40,20,0.15), inset 0 1px 0 rgba(255,252,245,0.8);
  }
}
/* Mobile: panels stack vertically */
@media(max-width: 768px) {
  #panelGrid {
    display: flex;
    flex-direction: column;
    gap: 10px;
    padding: 10px;
    min-height: unset;
    overflow: visible;
  }
  .panel, .spl-panel {
    position: static !important;
    width: 100% !important;
    height: auto !important;
    aspect-ratio: unset;
  }
}
.lc, .rc { display: contents; }

/* ── PANEL ── */
.panel {
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: 6px;
  overflow: hidden;
  position: relative;
  min-width: 0;
  box-shadow: 0 1px 3px rgba(55,40,20,0.08), inset 0 1px 0 rgba(255,252,245,0.8);
  display: flex;
  flex-direction: column;
  width: 360px;
  height: 420px;
}
/* Panels start invisible on desktop until window manager places them */
@media(min-width: 769px) {
  .panel:not([data-wm-setup]), .spl-panel:not([data-wm-setup]) {
    visibility: hidden;
  }
  .panel[data-wm-setup], .spl-panel[data-wm-setup] {
    visibility: visible;
  }
}
/* .ph and .ctrl are fixed; panel body clips at boundary - no scroll */
.panel .ph   { flex-shrink: 0; }
.panel .ctrl { flex-shrink: 0; }
.panel-body {
  flex: 1;
  overflow: hidden;
  min-height: 0;
}
/* Allow scroll only when manually resized larger */
.panel[style*="height"] .panel-body { overflow-y: auto; }
/* Resize handle — dedicated draggable element */
.resize-handle {
  position: absolute; bottom: 0; right: 0;
  width: 22px; height: 22px;
  cursor: se-resize;
  z-index: 10;
  border-radius: 0 0 5px 0;
  /* Bold diagonal stripes — always visible */
  background:
    linear-gradient(135deg,
      transparent 28%, var(--t3) 28%, var(--t3) 38%, transparent 38%,
      transparent 52%, var(--t3) 52%, var(--t3) 62%, transparent 62%,
      transparent 76%, var(--t3) 76%, var(--t3) 86%, transparent 86%
    );
  opacity: 0.75;
  transition: opacity 0.15s, transform 0.12s;
}
.panel:hover .resize-handle,
.spl-panel:hover .resize-handle { opacity: 1; transform: scale(1.08); }
.panel.resizing .resize-handle { opacity: 1; }
body.dark .resize-handle { opacity: 0.85; }
body.dark .panel:hover .resize-handle,
body.dark .spl-panel:hover .resize-handle { opacity: 1; }

/* When manually resized, allow panel to scroll */
.panel[style*="height"],
.spl-panel[style*="height"] { overflow: auto; }
.panel.resizing, .spl-panel.resizing { user-select: none; }

/* ── WINDOW MANAGER ── */
/* Title bar is the drag handle */
.ph { cursor: grab; user-select: none; }
.ph:active { cursor: grabbing; }
.panel.dragging, .spl-panel.dragging { 
  opacity: 0.92; 
  box-shadow: 0 12px 40px rgba(55,40,20,0.25);
  z-index: 1000;
  transition: none;
}
/* Compact / Minimize button */
.win-min-btn {
  display: flex; align-items: center; gap: 3px;
  padding: 3px 9px; border: 1.5px solid var(--border);
  border-radius: 3px; background: var(--panel3);
  font-family: var(--mono); font-size: 11px; letter-spacing: 1px;
  color: var(--t1); cursor: pointer; transition: all 0.12s;
  margin-left: auto; flex-shrink: 0; font-weight: 700;
}
.win-min-btn:hover { color: var(--panel); border-color: var(--t1); background: var(--t1); }
/* Compact state */
.panel.win-compact, .spl-panel.win-compact { height: 200px !important; overflow: hidden; }
/* ── Metronome compact: ONLY play btn + accent row + subdivision selector ── */
#metroPanel.win-compact .mrow-swing,
#metroPanel.win-compact .mrow-beat,
#metroPanel.win-compact .beat-vis,
#metroPanel.win-compact .acc-lbl,
#metroPanel.win-compact .snd-grid,
#metroPanel.win-compact .vol-row,
#metroPanel.win-compact .metro-osc-wrap { display: none !important; }
/* Keep subdivision row + accent row visible */
#metroPanel.win-compact .mrow-sub { display: flex !important; margin-bottom: 5px; }
#metroPanel.win-compact .acc-row { display: flex !important; margin-bottom: 6px; }
/* Tighten compact spacing */
#metroPanel.win-compact .mbody { padding: 8px 10px; }
#metroPanel.win-compact .play-b { margin-top: 4px; }
#metroPanel.win-compact { height: 152px !important; }
/* Tuner compact: show seismo + needle only */
#tunerPanel.win-compact .tun-wrap { display: none !important; }
/* General compact: hide secondary controls */
.panel.win-compact .panel-body { overflow: hidden; }
/* No scroll overlay indicator */
.panel-overflow-hint {
  position: absolute; bottom: 6px; left: 50%; transform: translateX(-50%);
  font-size: 11px; color: var(--t4); font-family: var(--mono); letter-spacing: 1px;
  pointer-events: none; opacity: 0; transition: opacity 0.2s;
}
.panel:hover .panel-overflow-hint { opacity: 1; }
/* Minimized bar state */
.panel.win-mini, .spl-panel.win-mini { 
  height: 38px !important; 
  overflow: hidden;
}
.panel.win-mini .panel-body,
.spl-panel.win-mini .spl-body { display: none; }
.panel.win-mini .ctrl { display: none; }
/* Maximize state */
.panel.win-max, .spl-panel.win-max {
  width: 700px !important;
  height: 520px !important;
}
/* Resize handle stays */
.panel::before {
  content: ''; position: absolute; inset: 0; pointer-events: none;
  background: linear-gradient(150deg, rgba(255,253,245,0.45) 0%, transparent 55%);
}
.ph {
  display: flex; align-items: center; justify-content: space-between;
  padding: 9px 16px;
  border-bottom: 1px solid var(--bord2);
  background: rgba(238,232,218,0.35);
}
.ph-t { font-family: var(--mono); font-size: 10px; font-weight: 800; letter-spacing: 2px; color: var(--t1); text-transform: uppercase; }
.ph-r { font-size: 10px; color: var(--t2); font-family: var(--mono); font-weight: 700; }

/* ── CONTROL ROW ── */
.ctrl { display: flex; align-items: center; gap: 10px; padding: 8px 16px; border-bottom: 1px solid var(--bord2); flex-wrap: wrap; }
.clbl { font-size: 11px; color: var(--t2); font-family: var(--mono); white-space: nowrap; font-weight: 600; }

/* ── BUTTON GROUP — pencil-sketched tabs ── */
.bg { display: flex; }
.b {
  background: transparent;
  border: 1.5px solid var(--border); border-right: none;
  color: var(--t1); padding: 4px 11px; cursor: pointer;
  font-family: var(--mono); font-size: 11px;
  transition: all 0.12s; white-space: nowrap; font-weight: 600;
}
.b:first-child { border-radius: 3px 0 0 3px; }
.b:last-child  { border-right: 1.5px solid var(--border); border-radius: 0 3px 3px 0; }
.b:hover { background: rgba(40,25,8,0.10); color: var(--t1); border-color: var(--t1); }
.b.on   { background: rgba(40,25,8,0.18); border-color: var(--t1); color: var(--t1); font-weight: 800; }

/* ── OSCILLOSCOPE canvas ── */
.osc-wrap { padding: 10px 14px 4px; }
#oscCvs {
  display: block; width: 100%; height: 220px;
  border-radius: 3px;
  background: #f9f6ee;
  border: 1px solid var(--border);
}
.osc-xrow {
  display: flex; justify-content: space-between;
  padding: 3px 1px 0;
  font-size: 10px; color: var(--t4); font-family: var(--mono);
}

/* ── SPECTRUM ── */
.spec-wrap { padding: 4px 14px 12px; }
.spec-hdr { display: flex; justify-content: space-between; font-size: 10px; color: var(--t3); font-family: var(--mono); margin-bottom: 5px; }
#specCvs { display: block; width: 100%; height: 90px; background: #f9f6ee; border: 1px solid var(--border); border-radius: 3px; }
.spec-flbl { display: flex; justify-content: space-between; padding: 3px 1px 0; font-size: 10px; color: var(--t4); font-family: var(--mono); }

/* ── PITCH STATS ── */
.pstats { display: grid; grid-template-columns: repeat(3,1fr); gap: 8px; padding: 10px 14px; }
.ps {
  background: var(--panel2);
  border: 1px solid var(--bord2);
  border-radius: 4px; padding: 11px 8px; text-align: center;
  box-shadow: inset 0 1px 2px rgba(55,40,20,0.04);
}
.psl { font-size: 10px; color: var(--t2); letter-spacing: 1px; margin-bottom: 5px; font-family: var(--mono); font-weight: 700; }
.psv { font-family: var(--mono); font-size: 22px; font-weight: 700; color: var(--indigo); }
.psu { font-size: 10px; color: var(--t4); margin-top: 2px; }

/* ── THEORY ── */
.theory-ctrl { display: flex; gap: 7px; padding: 10px 14px; flex-wrap: wrap; align-items: center; border-bottom: 1px solid var(--bord2); }
.tsep { width: 1px; height: 22px; background: var(--bord2); margin: 0 2px; }

#chordsV, #scalesV, #modesV { padding: 8px 12px; }
#scalesV, #modesV { display: none; }

/* ── Diatonic grid ── */
.d-bar { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; flex-wrap: wrap; gap: 8px; }
.d-hdr { font-size: 12px; color: var(--t2); line-height: 1.6; }
.d-hdr em { color: var(--forest); font-style: italic; font-weight: 700; }

.dgrid { display: grid; grid-template-columns: repeat(7,1fr); gap: 5px; }
.dc {
  background: var(--panel2); border: 1px solid var(--bord2); border-radius: 4px;
  padding: 9px 4px; cursor: pointer; transition: all 0.14s; text-align: center;
  position: relative; overflow: hidden;
}
.dc:hover  { border-color: var(--t3); }
.dc.isr   { border-color: var(--forest); background: rgba(45,90,61,0.06); }
.dc .deg  { font-size: 9px; color: var(--t3); margin-bottom: 3px; font-family: var(--mono); font-weight: 700; }
.dc .cn   { font-family: var(--head); font-size: 13px; font-weight: 800; color: var(--forest); }
.dc .cq   { font-size: 9px; color: var(--t2); margin-top: 2px; font-family: var(--mono); font-weight: 600; }
.dc .cno  { font-size: 9px; color: var(--t3); margin-top: 4px; line-height: 1.5; font-family: var(--mono); font-weight: 600; }
/* Hover info bubble — floats above card, theme-safe */
.dc .hov  {
  position: absolute; left: 50%; bottom: calc(100% + 6px); transform: translateX(-50%);
  background: var(--panel); border: 1.5px solid var(--forest); border-radius: 5px;
  padding: 6px 9px; min-width: 110px; max-width: 180px;
  display: flex; flex-direction: column; align-items: flex-start; gap: 3px;
  opacity: 0; transition: opacity 0.14s; pointer-events: none;
  z-index: 100; white-space: nowrap;
  box-shadow: 0 4px 16px rgba(0,0,0,0.18);
}
.dc:hover .hov { opacity: 1; }
.hov .hr { font-family: var(--head); font-size: 10px; color: var(--forest); font-weight: 800; letter-spacing: 0.5px; }
.hov .hf { font-size: 10px; color: var(--t2); font-family: var(--mono); }
.hov .hm { font-size: 9px; color: var(--t3); text-align: left; line-height: 1.5; white-space: normal; max-width: 160px; }
/* Drag indicator */
.dc[draggable="true"]:hover { cursor: grab; }
.dc[draggable="true"]:active { cursor: grabbing; }
.dc.drag-preview { opacity: 0.5; transform: scale(0.95); }
/* Drop target highlight */
.gen-player-chords.drag-over { border: 2px dashed var(--forest) !important; background: rgba(45,90,61,0.06); }
.dc.dlit  { border-color: var(--indigo) !important; background: rgba(61,74,138,0.06) !important; }
.dc.dlit .cn { color: var(--indigo) !important; }

/* ── Mini chord grid (scales/modes expand) ── */
.mc-grid { display: grid; grid-template-columns: repeat(7,1fr); gap: 4px; margin-top: 8px; }
.mcd {
  background: rgba(55,40,20,0.03); border: 1px solid var(--bord2);
  border-radius: 3px; padding: 6px 3px; text-align: center; cursor: grab; transition: all 0.12s;
}
.mcd:hover { border-color: var(--indigo); }
.mcd .mdeg  { font-size: 9px; color: var(--t4); font-family: var(--mono); margin-bottom: 2px; }
.mcd .mcn   { font-family: var(--head); font-size: 11px; font-weight: 800; color: var(--indigo); }
.mcd .mcno  { font-size: 8px; color: var(--t4); margin-top: 2px; font-family: var(--mono); }

/* ── Scales ── */
.sblk { margin-bottom: 6px; }
.sblk-hdr {
  display: flex; align-items: center; justify-content: space-between; gap: 10px;
  cursor: pointer; padding: 9px 13px;
  border: 1px solid var(--bord2); border-radius: 4px;
  background: var(--panel2); transition: all 0.14s;
}
.sblk-hdr:hover { border-color: var(--t3); }
.sblk-hdr.open  { border-color: var(--forest); background: rgba(45,90,61,0.04); border-radius: 4px 4px 0 0; }
.sblk-n { font-family: var(--head); font-size: 12px; font-weight: 700; color: var(--t2); }
.sblk-hdr.open .sblk-n { color: var(--forest); }
.sblk-v { font-size: 10px; color: var(--t4); font-family: var(--mono); font-style: italic; }
.sblk-body {
  display: none; padding: 13px;
  border: 1px solid var(--forest); border-top: none;
  border-radius: 0 0 4px 4px; background: rgba(45,90,61,0.025);
}
.sblk.open .sblk-body { display: block; }
.s-notes { display: flex; gap: 5px; flex-wrap: wrap; margin-bottom: 8px; }
.sn { padding: 4px 9px; border: 1px solid var(--bord2); border-radius: 3px; font-size: 12px; color: var(--t2); font-family: var(--mono); transition: all 0.12s; }
.sn.root { border-color: var(--forest); color: var(--forest); background: rgba(45,90,61,0.06); font-weight: 600; }
.sn.det  { border-color: var(--indigo); color: var(--indigo); }
.s-desc  { font-size: 11px; color: var(--t3); line-height: 1.75; margin-bottom: 10px; font-style: italic; }
.s-desc em { color: var(--t2); font-style: normal; font-weight: 600; }
.sec-lbl { font-size: 10px; color: var(--t3); letter-spacing: 1px; margin-bottom: 6px; font-family: var(--mono); }
.s-steps { display: flex; gap: 4px; margin-top: 6px; }
.sstep { padding: 3px 7px; border: 1px solid var(--bord2); border-radius: 3px; font-size: 10px; color: var(--t3); font-family: var(--mono); background: rgba(55,40,20,0.03); }

/* ── Modes ── */
.m-intro { font-size: 12px; color: var(--t3); line-height: 1.75; margin-bottom: 12px; font-style: italic; }
.m-intro em { color: var(--forest); font-style: normal; font-weight: 700; }
.mcard {
  background: var(--panel2); border: 1px solid var(--bord2); border-radius: 4px;
  margin-bottom: 5px; cursor: pointer; transition: all 0.14s; overflow: hidden;
}
.mcard:hover { border-color: var(--t3); }
.mcard.exp   { border-color: var(--indigo); background: rgba(61,74,138,0.03); }
.m-row { display: grid; grid-template-columns: 120px 1fr 90px; align-items: center; gap: 8px; padding: 9px 14px; }
.mname  { font-family: var(--head); font-size: 12px; font-weight: 800; color: var(--forest); }
.mgreek { font-size: 10px; color: var(--t4); margin-top: 2px; font-family: var(--mono); font-style: italic; }
.mnotes { display: flex; gap: 3px; flex-wrap: wrap; }
.mnt { padding: 2px 6px; border: 1px solid var(--bord2); border-radius: 3px; font-size: 11px; color: var(--t2); font-family: var(--mono); transition: all 0.12s; }
.mnt.mr { border-color: var(--forest); color: var(--forest); background: rgba(45,90,61,0.06); font-weight: 600; }
.mnt.mc { border-color: var(--ochre); color: var(--ochre); background: rgba(122,85,21,0.06); }
.mnt.det { border-color: var(--indigo); color: var(--indigo); background: rgba(61,74,138,0.08); font-weight: 600; }
.mvib { font-size: 10px; color: var(--t4); text-align: right; line-height: 1.6; font-style: italic; }
.m-det { display: none; padding: 0 14px 14px; }
.mcard.exp .m-det { display: block; }
.m-det-t {
  font-size: 11px; color: var(--t2); line-height: 1.8;
  padding-top: 10px; margin-bottom: 8px;
  border-top: 1px solid var(--bord2);
}
.m-det-t em { color: var(--indigo); font-style: italic; }
.m-steps { display: flex; gap: 4px; margin-top: 6px; flex-wrap: wrap; }
.mstep { padding: 3px 7px; border: 1px solid var(--bord2); border-radius: 3px; font-size: 10px; color: var(--t3); font-family: var(--mono); background: rgba(55,40,20,0.03); }

/* shared 4-note toggle */
.fn-btn {
  background: transparent; border: 1px solid var(--border);
  color: var(--t3); font-family: var(--mono); font-size: 10px; letter-spacing: 1px;
  padding: 4px 12px; cursor: pointer; border-radius: 3px; transition: all 0.12s; white-space: nowrap;
}
.fn-btn:hover { background: rgba(55,40,20,0.04); }
.fn-btn.on { background: rgba(45,90,61,0.08); border-color: var(--forest); color: var(--forest); font-weight: 600; }

/* ── TUNER ── */
.mic-btn {
  display: block; width: calc(100% - 28px); margin: 13px 14px 0; padding: 11px;
  background: rgba(45,90,61,0.06); border: 1.5px solid var(--forest);
  color: var(--forest); font-family: var(--mono); font-size: 11px; font-weight: 600;
  letter-spacing: 2px; cursor: pointer; text-align: center; border-radius: 3px; transition: all 0.2s;
}
.mic-btn:hover { background: rgba(45,90,61,0.1); }
.mic-btn.act   { background: rgba(45,90,61,0.1); border-color: var(--forest2); animation: mpulse 2s infinite; }
@keyframes mpulse { 0%,100%{ box-shadow: 0 0 0 rgba(45,90,61,0) } 50%{ box-shadow: 0 0 8px rgba(45,90,61,0.2) } }

.tdisp { padding: 16px 14px 0; text-align: center; }
.notedisp { font-family: var(--head); font-size: 48px; font-weight: 800; line-height: 1; color: var(--t1); min-height: 48px; letter-spacing: -1px; }
.octdisp  { font-size: 11px; color: var(--t3); margin-top: 2px; letter-spacing: 2px; font-family: var(--mono); }
.fdisp    { font-size: 11px; color: var(--indigo); margin-top: 3px; font-family: var(--mono); }

/* ── Seismograph tuner ── */
.seismo-wrap {
  position: relative; margin: 6px 12px 4px;
  border-radius: 4px; overflow: hidden;
  border: 1px solid var(--border);
}
#seismoCvs {
  display: block; width: 100%; height: 62px;
  background: var(--panel2);
}
body.dark #seismoCvs { background: #0f0d09; }
.seismo-badge {
  position: absolute; top: 8px; left: 10px;
  display: flex; align-items: baseline; gap: 6px;
  pointer-events: none;
}
.seismo-note {
  font-family: var(--head); font-size: 28px; font-weight: 800;
  color: var(--t1); line-height: 1; letter-spacing: -1px;
  text-shadow: 0 1px 4px rgba(0,0,0,0.3);
}
body.dark .seismo-note { color: var(--t1); }
.seismo-oct {
  font-family: var(--mono); font-size: 11px; color: var(--t2);
  letter-spacing: 1px; font-weight: 700;
}
.seismo-freq {
  position: absolute; bottom: 7px; right: 10px;
  font-family: var(--mono); font-size: 10px; color: var(--t2);
  pointer-events: none; letter-spacing: 0.5px; font-weight: 600;
}

.tmeter { margin: 8px 12px 0; }
.mbar {
  height: 36px; background: var(--panel2);
  border: 1px solid var(--border); border-radius: 3px; position: relative; overflow: hidden;
  /* faint ruled lines inside meter */
  background-image: repeating-linear-gradient(90deg, transparent, transparent 24.9%, rgba(55,40,20,0.05) 25%);
}
.mbar-c { position: absolute; left: 50%; top: 0; bottom: 0; width: 1.5px; background: rgba(55,40,20,0.25); transform: translateX(-50%); }
.needle { position: absolute; top: 4px; bottom: 4px; width: 2px; background: var(--t1); border-radius: 1px; left: 50%; transform: translateX(-50%); transition: left 0.08s ease-out; }
.needle.flat  { background: var(--rust); }
.needle.sharp { background: var(--ochre); }
.needle.intune { background: var(--forest); animation: iglow 0.35s ease-in-out 4; }
@keyframes iglow { 0%,100%{opacity:1} 50%{opacity:0.5} }
.mlabels { display: flex; justify-content: space-between; font-size: 10px; color: var(--t4); padding: 3px 2px 0; font-family: var(--mono); }
.cdisp   { text-align: center; font-size: 12px; color: var(--t2); margin-top: 4px; font-family: var(--mono); }
.itlbl   { text-align: center; font-family: var(--mono); font-size: 10px; letter-spacing: 3px; padding: 7px; color: transparent; transition: all 0.3s; }
.itlbl.on { color: var(--forest); }

.sref   { margin: 10px 14px 14px; border-top: 1px solid var(--bord2); padding-top: 10px; }
.sref-t { font-size: 10px; color: var(--t3); letter-spacing: 1px; margin-bottom: 7px; font-family: var(--mono); }
.sgrid  { display: grid; grid-template-columns: repeat(6,1fr); gap: 4px; }
.strbtn { background: var(--panel2); border: 1px solid var(--bord2); border-radius: 3px; color: var(--t3); padding: 7px 2px; text-align: center; cursor: pointer; font-family: var(--mono); font-size: 14px; transition: all 0.14s; }
.strbtn span { display: block; font-size: 10px; margin-top: 1px; }
.strbtn:hover, .strbtn.on { background: rgba(45,90,61,0.06); border-color: var(--forest); color: var(--forest); }

/* ── METRONOME ── */
.mbody {
  padding: 8px 12px 10px;
  display: flex; flex-direction: column; gap: 0;
  overflow: hidden;
  height: 100%;
  box-sizing: border-box;
}

.bpm-sec { display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 10px; }
.bpm-b { width: 34px; height: 34px; background: var(--panel2); border: 1px solid var(--border); color: var(--t2); font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; border-radius: 3px; transition: all 0.1s; font-family: var(--mono); }
.bpm-b:hover { background: rgba(55,40,20,0.06); color: var(--t1); }
.bpm-d { text-align: center; }
.bpm-n { font-family: var(--head); font-size: 52px; font-weight: 800; color: var(--t1); line-height: 1; cursor: pointer; user-select: none; letter-spacing: -2px; }
.bpm-lbl { font-size: 10px; color: var(--t3); letter-spacing: 3px; margin-top: 1px; font-family: var(--mono); font-weight: 600; }

input[type=range].sl { width: 100%; -webkit-appearance: none; appearance: none; height: 3px; background: rgba(55,40,20,0.15); outline: none; cursor: pointer; border-radius: 2px; }
input[type=range].sl::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 14px; height: 14px; border-radius: 50%; background: var(--t2); cursor: pointer; border: 1.5px solid var(--t3); }
.bpm-rl { display: flex; justify-content: space-between; font-size: 9px; color: var(--t3); margin-top: 3px; font-family: var(--mono); font-weight: 600; }

.tap-b { display: block; width: 100%; padding: 10px; background: var(--panel2); border: 1.5px dashed var(--border); color: var(--t2); font-family: var(--mono); font-size: 12px; letter-spacing: 2px; cursor: pointer; text-align: center; margin-bottom: 12px; transition: all 0.1s; border-radius: 3px; }
.tap-b:active { background: rgba(55,40,20,0.07); border-style: solid; }

.mrow  { display: flex; align-items: center; gap: 8px; margin-bottom: 5px; flex-wrap: wrap; }
.mlbl  { font-size: 11px; color: var(--t2); min-width: 60px; font-family: var(--mono); font-weight: 600; }

.beat-vis { display: flex; gap: 3px; margin-bottom: 5px; flex-wrap: wrap; min-height: 24px; }
.bd { flex: 1; min-width: 22px; height: 32px; border: 1.5px solid var(--border); border-radius: 3px; background: var(--panel2); display: flex; align-items: center; justify-content: center; font-size: 10px; color: var(--t2); transition: all 0.04s; font-family: var(--mono); font-weight: 700; }
.bd.acc { border-color: var(--ochre); color: var(--ochre); background: rgba(92,60,8,0.08); }
.bd.lit { background: var(--t1) !important; border-color: var(--t1) !important; color: var(--panel) !important; font-weight: 700; }
.bd.lit.acclit { background: var(--forest) !important; border-color: var(--forest) !important; }

.acc-lbl { font-size: 10px; color: var(--t2); letter-spacing: 1px; margin-bottom: 4px; font-family: var(--mono); font-weight: 600; }
.acc-row { display: flex; gap: 4px; flex-wrap: wrap; margin-bottom: 7px; }
.acc-b { width: 28px; height: 28px; border: 1.5px solid var(--border); border-radius: 3px; background: var(--panel2); color: var(--t2); font-size: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.1s; font-family: var(--mono); font-weight: 600; }
.acc-b:hover { border-color: var(--ochre); color: var(--ochre); }
.acc-b.on { background: rgba(122,85,21,0.07); border-color: var(--ochre); color: var(--ochre); }

.snd-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; margin-bottom: 8px; }
.snd-b { padding: 8px; background: var(--panel2); border: 1.5px solid var(--border); border-radius: 3px; color: var(--t2); font-family: var(--mono); font-size: 10px; cursor: pointer; text-align: center; transition: all 0.1s; font-weight: 600; }
.snd-b:hover { background: var(--panel3); color: var(--t1); border-color: var(--t2); }
.snd-b.on { background: rgba(45,90,61,0.12); border-color: var(--forest); color: var(--forest); font-weight: 700; }

.sub-dots { display: flex; gap: 3px; }
.subdot { width: 8px; height: 8px; border-radius: 50%; background: var(--panel2); border: 1px solid var(--border); transition: all 0.05s; }
.subdot.lit { background: var(--t2); border-color: var(--t1); }

.vol-row { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
.play-b { display: block; width: 100%; padding: 10px; background: var(--panel2); border: 2px solid var(--border); color: var(--t1); font-family: var(--mono); font-size: 12px; font-weight: 800; letter-spacing: 3px; cursor: pointer; text-align: center; border-radius: 3px; transition: all 0.15s; margin-top: auto; }
.play-b:hover { background: var(--panel3); border-color: var(--t1); }
.play-b.playing { background: rgba(92,26,8,0.08); border-color: var(--rust); color: var(--rust); animation: pblink 1s infinite; }
@keyframes pblink { 0%,100%{opacity:1} 50%{opacity:0.55} }

/* responsive handled by panelGrid auto-fill */

/* ═══════════════════════════════════════════
   INDIAN MODE — SAFFRON ACCENT THEME
═══════════════════════════════════════════ */
:root {
  --saffron:     #c8520a;
  --saffron-dim: #a04008;
  --saffron-lt:  rgba(200,82,10,0.12);
  --saffron-faint: rgba(200,82,10,0.07);
  --turmeric:    #d4920a;
  --turmeric-lt: rgba(212,146,10,0.13);
  --lotus:       #b03060;
  --lotus-lt:    rgba(176,48,96,0.1);
  --peacock:     #2a6b5a;
  --peacock-lt:  rgba(42,107,90,0.1);
}

/* Indian mode — NO color theme changes */

/* INDIAN BANNER */
#indianBanner {
  display: none;
  background: linear-gradient(135deg, rgba(200,82,10,0.12) 0%, rgba(212,146,10,0.08) 100%);
  border-bottom: 1px solid rgba(200,82,10,0.25);
  padding: 8px 16px;
  font-family: var(--hand); font-size: 13px; color: var(--saffron);
  display: none; align-items: center; gap: 10px;
}
#indianBanner.show { display: flex; }
#indianBanner span { font-size: 18px; }

/* INDIAN MASTER TOGGLE BUTTON */
.indian-master-btn {
  padding: 6px 16px;
  background: transparent;
  border: 1.5px solid var(--pencil-mid);
  border-radius: 2px;
  font-family: var(--hand); font-size: 14px;
  color: var(--pencil-2b); cursor: pointer;
  transition: all 0.18s; white-space: nowrap;
  letter-spacing: 0.5px;
}
.indian-master-btn:hover { border-color: var(--saffron); color: var(--saffron); background: var(--saffron-faint); }
.indian-master-btn.on {
  background: var(--saffron-lt);
  border-color: var(--saffron);
  color: var(--saffron);
  font-weight: 600;
}


/* INDIAN THEORY VIEW */
#indianV { padding: 12px 14px; display: none; }
#indianV.show { display: block; }

.thaat-intro {
  font-family: var(--hand); font-size: 13px; color: var(--pencil-2b);
  line-height: 1.75; margin-bottom: 12px; padding: 10px 12px;
  border-left: 3px solid var(--saffron); background: var(--saffron-faint);
  border-radius: 0 2px 2px 0;
}
.thaat-intro em { color: var(--saffron); font-style: italic; font-weight: 600; }

.thaat-blk { margin-bottom: 8px; }
.thaat-hdr {
  display: flex; align-items: center; justify-content: space-between; gap: 10px;
  cursor: pointer; padding: 10px 12px;
  border: 1px solid var(--pencil-soft); border-radius: 2px;
  background: var(--paper); transition: all 0.15s;
}
.thaat-hdr:hover { border-color: var(--saffron); background: var(--saffron-faint); }
.thaat-hdr.open { border-color: var(--saffron); border-width: 1.5px; background: var(--saffron-faint); border-radius: 2px 2px 0 0; }
.thaat-name { font-family: var(--hand); font-size: 15px; font-weight: 700; color: var(--pencil-hb); }
.thaat-hdr.open .thaat-name { color: var(--saffron); }
.thaat-vibe { font-size: 12px; color: var(--pencil-hb2); font-family: var(--hand); font-style: italic; }
.thaat-swaras { font-family: var(--mono); font-size: 11px; color: var(--saffron-dim); }
.thaat-body {
  display: none; padding: 12px;
  border: 1.5px solid var(--saffron); border-top: none;
  border-radius: 0 0 2px 2px; background: rgba(200,82,10,0.03);
}
.thaat-blk.open .thaat-body { display: block; }

.thaat-notes-row { display: flex; gap: 5px; flex-wrap: wrap; margin-bottom: 10px; }
.tn {
  padding: 4px 9px; border: 1px solid var(--pencil-soft); border-radius: 2px;
  font-size: 12px; font-family: var(--hand);
  color: var(--pencil-hb); background: var(--paper);
}
.tn.sa  { border-color: var(--saffron); color: var(--saffron); font-weight: 700; background: var(--saffron-faint); }
.tn.vkr { border-color: var(--turmeric); color: var(--turmeric); }
.tn.pkr { border-color: var(--lotus); color: var(--lotus); }
.tn.det { border-color: var(--indigo); color: var(--indigo); background: rgba(61,74,138,0.08); font-weight: 600; }

.thaat-desc { font-family: var(--hand); font-size: 13px; color: var(--pencil-2b); line-height: 1.75; margin-bottom: 10px; }
.thaat-desc em { color: var(--saffron); font-style: italic; }

.raga-sec-lbl { font-family: var(--mono); font-size: 10px; letter-spacing: 1.5px; color: var(--pencil-hb2); margin-bottom: 6px; text-transform: uppercase; }
.raga-grid { display: grid; grid-template-columns: repeat(2,1fr); gap: 5px; margin-bottom: 10px; }
.raga-card {
  background: var(--paper2); border: 1px solid var(--pencil-faint); border-radius: 2px;
  padding: 8px 10px; transition: all 0.13s;
}
.raga-card:hover { border-color: var(--saffron); background: var(--saffron-faint); }
.raga-name { font-family: var(--hand); font-size: 13px; font-weight: 600; color: var(--saffron-dim); }
.raga-mood { font-size: 11px; color: var(--pencil-hb2); font-style: italic; font-family: var(--hand); }
.raga-time { font-family: var(--mono); font-size: 9px; color: var(--pencil-h); margin-top: 2px; }

.swara-map { margin-top: 8px; padding: 8px 10px; background: var(--paper2); border: 1px dashed var(--pencil-soft); border-radius: 2px; }
.swara-map-t { font-family: var(--mono); font-size: 10px; color: var(--pencil-hb2); letter-spacing: 1px; margin-bottom: 5px; }
.swara-row { display: flex; gap: 4px; flex-wrap: wrap; }
.sw {
  padding: 4px 8px; border: 1px solid var(--pencil-faint); border-radius: 2px;
  font-size: 11px; font-family: var(--mono); color: var(--pencil-2b);
  display: flex; flex-direction: column; align-items: center; gap: 1px;
}
.sw .syl { font-size: 9px; color: var(--saffron); font-weight: 600; }
.sw .wn  { font-size: 11px; }

/* TAAL SECTION in metronome */
.taal-section {
  display: none; padding-top: 10px; border-top: 1px dashed rgba(200,82,10,0.3);
  margin-top: 8px;
}
.taal-section.show { display: block; }
.taal-lbl { font-family: var(--hand); font-size: 12px; color: var(--saffron-dim); margin-bottom: 6px; }
.taal-grid { display: grid; grid-template-columns: repeat(2,1fr); gap: 4px; margin-bottom: 8px; }
.taal-btn {
  padding: 7px 6px; background: var(--paper); border: 1px solid var(--pencil-soft);
  border-radius: 2px; font-family: var(--hand); font-size: 12px; color: var(--pencil-2b);
  cursor: pointer; text-align: left; transition: all 0.13s; line-height: 1.3;
}
.taal-btn:hover { border-color: var(--saffron); color: var(--saffron); background: var(--saffron-faint); }
.taal-btn.on { background: var(--saffron-lt); border-color: var(--saffron); color: var(--saffron); font-weight: 600; }
.taal-btn small { display: block; font-size: 10px; color: var(--pencil-hb2); font-style: italic; }
.bols-row { font-family: var(--mono); font-size: 10px; color: var(--saffron-dim); padding: 6px 8px; background: var(--saffron-faint); border-radius: 2px; letter-spacing: 0.5px; margin-bottom: 8px; line-height: 1.6; }
.vibhag-vis { display: flex; gap: 3px; flex-wrap: wrap; margin-bottom: 8px; }
.vb {
  height: 30px; border: 1px solid var(--pencil-soft); border-radius: 2px;
  display: flex; align-items: center; justify-content: center;
  font-family: var(--mono); font-size: 10px; color: var(--pencil-2b);
  min-width: 22px; flex: 1; transition: all 0.05s;
}
.vb.sam { border-color: var(--saffron); color: var(--saffron); font-weight: 700; border-width: 1.5px; }
.vb.khali { border-color: var(--pencil-h); color: var(--pencil-hb2); border-style: dashed; }
.vb.lit { background: var(--saffron) !important; color: var(--paper) !important; border-color: var(--saffron) !important; }
.vb.sam.lit { background: var(--saffron-dim) !important; }

/* Indian drum sound label */
.snd-b.dha-style { border-color: rgba(200,82,10,0.3); }
.snd-b.dha-style.on { background: var(--saffron-lt); border-color: var(--saffron); color: var(--saffron); }

/* Scale/mode Indian badge */
.indian-badge {
  display: inline-block; font-size: 10px; font-family: var(--mono);
  padding: 2px 7px; border-radius: 2px;
  background: var(--saffron-faint); border: 1px solid rgba(200,82,10,0.3);
  color: var(--saffron-dim); margin-left: 6px; vertical-align: middle;
}


/* ─── LIVE MODE ──────────────────────────────── */
.live-btn {
  padding: 6px 16px;
  background: transparent;
  border: 1.5px solid var(--pencil-mid);
  border-radius: 2px;
  font-family: var(--hand); font-size: 14px;
  color: var(--pencil-2b); cursor: pointer;
  transition: all 0.18s; white-space: nowrap;
  margin-right: 4px;
}
.live-btn:hover { border-color: var(--red-ink); color: var(--red-ink); }
.live-btn.on {
  background: var(--red-ink); border-color: var(--red-ink);
  color: var(--paper); font-weight: 700;
  animation: livepulse 1.4s infinite;
}
@keyframes livepulse {
  0%,100% { box-shadow: 0 0 0 0 rgba(122,46,46,0.5); }
  50%      { box-shadow: 0 0 0 6px rgba(122,46,46,0); }
}

/* ─── LIVE PANEL WRAPPER ──────────────────────── */
#livePnl {
  display: none;
}
#livePnl.show { display: block; }

/* ─── SPL METER ───────────────────────────────── */
.spl-panel {
  background: var(--paper);
  border: 1.5px solid var(--pencil-mid);
  border-radius: 3px;
  overflow: hidden;
  box-shadow: 2px 3px 8px rgba(90,70,45,0.1);
  display: flex;
  flex-direction: column;
  width: 360px;
  height: 420px;
}
.spl-panel::before {
  content:''; display:block; height:3px; flex-shrink: 0;
  background: linear-gradient(90deg, var(--red-ink) 0%, transparent 40%);
  opacity:0.5;
}
.spl-body { padding: 7px 14px 9px; flex: 1; overflow-y: auto; min-height: 0; }
.spl-readout {
  display: flex; align-items: baseline; gap: 8px;
  margin-bottom: 7px;
}
.spl-val {
  font-family: var(--mono); font-size: 36px; font-weight: 600;
  color: var(--ink); line-height: 1; letter-spacing: -1px;
  transition: color 0.2s;
}
.spl-val.warn  { color: var(--amber-ink); }
.spl-val.danger{ color: var(--red-ink); }
.spl-unit { font-family: var(--mono); font-size: 13px; color: var(--pencil-2b); }
.spl-ref-lbl {
  font-family: var(--hand); font-size: 12px; font-style: italic;
  color: var(--pencil-hb2); min-width: 120px;
}

/* horizontal bar + reference marks */
.spl-bar-wrap { position: relative; margin-bottom: 6px; }
.spl-bar-bg {
  width: 100%; height: 22px;
  background: linear-gradient(90deg,
    #c8d8a8 0%,     /* safe green */
    #c8d8a8 40%,
    #e8d080 55%,    /* caution yellow */
    #e0a060 72%,    /* orange */
    #c05040 88%,    /* red */
    #901828 100%    /* danger */
  );
  border: 1px solid var(--pencil-mid);
  border-radius: 2px;
  overflow: hidden;
  position: relative;
}
.spl-bar-fill {
  position: absolute; top:0; left:0; bottom:0;
  background: rgba(250,246,238,0.82);  /* paper mask from right */
  transition: width 0.08s linear;
  right: 0; left: auto;
}
/* reference tick marks */
.spl-ticks {
  position: relative; display: flex;
  height: 18px; margin-top: 2px;
}
.spl-tick {
  position: absolute; bottom: 0;
  font-family: var(--mono); font-size: 9px; color: var(--pencil-2b);
  transform: translateX(-50%);
  display: flex; flex-direction: column; align-items: center; gap: 1px;
}
.spl-tick::before {
  content: ''; display: block;
  width: 1px; height: 6px; background: var(--pencil-mid);
}
/* ref level labels above bar */
.spl-refs {
  display: flex; justify-content: space-between;
  flex-wrap: wrap; gap: 3px;
  margin-top: 5px;
}
.spl-ref-tag {
  font-family: var(--hand); font-size: 10px;
  padding: 1px 6px;
  border: 1px solid var(--pencil-soft);
  border-radius: 2px;
  color: var(--pencil-2b); white-space: nowrap;
  cursor: default;
}
.spl-ref-tag.active-ref { border-color: var(--red-ink); color: var(--red-ink); font-weight: 600; }

/* peak hold line */
.spl-peak-lbl {
  font-family: var(--mono); font-size: 11px; color: var(--pencil-hb2);
  margin-top: 4px; text-align: right;
}

/* ─── OSC / SPEC heightened ─────────────────── */
#oscCvs  { height: 160px !important; }
#specCvs { height: 100px !important; }











/* ── Live mode (kept for live analysis show/hide) ── */

/* ── PANEL CONTROLS BAR — always visible at top ── */
/* ── Sticky shell wrapping both control bars ── */
#stickyShell {
  position: sticky;
  top: 57px;        /* sits right below the header */
  z-index: 250;
  background: var(--bg2);
  border-bottom: 1.5px solid var(--border);
  box-shadow: 0 2px 8px rgba(55,40,20,0.07);
}
body.dark #stickyShell {
  background: rgba(25,22,16,0.98);
  border-color: var(--border);
  box-shadow: 0 2px 10px rgba(0,0,0,0.35);
}

#panelControlsBar {
  display: flex;
  align-items: center;
  gap: 8px;
  flex-wrap: wrap;
  padding: 8px 24px;
  background: transparent;
  border-bottom: 1px solid var(--bord2);
  /* NOT sticky — parent stickyShell handles that */
}
.pbar-lbl {
  font-family: var(--mono); font-size: 10px; letter-spacing: 1.5px;
  color: var(--t4); white-space: nowrap; text-transform: uppercase;
  margin-right: 4px;
}
.pbar-sep {
  width: 1px; height: 20px; background: var(--bord2);
  margin: 0 6px;
}

/* ── Live practice bar (legacy, hidden) ── */
#liveBar { display: none !important; }
.lbar-lbl { font-family: var(--mono); font-size: 10px; letter-spacing: 1.5px; color: var(--t4); }
.ptog {
  padding: 5px 14px;
  border: 1.5px solid var(--border);
  border-radius: 20px;
  background: var(--panel2);
  font-family: var(--mono); font-size: 10px; letter-spacing: 0.5px;
  color: var(--t1); cursor: pointer; transition: all 0.13s; white-space: nowrap;
  font-weight: 600;
}
.ptog:hover { border-color: var(--forest); color: var(--forest); background: var(--panel3); }
.ptog.on  { background: var(--forest); border-color: var(--forest); color: #fff; font-weight: 700; }
#practiceGrid { display: none !important; }

/* ════════════════════════════════════════════
   PANEL DRAG-TO-REARRANGE
════════════════════════════════════════════ */
.panel[draggable="true"], .spl-panel[draggable="true"] {
  cursor: grab;
}
.panel[draggable="true"]:active, .spl-panel[draggable="true"]:active {
  cursor: grabbing;
}
.ph {
  position: relative;
  cursor: grab;
}
.panel.drag-over, .spl-panel.drag-over {
  outline: 2px dashed var(--forest);
  outline-offset: 2px;
}
.panel.dragging, .spl-panel.dragging {
  opacity: 0.45;
}
/* Panel collapse button — HIDDEN (removed per request) */
.panel-collapse-btn { display: none !important; }

/* ════════════════════════════════════════════
   DRUM LOOPS PANEL
════════════════════════════════════════════ */
.drums-body { padding: 10px 12px; }
.drum-genre-grid {
  display: grid; grid-template-columns: repeat(auto-fill, minmax(88px,1fr));
  gap: 5px; margin-bottom: 10px;
}
.drum-genre-btn {
  padding: 6px 4px; text-align: center;
  border: 1.5px solid var(--border); border-radius: 4px;
  background: var(--panel2); font-family: var(--mono); font-size: 10px;
  color: var(--t2); cursor: pointer; transition: all 0.13s; line-height: 1.4; font-weight: 500;
}
.drum-genre-btn:hover { border-color: var(--t2); color: var(--t1); background: var(--panel3); }
.drum-genre-btn.on { border-color: var(--indigo); background: rgba(61,74,138,0.12); color: var(--indigo); font-weight: 700; }
.drum-genre-btn .dg-icon { font-size: 15px; display: block; margin-bottom: 2px; }
.drum-controls { display: flex; flex-direction: column; gap: 7px; margin-bottom: 10px; }
.drum-grid { display: flex; flex-direction: column; gap: 3px; margin-bottom: 10px; }
.dstep { flex: 1; height: 22px; border: 1px solid var(--bord2); border-radius: 2px; background: var(--panel2); cursor: pointer; transition: all 0.07s; position: relative; }

.drum-ctrl-row { display: flex; align-items: center; gap: 10px; }
.drum-ctrl-lbl { font-family: var(--mono); font-size: 10px; color: var(--t2); letter-spacing: 1px; min-width: 80px; font-weight: 600; }
.drum-ctrl-val { font-family: var(--mono); font-size: 11px; color: var(--t2); min-width: 38px; text-align: right; }

.complexity-dots { display: flex; gap: 4px; }
.cplx-dot {
  width: 22px; height: 22px; border-radius: 3px;
  border: 1px solid var(--bord2); background: var(--panel2);
  cursor: pointer; transition: all 0.12s;
}
.cplx-dot.on { background: var(--indigo); border-color: var(--indigo); }

.loop-len-btns { display: flex; gap: 4px; }
.loop-len-btn {
  padding: 4px 10px; border: 1px solid var(--border); border-radius: 3px;
  background: transparent; font-family: var(--mono); font-size: 10px;
  color: var(--t3); cursor: pointer; transition: all 0.12s;
}
.loop-len-btn:hover { border-color: var(--t3); color: var(--t2); }
.loop-len-btn.on { background: rgba(61,74,138,0.08); border-color: var(--indigo); color: var(--indigo); font-weight: 600; }

.drum-row { display: flex; align-items: center; gap: 6px; }
.drum-row-lbl { font-family: var(--mono); font-size: 10px; color: var(--t2); min-width: 52px; letter-spacing: 0.5px; font-weight: 600; }
.drum-steps { display: flex; gap: 3px; flex: 1; }
.dstep {
  flex: 1; height: 26px; border: 1.5px solid var(--border); border-radius: 2px;
  background: var(--panel2); cursor: pointer; transition: all 0.07s;
  position: relative;
}
.dstep.beat-start { border-left: 2px solid rgba(40,25,8,0.35); }
.dstep.on { background: var(--indigo); border-color: var(--indigo); }
.dstep.on.accent { background: var(--rust); border-color: var(--rust); }
.dstep.playing { box-shadow: 0 0 0 2px var(--ochre); }

.drum-play-row { display: flex; gap: 8px; align-items: center; }
.drum-play-btn {
  flex: 1; padding: 11px; background: rgba(30,45,110,0.08); border: 2px solid var(--indigo);
  color: var(--indigo); font-family: var(--mono); font-size: 11px; font-weight: 700;
  letter-spacing: 2px; cursor: pointer; text-align: center; border-radius: 3px; transition: all 0.15s;
}
.drum-play-btn:hover { background: rgba(30,45,110,0.16); }
.drum-play-btn.playing { background: rgba(92,26,8,0.08); border-color: var(--rust); color: var(--rust); animation: pblink 1s infinite; }
.drum-shuffle-btn {
  padding: 11px 14px; border: 1.5px solid var(--border); border-radius: 3px;
  background: var(--panel2); font-family: var(--mono); font-size: 11px; color: var(--t1);
  cursor: pointer; transition: all 0.13s; font-weight: 600;
}
.drum-shuffle-btn:hover { border-color: var(--t1); background: var(--panel3); }

/* ════════════════════════════════════════════
   INDIAN RHYTHMS PANEL
════════════════════════════════════════════ */
/* indianRhythmsPanel hidden via inline style, shown by JS */
.ir-body { padding: 10px 12px; }
.ir-taal-grid { display: grid; grid-template-columns: repeat(2,1fr); gap: 4px; margin-bottom: 9px; }
.ir-taal-btn {
  padding: 8px 10px; background: var(--panel2); border: 1px solid var(--pencil-soft,var(--bord2));
  border-radius: 3px; font-family: var(--hand); font-size: 12px; color: var(--pencil-2b,var(--t2));
  cursor: pointer; text-align: left; transition: all 0.13s; line-height: 1.4;
}
.ir-taal-btn:hover { border-color: var(--saffron); color: var(--saffron); background: var(--saffron-faint); }
.ir-taal-btn.on { background: var(--saffron-lt,rgba(200,82,10,0.12)); border-color: var(--saffron); color: var(--saffron); font-weight: 600; }
.ir-taal-btn small { display: block; font-size: 10px; color: var(--t4); font-family: var(--mono); font-weight: 400; }
.ir-vibhag { display: flex; gap: 3px; flex-wrap: wrap; margin-bottom: 10px; }
.ir-beat {
  height: 32px; border: 1px solid var(--bord2); border-radius: 2px; flex: 1; min-width: 22px;
  display: flex; align-items: center; justify-content: center;
  font-family: var(--mono); font-size: 9px; color: var(--t3); transition: all 0.06s;
}
.ir-beat.sam { border-color: var(--saffron); color: var(--saffron); font-weight: 700; border-width: 1.5px; }
.ir-beat.khali { border-style: dashed; color: var(--t4); }
.ir-beat.lit { background: var(--saffron) !important; color: #fff !important; border-color: var(--saffron) !important; }
.ir-bols { font-family: var(--mono); font-size: 10px; color: var(--saffron-dim,#a04008); padding: 5px 9px;
  background: var(--saffron-faint,rgba(200,82,10,0.07)); border-radius: 2px; margin-bottom: 8px; letter-spacing: 0.5px; line-height: 1.6; }
.ir-ctrl-row { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
.ir-lbl { font-family: var(--mono); font-size: 10px; color: var(--t2); letter-spacing: 1px; min-width: 60px; font-weight: 700; }
.ir-val { font-family: var(--mono); font-size: 11px; color: var(--t1); min-width: 40px; text-align: right; font-weight: 700; }
.ir-play-btn {
  display: block; width: 100%; padding: 11px;
  background: var(--saffron-faint,rgba(192,98,10,0.08)); border: 2px solid var(--saffron);
  color: var(--saffron); font-family: var(--mono); font-size: 11px; font-weight: 800;
  letter-spacing: 2px; cursor: pointer; text-align: center; border-radius: 3px; transition: all 0.15s; margin-top: 8px;
}
.ir-play-btn:hover { background: rgba(192,98,10,0.18); }
.ir-play-btn.playing { background: rgba(92,26,8,0.08); border-color: var(--rust); color: var(--rust); animation: pblink 1s infinite; }



/* ════════════════════════════════════════════
   INSTRUMENT TUNING
════════════════════════════════════════════ */
.tun-wrap {
  padding: 7px 12px 10px;
  border-top: 1px solid var(--bord2);
}
.tun-row { display: flex; align-items: center; gap: 8px; margin-bottom: 7px; flex-wrap: wrap; }
.tun-lbl {
  font-family: var(--mono); font-size: 10px; letter-spacing: 1px; color: var(--t2);
  min-width: 76px; text-transform: uppercase; font-weight: 700;
}
.tun-sel {
  flex: 1; min-width: 150px;
  padding: 5px 26px 5px 9px;
  border: 1.5px solid var(--border); border-radius: 3px;
  background-color: var(--panel2);
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%233e2808'/%3E%3C/svg%3E");
  background-repeat: no-repeat; background-position: right 8px center;
  appearance: none; -webkit-appearance: none;
  font-family: var(--mono); font-size: 11px; color: var(--t1); cursor: pointer; font-weight: 600;
}
.tun-sel:focus { outline: none; border-color: var(--forest); }
.tun-strings { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 2px; }
.tstr {
  padding: 5px 8px; min-width: 36px; text-align: center;
  border: 1px solid var(--bord2); border-radius: 3px;
  background: var(--panel); font-family: var(--mono); font-size: 13px; color: var(--t2);
  cursor: pointer; transition: all 0.12s;
}
.tstr small { display: block; font-size: 9px; color: var(--t4); margin-top: 1px; }
.tstr:hover, .tstr.on { border-color: var(--forest); color: var(--forest); background: rgba(45,90,61,0.06); }

/* ══════════════════════════════════════════════
   NEW HEADER ELEMENTS
══════════════════════════════════════════════ */
.hbar-indicators {
  display: flex; gap: 6px; align-items: center;
}
.status-pill {
  display: flex; align-items: center; gap: 4px;
  padding: 3px 8px; border: 1px solid var(--border); border-radius: 20px;
  font-family: var(--mono); font-size: 9px; letter-spacing: 1px; color: var(--t4);
  transition: all 0.3s;
}
.status-pill.active { border-color: var(--forest); color: var(--forest); }
.status-pill.playing-active { border-color: var(--ochre); color: var(--ochre); }
.status-dot {
  width: 6px; height: 6px; border-radius: 50%;
  background: var(--t4); flex-shrink: 0; transition: background 0.3s;
}
.status-pill.active .status-dot { background: var(--forest); animation: pulse-dot 1.5s infinite; }
.status-pill.playing-active .status-dot { background: var(--ochre); animation: pulse-dot 0.8s infinite; }
@keyframes pulse-dot { 0%,100%{opacity:1} 50%{opacity:0.3} }

.global-play-btn {
  display: flex; align-items: center; gap: 7px;
  padding: 7px 18px; border: 2px solid var(--indigo);
  background: rgba(61,74,138,0.08); color: var(--indigo);
  font-family: var(--mono); font-size: 11px; font-weight: 800;
  letter-spacing: 2px; cursor: pointer; border-radius: 4px; transition: all 0.18s;
  white-space: nowrap; position: relative; overflow: hidden;
}
.global-play-btn:hover { background: rgba(61,74,138,0.18); transform: translateY(-1px); box-shadow: 0 3px 12px rgba(61,74,138,0.25); }
.global-play-btn:active { transform: translateY(0); }
.global-play-btn .gpb-icon { font-size: 13px; line-height: 1; transition: all 0.15s; }
.global-play-btn.playing {
  background: rgba(61,74,138,0.16); border-color: var(--indigo);
  box-shadow: 0 0 0 3px rgba(61,74,138,0.18);
  animation: gpb-pulse 2s ease-in-out infinite;
}
.global-play-btn.playing:hover { box-shadow: 0 0 0 4px rgba(61,74,138,0.28); }
@keyframes gpb-pulse {
  0%,100% { box-shadow: 0 0 0 2px rgba(61,74,138,0.2); }
  50%      { box-shadow: 0 0 0 6px rgba(61,74,138,0.0); }
}
/* Module play indicators on the button itself */
.gpb-modules {
  display: flex; gap: 3px; align-items: center; margin-left: 4px;
}
.gpb-dot {
  width: 5px; height: 5px; border-radius: 50%;
  background: rgba(61,74,138,0.25); transition: all 0.2s;
}
.gpb-dot.active { background: var(--indigo); box-shadow: 0 0 4px var(--indigo); }
body.dark .global-play-btn { border-color: var(--indigo); color: var(--indigo); }
body.dark .global-play-btn:hover { background: rgba(143,168,232,0.15); }
body.dark .global-play-btn.playing { background: rgba(143,168,232,0.12); }

.input-group { display: flex; gap: 4px; align-items: center; }
.header-midi-btn {
  display: flex; align-items: center; gap: 5px;
  padding: 6px 10px;
  background: rgba(122,48,32,0.06); border: 1.5px solid var(--rust);
  color: var(--rust); font-family: var(--mono); font-size: 10px; font-weight: 600;
  letter-spacing: 1px; cursor: pointer; border-radius: 3px; transition: all 0.2s;
  white-space: nowrap;
}
.header-midi-btn:hover { background: rgba(122,48,32,0.12); }
.header-midi-btn.act { background: rgba(122,48,32,0.15); animation: mpulse 2s infinite; }
.header-midi-dot {
  width: 6px; height: 6px; border-radius: 50%; background: var(--t4); transition: background 0.2s; flex-shrink: 0;
}
.header-midi-btn.act .header-midi-dot { background: var(--rust); }
body.dark .header-mic-btn  { background: rgba(94,196,122,0.08); border-color: var(--forest); color: var(--forest); }
body.dark .header-midi-btn { background: rgba(224,112,96,0.08); border-color: var(--rust);   color: var(--rust); }

/* Volume knob */
.vol-knob-wrap {
  display: flex; flex-direction: column; align-items: center; gap: 2px;
  position: relative;
}
.vol-knob-slider {
  writing-mode: vertical-lr;
  direction: rtl;
  width: 28px; height: 44px;
  cursor: pointer; accent-color: var(--forest);
}
.vol-knob-lbl {
  font-family: var(--mono); font-size: 8px; color: var(--t4);
  letter-spacing: 1px; text-align: center;
}

/* Input popups */
.input-popup {
  position: fixed; z-index: 9000;
  background: var(--panel); border: 1.5px solid var(--border);
  border-radius: 6px; min-width: 200px;
  box-shadow: 0 8px 24px rgba(0,0,0,0.15);
  font-family: var(--mono); font-size: 11px;
}
.input-popup-hdr {
  padding: 8px 12px; font-size: 10px; letter-spacing: 1.5px;
  color: var(--t3); border-bottom: 1px solid var(--bord2);
  font-weight: 600; text-transform: uppercase;
}
.input-popup-list { padding: 4px 0; }
.input-popup-item {
  padding: 7px 12px; cursor: pointer; color: var(--t2);
  transition: background 0.1s;
}
.input-popup-item:hover { background: var(--panel2); }
.input-popup-item.active { color: var(--forest); font-weight: 600; }
.input-popup-item.muted  { color: var(--t4); cursor: default; font-style: italic; }

/* ── Panel toggle indicator dots ── */
.ptog-dot {
  display: inline-block; width: 5px; height: 5px; border-radius: 50%;
  background: transparent; margin-right: 4px; transition: background 0.2s;
  vertical-align: middle; flex-shrink: 0;
}
.ptog-dot.active.listen-dot { background: var(--forest); }
.ptog-dot.active.play-dot   { background: var(--ochre); }

/* ══════════════════════════════════════════════
   UPDATED PANEL LAYOUT — horizontal row
══════════════════════════════════════════════ */
main { padding: 10px 16px 32px; }
#panelGrid {
  display: flex;
  flex-direction: row;
  flex-wrap: wrap;
  gap: 12px;
  align-items: flex-start;
  justify-content: flex-start;
}
/* Panels default to a fixed square size */
.panel, .spl-panel {
  width: 320px;
  min-width: 240px;
  max-width: 480px;
  flex-shrink: 0;
}
@media(max-width: 860px) {
  .panel, .spl-panel { width: 280px; }
}
@media(max-width: 580px) {
  #panelGrid { flex-direction: column; }
  .panel, .spl-panel { width: 100% !important; max-width: 100%; }
  main { padding: 8px 8px 24px; }
}

/* ── Panel minimize states ── */
.panel.minimized, .spl-panel.minimized {
  height: 38px !important;
  overflow: hidden;
  aspect-ratio: unset;
  min-height: 0;
}
.panel.minimized .panel-body,
.spl-panel.minimized .spl-body { display: none; }
.panel.compact, .spl-panel.compact {
  height: 160px;
  overflow: hidden;
  aspect-ratio: unset;
}
/* Panel header minimize button */
.ph-min-btn {
  display: flex; align-items: center; justify-content: center;
  width: 22px; height: 22px; border: 1px solid var(--bord2); border-radius: 3px;
  background: transparent; color: var(--t3); font-size: 9px;
  cursor: pointer; transition: all 0.12s; flex-shrink: 0; font-family: var(--mono);
}
.ph-min-btn:hover { border-color: var(--t2); color: var(--t1); background: var(--panel2); }
.ph { gap: 8px; }

/* ══════════════════════════════════════════════
   LOUDNESS METER NEW ELEMENTS
══════════════════════════════════════════════ */
.spl-stats-row {
  display: flex; gap: 8px; margin: 6px 0;
}
.spl-stat {
  display: flex; flex-direction: column; align-items: center;
  flex: 1; padding: 4px 8px; border: 1px solid var(--bord2);
  border-radius: 3px; background: var(--panel2);
}
.spl-stat-lbl {
  font-family: var(--mono); font-size: 8px; color: var(--t4); letter-spacing: 1px; margin-bottom: 2px;
}
.spl-stat-val {
  font-family: var(--mono); font-size: 14px; font-weight: 600; color: var(--t1);
}
.spl-clock {
  font-family: var(--mono); font-size: 11px; color: var(--t4);
  margin-left: auto; letter-spacing: 1px;
}
.spl-seismo {
  width: 100%; height: 50px; display: block;
  border: 1px solid var(--bord2); border-radius: 2px; margin: 6px 0;
  background: var(--panel2);
}

/* ══════════════════════════════════════════════
   SWING + CLAP DETECT
══════════════════════════════════════════════ */
#clapDetectBtn {
  padding: 4px 10px; border: 1px dashed var(--border); border-radius: 3px;
  background: transparent; font-family: var(--mono); font-size: 10px;
  color: var(--t3); cursor: pointer; transition: all 0.12s;
}
#clapDetectBtn:hover { border-color: var(--forest); color: var(--forest); }
#clapDetectBtn.listening {
  border-color: var(--forest); color: var(--forest);
  background: rgba(45,90,61,0.08); animation: mpulse 1s infinite;
}
#clapDetectLbl { font-size: 10px; color: var(--t3); }

/* ══════════════════════════════════════════════
   INDIAN RHYTHMS NEW ELEMENTS
══════════════════════════════════════════════ */
.ir-ctrl-row {
  display: flex; align-items: center; gap: 8px;
  margin-bottom: 8px; flex-wrap: wrap;
}
.ir-dl-btn {
  padding: 5px 10px; border: 1px solid var(--border); border-radius: 3px;
  background: transparent; font-family: var(--mono); font-size: 10px;
  color: var(--t3); cursor: pointer; transition: all 0.12s; margin-left: auto;
}
.ir-dl-btn:hover { border-color: var(--forest); color: var(--forest); }

/* ══════════════════════════════════════════════
   DRUM LOOPS NEW ELEMENTS
══════════════════════════════════════════════ */
.drum-dl-btn {
  padding: 5px 10px; border: 1px solid var(--border); border-radius: 3px;
  background: transparent; font-family: var(--mono); font-size: 10px;
  color: var(--t3); cursor: pointer; transition: all 0.12s;
}
.drum-dl-btn:hover { border-color: var(--indigo); color: var(--indigo); }

/* ══════════════════════════════════════════════
   CHORD GENERATOR PANEL ADDITIONS
══════════════════════════════════════════════ */
.gen-detect-bar {
  display: flex; align-items: center; gap: 8px;
  padding: 6px 14px; background: var(--panel2);
  border-bottom: 1px solid var(--bord2);
  font-family: var(--mono); font-size: 10px; flex-wrap: wrap;
}
.gen-detect-dot {
  width: 7px; height: 7px; border-radius: 50%;
  background: var(--t4); flex-shrink: 0; transition: background 0.2s;
}
.gen-detect-dot.active { background: var(--forest); animation: pulse-dot 1.5s infinite; }
.gen-detect-note {
  font-size: 14px; font-weight: 700; color: var(--forest); min-width: 24px;
}
.gen-detect-hint { color: var(--t4); font-size: 9px; flex: 1; }
.gen-midi-note { font-size: 10px; color: var(--indigo); font-weight: 600; }
.gen-player-strip {
  padding: 8px 14px; border-bottom: 1px solid var(--bord2);
  background: var(--panel2);
}
.gen-player-chords {
  display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 8px; min-height: 32px;
  align-items: center;
}
.gen-player-btns { display: flex; gap: 6px; align-items: center; flex-wrap: wrap; }
.gen-btn {
  padding: 5px 12px; border: 1.5px solid var(--border); border-radius: 3px;
  background: var(--panel2); font-family: var(--mono); font-size: 10px; letter-spacing: 0.5px;
  color: var(--t1); cursor: pointer; transition: all 0.12s; font-weight: 700;
}
.gen-btn:hover { border-color: var(--forest); color: var(--forest); background: var(--panel3); }
.gen-btn.active { background: var(--forest); color: #fff; border-color: var(--forest); font-weight: 800; }
.gen-btn-dl:hover { border-color: var(--indigo); color: var(--indigo); }
.gen-bars-sel {
  padding: 3px 8px; border: 1.5px solid var(--border); border-radius: 3px;
  background: var(--panel2); color: var(--t1); font-family: var(--mono); font-size: 10px;
  cursor: pointer; font-weight: 600;
}
.gen-chord-chip {
  padding: 4px 10px; border: 1.5px solid var(--border); border-radius: 3px;
  background: var(--panel2); font-family: var(--mono); font-size: 11px; color: var(--t1);
  cursor: pointer; transition: all 0.12s; user-select: none; font-weight: 600;
}
.gen-chord-chip:hover { border-color: var(--forest); color: var(--forest); }
.gen-chord-chip.playing { background: var(--forest); color: #fff; border-color: var(--forest); }

/* osc note detector badge */
.osc-wrap { position: relative; }
.osc-note-badge {
  position: absolute; top: 8px; right: 14px;
  background: var(--indigo); color: #fff;
  font-family: var(--mono); font-size: 12px; font-weight: 700;
  padding: 3px 8px; border-radius: 3px;
  pointer-events: none; z-index: 5;
}
body.dark .osc-note-badge { background: rgba(143,168,232,0.9); color: #0f0d09; }

/* spl stats dark */
body.dark .spl-stat { background: var(--panel3); border-color: var(--border); }
body.dark .spl-stat-lbl { color: var(--t4); }
body.dark .spl-stat-val { color: var(--t1); }
body.dark .spl-clock { color: var(--t4); }

/* gen detect dark */
body.dark .gen-detect-bar { background: var(--panel3); border-color: var(--bord2); }
body.dark .gen-detect-hint { color: var(--t4); }


/* ════════════════════════════════════════════
   SPECTRUM CHORD/NOTE DETECTOR
════════════════════════════════════════════ */
.spec-det-bar {
  display: flex; align-items: center; gap: 8px;
  padding: 5px 14px; border-bottom: 1px solid var(--bord2);
  flex-shrink: 0;
}
.spec-note-badge {
  font-family: var(--mono); font-size: 16px; font-weight: 700;
  color: var(--forest); background: rgba(45,90,61,0.1);
  border: 1px solid var(--forest); border-radius: 3px;
  padding: 2px 8px; min-width: 32px; text-align: center;
}
body.dark .spec-note-badge { color: #0ff; background: rgba(0,255,255,0.1); border-color: #0ff; }
.spec-chord-badge {
  font-family: var(--mono); font-size: 13px; font-weight: 600;
  color: var(--indigo); background: rgba(74,74,196,0.1);
  border: 1px solid var(--indigo); border-radius: 3px;
  padding: 2px 8px; display: none;
}
body.dark .spec-chord-badge { color: #f80; background: rgba(255,128,0,0.1); border-color: #f80; }
.spec-chord-badge.visible { display: inline-block; }
.spec-peak-freq {
  font-family: var(--mono); font-size: 10px; color: var(--t3); margin-left: auto;
}

/* ════════════════════════════════════════════
   LOOP / SONG GENERATOR PANEL
════════════════════════════════════════════ */
.lg-row {
  display: flex; align-items: center; flex-wrap: wrap; gap: 6px;
  margin-bottom: 8px;
}
.lg-lbl {
  font-family: var(--mono); font-size: 9px; letter-spacing: 2px;
  color: var(--t3); white-space: nowrap; min-width: 72px;
}
.lg-btn-row {
  display: flex; flex-wrap: wrap; gap: 6px; margin-top: 10px;
  padding-top: 8px; border-top: 1px solid var(--bord2);
}
/* Song structure display */
.lg-section {
  border: 1px solid var(--bord2); border-radius: 4px;
  margin-bottom: 6px; overflow: hidden; cursor: pointer;
  transition: border-color 0.15s;
}
.lg-section:hover { border-color: var(--t3); }
.lg-section.active { border-color: var(--forest); }
.lg-sec-hdr {
  display: flex; align-items: center; gap: 8px;
  padding: 6px 10px; background: var(--panel2);
  font-family: var(--mono); font-size: 10px; letter-spacing: 1px;
}
.lg-sec-name { font-weight: 700; color: var(--t2); min-width: 80px; }
.lg-sec-bars { color: var(--t4); font-size: 9px; }
.lg-sec-chords-preview { color: var(--forest); font-size: 11px; flex: 1; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
.lg-sec-body {
  padding: 6px 10px 8px; display: none;
  border-top: 1px solid var(--bord2);
}
.lg-section.open .lg-sec-body { display: block; }
.lg-chord-chip {
  display: inline-flex; flex-direction: column; align-items: center;
  padding: 4px 8px; border: 1px solid var(--bord2); border-radius: 3px;
  font-family: var(--mono); font-size: 11px; color: var(--t2);
  cursor: pointer; margin: 2px; transition: all 0.12s;
  background: var(--panel);
}
.lg-chord-chip:hover { border-color: var(--forest); color: var(--forest); }
.lg-chord-chip.playing { background: var(--forest); color: #fff; border-color: var(--forest); }
.lg-chord-chip .chip-rom { font-size: 8px; color: var(--t4); margin-bottom: 1px; }
.lg-chord-chip .chip-name { font-weight: 700; }
.lg-chord-chip .chip-notes { font-size: 8px; color: var(--t3); }
/* Chord edit modal */
#lgChordEditModal {
  position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%);
  background: var(--panel); border: 1px solid var(--border);
  border-radius: 8px; padding: 16px; z-index: 9999;
  box-shadow: 0 8px 32px rgba(0,0,0,0.2); min-width: 240px;
  display: none;
}
#lgChordEditModal.open { display: block; }
#lgChordEditOverlay {
  position: fixed; inset: 0; background: rgba(0,0,0,0.4);
  z-index: 9998; display: none;
}
#lgChordEditOverlay.open { display: block; }

/* ════════════════════════════════════════════
   METRONOME OSCILLOSCOPE
════════════════════════════════════════════ */
.metro-osc-wrap {
  margin: 8px 0 6px; border: 1px solid var(--bord2); border-radius: 4px;
  overflow: hidden;
}
.metro-osc-lbl {
  font-family: var(--mono); font-size: 9px; color: var(--t4);
  letter-spacing: 1px; padding: 3px 8px; background: var(--panel2);
  border-bottom: 1px solid var(--bord2);
}
.metro-osc-status {
  font-family: var(--mono); font-size: 10px; padding: 2px 8px;
  font-weight: 600; text-align: center;
  background: var(--panel2); border-top: 1px solid var(--bord2);
}
.metro-osc-status.rushing { color: #c44; }
.metro-osc-status.dragging { color: #44c; }
.metro-osc-status.intune { color: var(--forest); }

/* ════════════════════════════════════════════
   TUNER - taller seismograph
════════════════════════════════════════════ */
.seismo-wrap { min-height: 140px; flex-shrink: 0; }
#seismoCvs { min-height: 140px; height: 140px; }

/* ════════════════════════════════════════════
   WINDOW MANAGER — minimize/compact tweaks
════════════════════════════════════════════ */
.win-min-btn {
  display: inline-flex; align-items: center;
  padding: 1px 5px; border: 1px solid var(--bord2);
  border-radius: 2px; background: transparent;
  font-size: 10px; color: var(--t4); cursor: pointer;
  transition: all 0.1s; margin-left: 6px; flex-shrink: 0;
  font-family: var(--mono);
}
.win-min-btn:hover { color: var(--t2); border-color: var(--t3); }
.panel.win-mini  { overflow: hidden; }
.panel.win-mini .panel-body,
.panel.win-mini .mbody,
.panel.win-mini .drums-body,
.panel.win-mini .ir-body,
.panel.win-mini .spl-body,
.panel.win-mini .osc-wrap,
.panel.win-mini .spec-wrap,
.panel.win-mini .ctrl,
.panel.win-mini .seismo-wrap,
.panel.win-mini .tmeter,
.panel.win-mini .tun-wrap,
.panel.win-mini .gen-detect-bar,
.panel.win-mini .gen-player-strip,
.panel.win-mini .theory-ctrl,
.panel.win-mini #chordsV,
.panel.win-mini #scalesV,
.panel.win-mini #modesV,
.panel.win-mini #indianV,
.spl-panel.win-mini .spl-body { display: none !important; }

/* ════════════════════════════════════════════
   CHORD EDITOR IN LOOP GEN
════════════════════════════════════════════ */
.chord-edit-row { display: flex; flex-wrap: wrap; gap: 4px; margin-bottom: 8px; }
.chord-edit-opt {
  padding: 4px 8px; border: 1px solid var(--bord2); border-radius: 3px;
  font-family: var(--mono); font-size: 10px; color: var(--t3);
  cursor: pointer; background: var(--panel); transition: all 0.1s;
}
.chord-edit-opt:hover { border-color: var(--t3); color: var(--t2); }
.chord-edit-opt.on { background: var(--forest); color: #fff; border-color: var(--forest); }

</style>
</head>
<body>

<header>
  <div class="logo">Vai<em>khari</em><span class="logo-sub">Music Studio</span></div>
  <div class="hbar">
    <!-- Global status indicators -->
    <div class="hbar-indicators">
      <div class="status-pill" id="listeningPill" title="Listening active">
        <span class="status-dot listening-dot" id="listeningDot"></span>
        <span class="status-pill-lbl">LISTENING</span>
      </div>
      <div class="status-pill" id="playingPill" title="Playing active">
        <span class="status-dot playing-dot" id="playingDot"></span>
        <span class="status-pill-lbl">PLAYING</span>
      </div>
    </div>
    <!-- Global Play/Stop -->
    <button class="global-play-btn" id="globalPlayBtn" title="Play / stop all active modules">
      <span class="gpb-icon" id="globalPlayIcon">▶</span>
      <span id="globalPlayLbl">PLAY ALL</span>
      <span class="gpb-modules">
        <span class="gpb-dot" id="gpbDotMetro"  title="Metronome"></span>
        <span class="gpb-dot" id="gpbDotDrums"  title="Drum loops"></span>
        <span class="gpb-dot" id="gpbDotIR"     title="Indian rhythms"></span>
        <span class="gpb-dot" id="gpbDotGen"    title="Chord player"></span>
        <span class="gpb-dot" id="gpbDotLg"     title="Loop generator"></span>
      </span>
    </button>
    <!-- Mic + Input selector -->
    <div class="input-group">
      <button class="header-mic-btn" id="micBtn" title="Left: toggle mic · Right-click: select input">
        <span class="header-mic-dot" id="mic-dot"></span>
        <span id="micBtnTxt">MIC</span>
      </button>
      <button class="header-midi-btn" id="midiBtn" title="MIDI on/off · Right-click: select device">
        <span class="header-midi-dot" id="midi-dot"></span>
        <span id="midiBtnTxt">MIDI</span>
      </button>
    </div>
    <!-- Volume knob + output -->
    <div class="vol-knob-wrap" title="Master volume">
      <input type="range" id="masterVolKnob" class="vol-knob-slider" min="0" max="100" value="80" orient="vertical">
      <div class="vol-knob-lbl">VOL</div>
    </div>
    <button class="indian-master-btn" id="indianBtn">🪔 INDIAN</button>
    <button class="dark-toggle" id="darkToggle" title="Toggle dark mode">
      <span class="dt-icon" id="dtIcon">🌙</span>
      <span id="dtLabel">DARK</span>
    </button>
    <div class="stopwatch-wrap">
      <div class="stopwatch-display" id="swDisplay" title="Click to start / pause">00:00:00</div>
      <div class="stopwatch-lbl">PRACTICE TIME</div>
      <div class="stopwatch-btns">
        <button class="sw-btn start" id="swStartBtn">▶ START</button>
        <button class="sw-btn" id="swResetBtn">↺ RESET</button>
      </div>
    </div>
  </div>
</header>

<!-- Input selector popup (right-click mic) -->
<div id="inputSelectPopup" class="input-popup" style="display:none">
  <div class="input-popup-hdr">🎙 AUDIO INPUT</div>
  <div id="audioInputList" class="input-popup-list"></div>
</div>
<!-- MIDI device popup (right-click MIDI) -->
<div id="midiSelectPopup" class="input-popup" style="display:none">
  <div class="input-popup-hdr">🎹 MIDI DEVICES</div>
  <div id="midiDeviceList" class="input-popup-list">
    <div class="input-popup-item muted">No MIDI devices found</div>
  </div>
</div>

<div id="indianBanner">
  <span>🪔</span>
  <strong>Indian Mode Active</strong> — Thaats, Ragas &amp; Taals enabled.
  Root note controls all Indian sections automatically.
</div>

<!-- ══ STICKY CONTROLS SHELL ══ -->
<div id="stickyShell">

<!-- ══ PANEL CONTROLS BAR — always visible ══ -->
<div id="panelControlsBar">
  <span class="pbar-lbl">PANELS:</span>
  <button class="ptog" data-panel="tunerPanel" id="togTuner"><span class="ptog-dot listen-dot" id="dotTuner"></span>🎵 Tuner</button>
  <button class="ptog" data-panel="metroPanel" id="togMetro"><span class="ptog-dot play-dot" id="dotMetro"></span>🥁 Metronome</button>
  <button class="ptog" data-panel="theoryPanel" id="togTheory">🎹 Generator</button>
  <button class="ptog" data-panel="loopGenPanel" id="togLoopGen">🎼 Loop/Song</button>
  <button class="ptog" data-panel="drumsPanel" id="togDrums"><span class="ptog-dot play-dot" id="dotDrums"></span>🥁 Drum Loops</button>
  <div class="pbar-sep"></div>
  <button class="ptog" data-panel="dbMeterPanel" id="togLoudness"><span class="ptog-dot listen-dot" id="dotLoudness"></span>🔊 Loudness</button>
  <button class="ptog" data-panel="oscPanel" id="togOsc"><span class="ptog-dot listen-dot" id="dotOsc"></span>〰 Oscilloscope</button>
  <button class="ptog" data-panel="specPanel" id="togSpec"><span class="ptog-dot listen-dot" id="dotSpec"></span>📈 Spectrum</button>
  <div class="pbar-sep"></div>
  <span class="indian-only-toggles" style="display:none;align-items:center;gap:8px">
    <button class="ptog" data-panel="indianRhythmsPanel" id="togIR"><span class="ptog-dot play-dot" id="dotIR"></span>🥁 Indian Rhythms</button>
  </span>
</div>
<!-- ══ UNIVERSAL CONTROLS BAR ══ -->
<div id="universalBar">
  <!-- TEMPO -->
  <div class="ubar-group">
    <span class="ubar-lbl">TEMPO</span>
    <div class="ubar-bpm-block">
      <div class="ubar-arrows">
        <button class="ubar-arr" id="ubarBd10" title="−10">«</button>
        <button class="ubar-arr" id="ubarBd1"  title="−1">‹</button>
      </div>
      <div>
        <div id="ubarBpmNum" title="Double-click to type">120</div>
        <div class="ubar-bpm-unit" style="text-align:center">BPM</div>
      </div>
      <div class="ubar-arrows">
        <button class="ubar-arr" id="ubarBu1"  title="+1">›</button>
        <button class="ubar-arr" id="ubarBu10" title="+10">»</button>
      </div>
      <div class="ubar-bpm-right">
        <input type="range" id="ubarBpmSl" min="20" max="300" value="120">
        <button id="ubarTapBtn">⬤ TAP</button>
        <button id="ubarClapBtn" title="Clap/tap a rhythm to auto-detect tempo">👏 CLAP</button>
      </div>
    </div>
  </div>
  <!-- KEY -->
  <div class="ubar-group">
    <span class="ubar-lbl">KEY / ROOT</span>
    <div class="ubar-keys" id="ubarKeyBtns">
      <button class="ubar-key on" data-root="C">C</button>
      <button class="ubar-key" data-root="C#">C#</button>
      <button class="ubar-key" data-root="D">D</button>
      <button class="ubar-key" data-root="D#">D#</button>
      <button class="ubar-key" data-root="E">E</button>
      <button class="ubar-key" data-root="F">F</button>
      <button class="ubar-key" data-root="F#">F#</button>
      <button class="ubar-key" data-root="G">G</button>
      <button class="ubar-key" data-root="G#">G#</button>
      <button class="ubar-key" data-root="A">A</button>
      <button class="ubar-key" data-root="A#">A#</button>
      <button class="ubar-key" data-root="B">B</button>
    </div>
  </div>
</div>

</div><!-- /stickyShell -->

<main>
<div id="panelGrid">

  <!-- dB Meter -->
  <div class="spl-panel" id="dbMeterPanel" style="display:none">
      <div class="ph" style="padding:9px 14px">
        <span class="ph-t">LOUDNESS METER</span>
        <span class="ph-r" style="font-family:var(--mono);font-size:10px">SPL · 0–120 dB</span>
      </div>
      <div class="spl-body">
        <!-- Main readout row -->
        <div class="spl-readout">
          <div class="spl-val" id="splVal">---</div>
          <div class="spl-unit">dB</div>
          <div class="spl-ref-lbl" id="splRefLbl">no signal</div>
          <div class="spl-clock" id="splClock">00:00</div>
        </div>
        <!-- VU meter bar -->
        <div class="spl-bar-wrap">
          <div class="spl-bar-bg">
            <div class="spl-bar-fill" id="splFill" style="width:100%"></div>
          </div>
          <div id="splPeakMark" style="position:absolute;top:0;bottom:0;width:2px;background:var(--red-ink);opacity:0.7;left:0;transition:left 0.05s"></div>
        </div>
        <div class="spl-ticks" id="splTicks"></div>
        <!-- Peak + Avg stats -->
        <div class="spl-stats-row">
          <div class="spl-stat"><span class="spl-stat-lbl">PEAK</span><span class="spl-stat-val" id="splPeakStat">---</span></div>
          <div class="spl-stat"><span class="spl-stat-lbl">AVG</span><span class="spl-stat-val" id="splAvgStat">---</span></div>
          <div class="spl-stat"><span class="spl-stat-lbl">MIN</span><span class="spl-stat-val" id="splMinStat">---</span></div>
        </div>
        <!-- 30-second rolling seismograph -->
        <canvas class="spl-seismo" id="splSeismoCvs"></canvas>
        <div class="spl-refs">
          <span class="spl-ref-tag" data-min="40" data-max="60">📚 Library</span>
          <span class="spl-ref-tag" data-min="60" data-max="75">🏠 Conversation</span>
          <span class="spl-ref-tag" data-min="75" data-max="90">🎸 Rehearsal</span>
          <span class="spl-ref-tag" data-min="90" data-max="105">🔊 Concert</span>
          <span class="spl-ref-tag" data-min="105" data-max="120">🏟 Loud ⚠</span>
        </div>
      </div>
  </div><!-- /dbMeterPanel -->

  <!-- Oscilloscope -->
  <div class="panel" id="oscPanel" style="display:none">
      <div class="ph">
        <span class="ph-t">WAVEFORM OSCILLOSCOPE</span>
        <span class="ph-r" id="winLbl">5s WINDOW</span>
      </div>
      <div class="ctrl">
        <span class="clbl">TIME:</span>
        <div class="bg" id="winBtns">
          <button class="b on" data-w="5">5s</button>
          <button class="b" data-w="10">10s</button>
          <button class="b" data-w="15">15s</button>
        </div>
        <span class="clbl" style="margin-left:6px">V-ZOOM:</span>
        <div class="bg" id="vzBtns">
          <button class="b" data-z="0.25">×¼</button>
          <button class="b" data-z="0.5">×½</button>
          <button class="b" data-z="1">×1</button>
          <button class="b" data-z="2">×2</button>
          <button class="b on" data-z="4">×4</button>
        </div>
      </div>
      <div class="osc-wrap">
        <canvas id="oscCvs"></canvas>
        <div class="osc-note-badge" id="oscNoteBadge" style="display:none"></div>
        <div class="osc-xrow" id="xrow"></div>
      </div>
    </div>
    <!-- Spectrum -->
    <div class="panel" id="specPanel" style="display:none">
      <div class="ph">
        <span class="ph-t">FREQUENCY SPECTRUM</span>
        <span class="ph-r">LOG · 20Hz–20kHz</span>
      </div>
      <div class="spec-det-bar" id="specDetBar">
        <span class="spec-note-badge" id="specNoteBadge">--</span>
        <span class="spec-chord-badge" id="specChordBadge"></span>
        <span class="spec-peak-freq" id="specPeakFreq"></span>
      </div>
      <div class="spec-wrap" style="padding:6px 14px 8px">
        <canvas id="specCvs"></canvas>
        <div class="spec-flbl">
          <span>20</span><span>50</span><span>100</span><span>200</span><span>500</span>
          <span>1k</span><span>2k</span><span>5k</span><span>10k</span><span>20k</span>
        </div>
      </div>
    </div><!-- /specPanel -->

  <!-- Theory panel -->
  <div class="panel" id="theoryPanel" style="display:none">
    <div class="ph">
      <span class="ph-t">CHORD GENERATOR</span>
      <span class="ph-r">INTERACTIVE</span>
    </div>
    <!-- Mic note detection bar -->
    <div class="gen-detect-bar" id="genDetectBar">
      <span class="gen-detect-dot" id="genDetectDot"></span>
      <span class="gen-detect-note" id="genDetectNote">--</span>
      <span class="gen-detect-hint">🎤 Sing or play a note to highlight</span>
      <span class="gen-midi-note" id="genMidiNote"></span>
    </div>
    <!-- Player strip -->
    <div class="gen-player-strip" id="genPlayerStrip">
      <div class="gen-player-chords" id="genPlayerChords" title="Drop chord tiles here to build progression"></div>
      <div class="gen-player-btns">
        <button class="gen-btn" id="genPlayBtn">▶ PLAY</button>
        <button class="gen-btn" id="genLoopBtn">⟳ LOOP</button>
        <button class="gen-btn" id="genShuffleBtn">⇌ SUGGEST</button>
        <select class="gen-bars-sel" id="genBarsSel">
          <option value="4">4 bars</option>
          <option value="8" selected>8 bars</option>
          <option value="12">12 bars</option>
          <option value="16">16 bars</option>
          <option value="32">32 bars</option>
        </select>
        <button class="gen-btn gen-btn-dl" id="genDlBtn">⬇ MIDI</button>
      </div>
    </div>
    <div class="theory-ctrl">
      <div class="bg" id="viewBtns">
        <button class="b on" data-view="chords">CHORDS</button>
        <button class="b" data-view="scales">SCALES</button>
        <button class="b" data-view="modes">MODES</button>
        <button class="b indian-tab-btn" data-view="indian" id="indianTabBtn" style="display:none">🪔 THAATS</button>
      </div>
    </div>
    <div id="chordsV"></div>
    <div id="scalesV"><div id="scaleDisp"></div></div>
    <div id="modesV"></div>
    <div id="indianV"><div id="thaatDisp"></div></div>
  </div>

  <!-- LOOP / SONG GENERATOR PANEL -->
  <div class="panel" id="loopGenPanel" style="display:none">
    <div class="ph">
      <span class="ph-t">LOOP &amp; SONG GENERATOR</span>
      <span class="ph-r" id="loopGenStatus">STOPPED</span>
    </div>
    <div class="panel-body" style="padding:10px 12px">
      <!-- Genre + Mode row -->
      <div class="lg-row">
        <span class="lg-lbl">GENRE</span>
        <div class="bg" id="lgGenreBtns" style="flex-wrap:wrap;gap:3px">
          <button class="b on" data-genre="pop">POP</button>
          <button class="b" data-genre="rock">ROCK</button>
          <button class="b" data-genre="jazz">JAZZ</button>
          <button class="b" data-genre="blues">BLUES</button>
          <button class="b" data-genre="classical">CLASSICAL</button>
          <button class="b" data-genre="edm">EDM</button>
          <button class="b" data-genre="rnb">R&amp;B</button>
          <button class="b" data-genre="folk">FOLK</button>
          <button class="b" data-genre="hindustani">HINDUSTANI</button>
        </div>
      </div>
      <!-- Type: Loop or Song -->
      <div class="lg-row">
        <span class="lg-lbl">TYPE</span>
        <div class="bg" id="lgTypeBtns">
          <button class="b on" data-lgtype="loop">LOOP</button>
          <button class="b" data-lgtype="song">SONG</button>
        </div>
        <!-- Loop length (shown for loop) -->
        <div id="lgLoopLenWrap" style="display:flex;align-items:center;gap:4px;margin-left:8px">
          <span class="lg-lbl">BARS</span>
          <select class="gen-bars-sel" id="lgLoopBars">
            <option value="4">4</option>
            <option value="6">6</option>
            <option value="8" selected>8</option>
            <option value="12">12</option>
            <option value="16">16</option>
            <option value="32">32</option>
          </select>
        </div>
        <!-- Song length (shown for song) -->
        <div id="lgSongLenWrap" style="display:none;align-items:center;gap:4px;margin-left:8px">
          <span class="lg-lbl">MINS</span>
          <select class="gen-bars-sel" id="lgSongMins">
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3" selected>3</option>
            <option value="4">4</option>
            <option value="5">5</option>
          </select>
        </div>
      </div>
      <!-- Complexity -->
      <div class="lg-row">
        <span class="lg-lbl">COMPLEXITY</span>
        <div class="complexity-dots" id="lgComplexityDots"></div>
        <span class="drum-ctrl-val" id="lgComplexityVal">3</span>
        <button class="b" id="lgJazzUpBtn">○ Jazz+</button>
      </div>
      <!-- Generated structure display -->
      <div id="lgStructure" style="margin:8px 0"></div>
      <!-- Chord editor / selected section chords -->
      <div id="lgChordEditor" style="display:none">
        <div class="sec-lbl" style="margin-bottom:4px" id="lgEditorTitle">CHORDS</div>
        <div class="gen-player-chords" id="lgEditorChords"></div>
      </div>
      <!-- Action buttons -->
      <div class="lg-btn-row">
        <button class="gen-btn" id="lgGenerateBtn">⚡ GENERATE</button>
        <button class="gen-btn" id="lgPlayBtn">▶ PLAY</button>
        <button class="gen-btn" id="lgLoopBtn">⟳ LOOP</button>
        <button class="gen-btn" id="lgShuffleBtn">⇌ SHUFFLE</button>
        <button class="gen-btn gen-btn-dl" id="lgDlBtn">⬇ MIDI</button>
      </div>
    </div>
  </div><!-- /loopGenPanel -->

  <!-- TUNER PANEL -->
  <div class="panel" id="tunerPanel" style="display:none">
    <div class="ph">
      <span class="ph-t">CHROMATIC TUNER</span>
      <span class="ph-r">A4 = 440 Hz</span>
    </div>
    <!-- Seismograph rolling waveform -->
    <div class="seismo-wrap">
      <canvas id="seismoCvs" style="min-height:120px"></canvas>
      <!-- Overlay: note + cents badge -->
      <div class="seismo-badge">
        <div class="seismo-note" id="seismoNote">--</div>
        <div class="seismo-oct" id="seismoOct"></div>
      </div>
      <div class="seismo-freq" id="seismoFreq">--- Hz</div>
    </div>
    <!-- Precision needle meter -->
    <div class="tmeter">
      <div class="mbar">
        <div class="mbar-c"></div>
        <div class="needle" id="needle"></div>
      </div>
      <div class="mlabels"><span>-50¢</span><span>-25¢</span><span>0</span><span>+25¢</span><span>+50¢</span></div>
      <div class="cdisp" id="cdisp">-- ¢</div>
      <div class="itlbl" id="itlbl">● IN TUNE ●</div>
    </div>
    <!-- Instrument / Tuning -->
    <div class="tun-wrap">
      <div class="tun-row">
        <span class="tun-lbl">INSTRUMENT</span>
        <select class="tun-sel" id="instrSel"></select>
      </div>
      <div class="tun-row">
        <span class="tun-lbl">TUNING</span>
        <select class="tun-sel" id="tuningSel"></select>
      </div>
      <div class="tun-strings" id="tuningStrings"></div>
    </div>

    <!-- hidden legacy IDs so pitch JS doesn't break -->
    <span id="noteD" style="display:none">--</span>
    <span id="octD"  style="display:none">OCT --</span>
    <span id="freqD" style="display:none">--- Hz</span>
    <span id="sf"    style="display:none">---</span>
    <span id="sa"    style="display:none">---</span>
    <span id="sc"    style="display:none">---</span>
  </div><!-- /tunerPanel -->

  <!-- METRONOME PANEL -->
  <div class="panel" id="metroPanel" style="display:none">
    <div class="ph">
      <span class="ph-t">METRONOME</span>
      <span class="ph-r">ADVANCED</span>
    </div>
    <div class="mbody">
      <div class="mrow mrow-swing">
        <span class="mlbl">SWING:</span>
        <div class="bg" id="swingBtns">
          <button class="b on" data-swing="0">Straight</button>
          <button class="b" data-swing="0.15">Swing</button>
        </div>
      </div>
      <div class="mrow mrow-beat">
        <span class="mlbl">TEMPO:</span>
        <div class="bg" id="beatBtns">
          <button class="b" data-beats="2">2/4</button>
          <button class="b on" data-beats="4">4/4</button>
          <button class="b" data-beats="3">3/4</button>
          <button class="b" data-beats="5">5/4</button>
          <button class="b" data-beats="6">6/8</button>
          <button class="b" data-beats="7">7/8</button>
        </div>
      </div>
      <div class="mrow mrow-sub">
        <span class="mlbl">SUBDIV:</span>
        <div class="bg" id="subBtns">
          <button class="b on" data-sub="1">♩</button>
          <button class="b" data-sub="2">♪♪</button>
          <button class="b" data-sub="3">Trip.</button>
          <button class="b" data-sub="4">16th</button>
        </div>
        <div class="sub-dots" id="subDots" style="margin-left:6px"></div>
      </div>
      <div class="beat-vis" id="beatVis"></div>
      <div class="acc-lbl">ACCENTS — click to toggle</div>
      <div class="acc-row" id="accRow"></div>
      <div style="font-size:10px;color:var(--t3);margin-bottom:6px;font-family:var(--mono)">CLICK SOUND</div>
      <div class="snd-grid">
        <button class="snd-b on" data-snd="click">CLICK</button>
        <button class="snd-b" data-snd="wood">WOOD</button>
        <button class="snd-b" data-snd="beep">BEEP</button>
        <button class="snd-b" data-snd="snap">SNAP</button>
      </div>
      <div class="vol-row">
        <span class="mlbl">VOLUME</span>
        <input type="range" class="sl" id="volSl" min="0" max="100" value="80" style="flex:1">
        <span style="font-size:10px;color:var(--t2);min-width:32px;text-align:right;font-family:var(--mono)" id="volLbl">80%</span>
      </div>
      <button class="play-b" id="playB">▶  START</button>
    </div>
  </div><!-- /metroPanel -->

  <!-- DRUM LOOPS PANEL -->
  <div class="panel" id="drumsPanel" style="display:none">
    <div class="ph">
      <span class="ph-t">DRUM LOOPS</span>
      <span class="ph-r" id="drumsStatusLbl">STOPPED</span>
    </div>
    <div class="drums-body">
      <div class="drum-genre-grid" id="drumGenreGrid"></div>
      <div class="drum-controls">
        <div class="drum-ctrl-row">
          <span class="drum-ctrl-lbl">LOOP</span>
          <div class="loop-len-btns" id="loopLenBtns">
            <button class="loop-len-btn" data-len="8">8</button>
            <button class="loop-len-btn on" data-len="16">16</button>
            <button class="loop-len-btn" data-len="32">32</button>
          </div>
        </div>
        <div class="drum-ctrl-row">
          <span class="drum-ctrl-lbl">COMPLEXITY</span>
          <div class="complexity-dots" id="complexityDots"></div>
          <span class="drum-ctrl-val" id="complexityVal">3</span>
        </div>
      </div>
      <div class="drum-grid" id="drumGrid"></div>
      <div class="drum-play-row">
        <button class="drum-play-btn" id="drumPlayBtn">▶  PLAY</button>
        <button class="drum-shuffle-btn" id="drumShuffleBtn" title="Generate new pattern">⇌ SHUFFLE</button>
        <button class="drum-dl-btn" id="drumDlBtn" title="Export as MIDI">⬇ MIDI</button>
      </div>
    </div>
  </div><!-- /drumsPanel -->

  <!-- INDIAN RHYTHMS PANEL -->
  <div class="panel" id="indianRhythmsPanel" style="display:none">
    <div class="ph">
      <span class="ph-t">INDIAN RHYTHMS</span>
      <span class="ph-r" id="irStatusLbl">STOPPED</span>
    </div>
    <div class="ir-body">
      <div class="ir-taal-grid" id="irTaalGrid"></div>
      <div class="ir-bols" id="irBolsRow">—</div>
      <div class="ir-vibhag" id="irVibhag"></div>
      <div class="ir-ctrl-row">
        <div class="bg" id="irSpeedBtns">
          <button class="b on" data-irspeed="1">1×</button>
          <button class="b" data-irspeed="2">2×</button>
          <button class="b" data-irspeed="4">4×</button>
        </div>
        <button class="ir-dl-btn" id="irDlBtn" title="Export as MIDI">⬇ MIDI</button>
      </div>
      <button class="ir-play-btn" id="irPlayBtn">▶  START TAAL</button>
    </div>
  </div><!-- /indianRhythmsPanel -->

</main>

<script>



// ════════════════════════════════════════════════
//  DARK MODE TOGGLE
// ════════════════════════════════════════════════
(function(){
  const btn   = document.getElementById('darkToggle');
  const icon  = document.getElementById('dtIcon');
  const label = document.getElementById('dtLabel');
  let dark = false;

  // Respect system preference on first load
  if(window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches){
    dark = true;
    document.body.classList.add('dark');
    icon.textContent  = '☀';
    label.textContent = 'LIGHT';
  }

  btn.addEventListener('click', () => {
    dark = !dark;
    document.body.classList.toggle('dark', dark);
    icon.textContent  = dark ? '☀' : '🌙';
    label.textContent = dark ? 'LIGHT' : 'DARK';
  });
})();

// ════════════════════════════════════════════════
//  PRACTICE STOPWATCH
// ════════════════════════════════════════════════
(function(){
  let swRunning = false, swElapsed = 0, swStart = 0, swTick = null;
  const swDisplay  = document.getElementById('swDisplay');
  const swStartBtn = document.getElementById('swStartBtn');
  const swResetBtn = document.getElementById('swResetBtn');

  function fmt(ms) {
    const s = Math.floor(ms / 1000);
    const h = Math.floor(s / 3600);
    const m = Math.floor((s % 3600) / 60);
    const sc = s % 60;
    return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(sc).padStart(2,'0')}`;
  }
  function tick() { swDisplay.textContent = fmt(swElapsed + (Date.now() - swStart)); }

  function startSw() {
    if (swRunning) return;
    swRunning = true; swStart = Date.now();
    swTick = setInterval(tick, 500);
    swDisplay.classList.remove('paused'); swDisplay.classList.add('running');
    swStartBtn.textContent = '⏸ PAUSE'; swStartBtn.className = 'sw-btn stop';
  }
  function pauseSw() {
    if (!swRunning) return;
    swRunning = false; swElapsed += Date.now() - swStart;
    clearInterval(swTick);
    swDisplay.classList.remove('running'); swDisplay.classList.add('paused');
    swStartBtn.textContent = '▶ RESUME'; swStartBtn.className = 'sw-btn start';
  }
  function resetSw() {
    pauseSw(); swElapsed = 0;
    swDisplay.textContent = '00:00:00';
    swDisplay.classList.remove('running','paused');
    swStartBtn.textContent = '▶ START'; swStartBtn.className = 'sw-btn start';
  }

  swStartBtn.addEventListener('click', () => swRunning ? pauseSw() : startSw());
  swResetBtn.addEventListener('click', resetSw);
  swDisplay.addEventListener('click',  () => swRunning ? pauseSw() : startSw());
})();

// ════════════════════════════════════════════════
//  AUDIO / MIC
// ════════════════════════════════════════════════
let aCtx=null, analyser=null, micSrc=null, micOn=false, animId=null, liveMode=false;
// Shared mic stream — cached to avoid repeated permission requests
let _sharedMicStream = null;
let _micPermissionGranted = false;
let _preferredAudioDeviceId = null;

const NOTES=['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];

function f2n(freq){
  if(freq<20)return null;
  const semi=12*Math.log2(freq/440), ni=Math.round(semi)+69;
  const note=NOTES[((ni%12)+12)%12], oct=Math.floor(ni/12)-1;
  const exact=440*Math.pow(2,(ni-69)/12), cents=1200*Math.log2(freq/exact);
  return{note,oct,cents};
}

async function _getSharedMicStream(deviceId){
  // If we already have a live stream with the same device, reuse it
  if(_sharedMicStream && !deviceId){
    const tracks = _sharedMicStream.getTracks();
    if(tracks.length && tracks[0].readyState === 'live') return _sharedMicStream;
  }
  // Stop existing stream if switching device
  if(_sharedMicStream && deviceId){
    _sharedMicStream.getTracks().forEach(t=>t.stop());
    _sharedMicStream = null;
  }
  const constraints = {audio:{echoCancellation:false,noiseSuppression:false,autoGainControl:false}};
  if(deviceId) constraints.audio.deviceId = {exact: deviceId};
  _sharedMicStream = await navigator.mediaDevices.getUserMedia(constraints);
  _micPermissionGranted = true;
  return _sharedMicStream;
}

async function startMic(deviceId){
  try{
    const stream = await _getSharedMicStream(deviceId || _preferredAudioDeviceId || null);
    aCtx = aCtx || new(window.AudioContext||window.webkitAudioContext)();
    if(aCtx.state === 'suspended') await aCtx.resume();
    // Disconnect old source if any
    try{ if(micSrc) micSrc.disconnect(); }catch(e){}
    analyser = aCtx.createAnalyser(); analyser.fftSize=16384; analyser.smoothingTimeConstant=0.8;
    micSrc = aCtx.createMediaStreamSource(stream); micSrc.connect(analyser);
    micOn=true; liveMode=true;
    document.getElementById('mic-dot').classList.add('on');
    document.getElementById('micBtn').classList.add('act');
    document.getElementById('micBtnTxt').textContent='MIC ON';
    updateListeningState();
    startViz();
  }catch(e){
    console.warn('Microphone error:', e);
    if(e.name === 'NotAllowedError' || e.name === 'PermissionDeniedError'){
      alert('Microphone permission denied. Please allow microphone access in your browser settings.');
    }
  }
}
function stopMic(){
  micOn=false; liveMode=false;
  if(animId)cancelAnimationFrame(animId); animId=null;
  // Disconnect analyser but keep stream alive (avoid re-requesting permission)
  try{ if(micSrc){ micSrc.disconnect(); micSrc=null; } }catch(e){}
  analyser=null;
  document.getElementById('mic-dot').classList.remove('on');
  document.getElementById('micBtn').classList.remove('act');
  document.getElementById('micBtnTxt').textContent='MIC';
  // Reset smoothing state for clean restart
  freqEMA = null; centsEMA = 0; pitchHistory = []; centsHistory = [];
  // Stop all listening indicators
  updateListeningState();
  // Clear note detection displays
  const genNote = document.getElementById('genDetectNote');
  const genDot  = document.getElementById('genDetectDot');
  if(genNote) genNote.textContent = '--';
  if(genDot)  genDot.classList.remove('active');
  document.querySelectorAll('.sn.det').forEach(e => e.classList.remove('det'));
  document.querySelectorAll('.mnt.det').forEach(e => e.classList.remove('det'));
  // Resume idle canvas loop
  if(typeof window._restartIdleLoop==='function') window._restartIdleLoop();
}
document.getElementById('micBtn').addEventListener('click',()=>micOn?stopMic():startMic());


// ════════════════════════════════════════════════
//  OSCILLOSCOPE RING BUFFER
// ════════════════════════════════════════════════
const oscCvs=document.getElementById('oscCvs');
const oscCtx=oscCvs ? oscCvs.getContext('2d') : null;
const specCvs=document.getElementById('specCvs');
const specCtx=specCvs ? specCvs.getContext('2d') : null;

const RING_CAP=1000000; // ~20s at 48kHz
const ringBuf=new Float32Array(RING_CAP);
let ringHead=0, ringCount=0, ringSR=44100, lastRingSamp=0;

let timeWin=5, vZoom=4.0;

// Resize canvases to physical pixels for sharpness
function resizeCanvases(){
  const dpr=window.devicePixelRatio||1;
  const ow=oscCvs.offsetWidth, oh=oscCvs.offsetHeight;
  if(oscCvs.width!==ow*dpr||oscCvs.height!==oh*dpr){
    oscCvs.width=ow*dpr; oscCvs.height=oh*dpr;
    oscCtx.setTransform(1,0,0,1,0,0); oscCtx.scale(dpr,dpr);
  }
  const sw=specCvs.offsetWidth, sh=specCvs.offsetHeight;
  if(specCvs.width!==sw*dpr||specCvs.height!==sh*dpr){
    specCvs.width=sw*dpr; specCvs.height=sh*dpr;
    specCtx.setTransform(1,0,0,1,0,0); specCtx.scale(dpr,dpr);
  }
}
window.addEventListener('resize',()=>{ resizeCanvases(); buildXRow(); });
setTimeout(()=>{ resizeCanvases(); buildXRow(); }, 80);

// Window/zoom button wiring
document.getElementById('winBtns').addEventListener('click',e=>{
  const w=parseFloat(e.target.dataset.w); if(!w)return;
  timeWin=w;
  document.querySelectorAll('#winBtns .b').forEach(b=>b.classList.toggle('on',parseFloat(b.dataset.w)===w));
  document.getElementById('winLbl').textContent=w+'s WINDOW';
  buildXRow();
});
document.getElementById('vzBtns').addEventListener('click',e=>{
  const z=parseFloat(e.target.dataset.z); if(!z)return;
  vZoom=z;
  document.querySelectorAll('#vzBtns .b').forEach(b=>b.classList.toggle('on',parseFloat(b.dataset.z)===z));
});

function buildXRow(){
  const row=document.getElementById('xrow'); row.innerHTML='';
  const steps=5; // always 5 divisions for 5/10/15s windows
  for(let i=0;i<=steps;i++){
    const t=document.createElement('span');
    const sec=-(timeWin - i*(timeWin/steps));
    t.textContent = sec===0?'now': sec.toFixed(0)+'s';
    row.appendChild(t);
  }
}

// ── Draw grid + dB labels INSIDE canvas ──────────
function drawOscGrid(ctx,w,h){
  const dark=document.body.classList.contains('dark');
  ctx.fillStyle=dark?'#0f0d09':'#f9f6ee'; ctx.fillRect(0,0,w,h);
  ctx.strokeStyle=dark?'rgba(200,175,130,0.08)':'rgba(55,40,20,0.055)';
  ctx.lineWidth=1; ctx.setLineDash([]);
  const divs=5;
  for(let i=1;i<divs;i++){
    const x=Math.round(w/divs*i);
    ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,h); ctx.stroke();
  }
  const dbMarks=[-6,-12,-18,-24];
  ctx.setLineDash([4,7]); ctx.lineWidth=0.8;
  ctx.font='9px Helvetica Neue, Helvetica, Arial, sans-serif';
  dbMarks.forEach(db=>{
    const amp=Math.pow(10,db/20)*vZoom;
    const yTop=h*(0.5-amp*0.5), yBot=h*(0.5+amp*0.5);
    ctx.strokeStyle=dark?'rgba(200,175,130,0.13)':'rgba(55,40,20,0.12)';
    if(yTop>=0&&yTop<=h){
      ctx.beginPath(); ctx.moveTo(0,yTop); ctx.lineTo(w,yTop); ctx.stroke();
      ctx.fillStyle=dark?'rgba(212,168,68,0.6)':'rgba(55,40,20,0.32)';
      ctx.fillText(db+'dB',4,yTop-2);
    }
    if(yBot>=0&&yBot<=h){
      ctx.beginPath(); ctx.moveTo(0,yBot); ctx.lineTo(w,yBot); ctx.stroke();
    }
  });
  ctx.setLineDash([]);
  ctx.strokeStyle=dark?'rgba(212,168,68,0.35)':'rgba(55,40,20,0.30)'; ctx.lineWidth=1.2;
  ctx.beginPath(); ctx.moveTo(0,h/2); ctx.lineTo(w,h/2); ctx.stroke();
  ctx.fillStyle=dark?'rgba(212,168,68,0.65)':'rgba(55,40,20,0.40)';
  ctx.font='9px Helvetica Neue, Helvetica, Arial, sans-serif';
  ctx.fillText('0 dB',4,h/2-3);
  ctx.lineWidth=1;
}

function logX(freq,w,sr){
  const nyq=sr/2; if(freq<20)return 0;
  return(Math.log2(freq/20)/Math.log2(nyq/20))*w;
}

function drawSpecGrid(ctx,w,h,sr){
  const dark=document.body.classList.contains('dark');
  ctx.fillStyle=dark?'#0f0d09':'#f9f6ee'; ctx.fillRect(0,0,w,h);
  const flines=[20,30,50,70,100,150,200,300,500,700,1000,1500,2000,3000,5000,7000,10000,15000,20000];
  const majF=new Set([20,100,500,1000,5000,20000]);
  ctx.lineWidth=0.8;
  flines.forEach(f=>{
    const x=logX(f,w,sr||44100); if(x<0||x>w)return;
    ctx.strokeStyle=dark
      ? (majF.has(f)?'rgba(200,175,130,0.18)':'rgba(200,175,130,0.06)')
      : (majF.has(f)?'rgba(55,40,20,0.15)':'rgba(55,40,20,0.05)');
    ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,h); ctx.stroke();
  });
  [0,.25,.5,.75].forEach((v,i)=>{
    const y=Math.round(h*v);
    ctx.strokeStyle=dark
      ?(i===0?'rgba(200,175,130,0.18)':'rgba(200,175,130,0.06)')
      :(i===0?'rgba(55,40,20,0.12)':'rgba(55,40,20,0.05)');
    ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(w,y); ctx.stroke();
  });
  ctx.fillStyle=dark?'rgba(212,168,68,0.55)':'rgba(55,40,20,0.30)';
  ctx.font='9px Helvetica Neue, Helvetica, Arial, sans-serif'; ctx.textAlign='right';
  ['0dB','-24','-48','-72'].forEach((d,i)=>ctx.fillText(d,w-3,h*i*0.25+9));
  ctx.textAlign='left';
}

function drawIdle(){
  const dark=document.body.classList.contains('dark');
  const w=oscCvs.offsetWidth, h=oscCvs.offsetHeight;
  drawOscGrid(oscCtx,w,h);
  oscCtx.strokeStyle=dark?'rgba(200,175,130,0.12)':'rgba(55,40,20,0.14)'; oscCtx.lineWidth=0.8;
  oscCtx.beginPath();
  for(let i=0;i<w;i++){ const y=h/2+(Math.random()-0.5)*0.4; i===0?oscCtx.moveTo(i,y):oscCtx.lineTo(i,y); }
  oscCtx.stroke();
  const sw=specCvs.offsetWidth, sh=specCvs.offsetHeight;
  drawSpecGrid(specCtx,sw,sh,44100);
}

// ── Main visualiser loop ──────────────────────
function startViz(){
  const td=new Float32Array(analyser.fftSize);
  const fd=new Uint8Array(analyser.frequencyBinCount);
  const sr=aCtx.sampleRate; ringSR=sr;

  function draw(){
    if(!micOn){ drawIdle(); return; }
    animId=requestAnimationFrame(draw);
    analyser.getFloatTimeDomainData(td);
    analyser.getByteFrequencyData(fd);

    // Write ONLY NEW samples into ring buffer.
    // The analyser buffer overlaps heavily between frames (at 60fps, only
    // ~735 new samples arrive per 16ms frame at 44.1kHz, but fftSize=16384).
    // We track how many samples have elapsed since last write via AudioContext time.
    const nowSamp=Math.round(aCtx.currentTime*sr);
    const newSamps=Math.min(td.length, nowSamp-lastRingSamp);
    if(newSamps>0){
      const startOff=td.length-newSamps; // the freshest 'newSamps' samples are at the tail
      for(let i=startOff;i<td.length;i++){
        ringBuf[ringHead]=td[i];
        ringHead=(ringHead+1)%RING_CAP;
        if(ringCount<RING_CAP)ringCount++;
      }
      lastRingSamp=nowSamp;
    }

    // ── OSCILLOSCOPE ──
    resizeCanvases();
    {
      const w=oscCvs.offsetWidth, h=oscCvs.offsetHeight;
      drawOscGrid(oscCtx,w,h);

      // ── FIXED: display exactly the last timeWin seconds as a scrolling trace ──
      // We take only wantSamp samples ending at ringHead (the most recent).
      // Each pixel maps to exactly (wantSamp/w) samples — no overlap, no repeat.
      const wantSamp=Math.max(1,Math.round(timeWin*sr));
      const avail=Math.min(wantSamp,ringCount);

      const dark=document.body.classList.contains('dark');

      // Transient detection: compare RMS of recent 10ms vs previous 50ms
      let recentRMS = 0, prevRMS = 0, transient = false;
      {
        const recentN = Math.min(Math.round(0.01*sr), avail);
        const prevN   = Math.min(Math.round(0.05*sr), avail - recentN);
        for(let s=avail-recentN; s<avail; s++){
          const idx=((ringHead-avail+s)%RING_CAP+RING_CAP)%RING_CAP;
          recentRMS += ringBuf[idx]*ringBuf[idx];
        }
        recentRMS = Math.sqrt(recentRMS/Math.max(1,recentN));
        for(let s=avail-recentN-prevN; s<avail-recentN; s++){
          const idx=((ringHead-avail+s)%RING_CAP+RING_CAP)%RING_CAP;
          prevRMS += ringBuf[idx]*ringBuf[idx];
        }
        prevRMS = Math.sqrt(prevRMS/Math.max(1,prevN));
        transient = recentRMS > prevRMS * 2.5 && recentRMS > 0.04;
      }

      // Single continuous path: one sample per pixel, multicolor by amplitude
      for(let px=0;px<w;px++){
        const frac0= px/w;
        const frac1=(px+1)/w;
        const s0=Math.floor(frac0*avail);
        const s1=Math.min(Math.floor(frac1*avail), avail-1);
        let mn=0, mx2=0, sum=0, cnt=0;
        for(let s=s0;s<=s1;s++){
          const idx=((ringHead - avail + s)%RING_CAP+RING_CAP)%RING_CAP;
          const v=ringBuf[idx]*vZoom;
          sum+=v; cnt++;
          if(v<mn)mn=v; if(v>mx2)mx2=v;
        }
        const mid=cnt>0?sum/cnt:0;
        const yMid=Math.max(0,Math.min(h, h*(0.5-mid*0.5)));
        const yT  =Math.max(0,Math.min(h, h*(0.5-mx2*0.5)));
        const yB  =Math.max(0,Math.min(h, h*(0.5-mn*0.5)));
        const amp = Math.abs(mid);

        // Multicolor: low amp=green, mid=yellow/ochre, high/transient=red
        let color;
        if(transient && amp > 0.3){
          color = dark ? 'rgba(240,80,60,0.95)' : 'rgba(200,40,20,0.9)';
        } else if(amp > 0.5){
          color = dark ? 'rgba(240,168,48,0.92)' : 'rgba(180,80,10,0.85)';
        } else if(amp > 0.15){
          color = dark ? 'rgba(212,200,60,0.85)' : 'rgba(100,120,20,0.8)';
        } else {
          color = dark ? 'rgba(94,196,122,0.80)' : 'rgba(28,90,40,0.75)';
        }

        oscCtx.beginPath();
        oscCtx.strokeStyle = color;
        oscCtx.lineWidth = transient && amp > 0.3 ? 2.0 : 1.5;
        oscCtx.moveTo(px+0.5,yMid);
        if(yB-yT>1.5){
          oscCtx.lineTo(px+0.5,yT); oscCtx.moveTo(px+0.5,yB); oscCtx.lineTo(px+0.5,yMid);
        }
        oscCtx.stroke();
      }

      // ── SPECTRUM ──
      const sw=specCvs.offsetWidth, sh=specCvs.offsetHeight;
      const darkMode=document.body.classList.contains('dark');
      drawSpecGrid(specCtx,sw,sh,sr);
      for(let i=1;i<fd.length;i++){
        const freq=(i/fd.length)*(sr/2);
        if(freq<20||freq>20000)continue;
        const x1=logX(freq,sw,sr), x2=logX(((i+1)/fd.length)*(sr/2),sw,sr);
        const bw=Math.max(1,x2-x1), v=fd[i]/255, bh=v*sh;
        if(darkMode){
          // amber-amber-on-dark
          const L=Math.round(18+v*50), S=Math.round(60+v*20);
          specCtx.fillStyle=`hsla(32,${S}%,${L}%,${0.55+v*0.45})`;
        } else {
          const lig=Math.round(62-v*50), sat=Math.round(20+v*15);
          specCtx.fillStyle=`hsla(28,${sat}%,${lig}%,${0.5+v*0.5})`;
        }
        specCtx.fillRect(x1,sh-bh,bw,bh);
      }
    }

    // ── PITCH + SPL ──
    const pitch=detectPitch(td,sr);
    let rms2=0; for(let i=0;i<td.length;i++)rms2+=td[i]*td[i]; rms2=Math.sqrt(rms2/td.length);
    const dbV=rms2>0?20*Math.log10(rms2):-100;
    if(window._checkMetroTransient) window._checkMetroTransient(rms2);

    updateSPL(dbV);

    if(pitch && pitch.clarity > 0.88 && pitch.freq > 40 && pitch.freq < 1500){
      const smoothedFreq = smoothPitch(pitch.freq);
      const n = f2n(smoothedFreq);
      if(n){ updateTuner(n, smoothedFreq); hlNote(n.note); }
    } else {
      pushSeismo(0, false);
    }
    drawSeismo();
  }
  draw();
}

// ── Improved YIN pitch detector with smoothing ────────────
// Uses autocorrelation with parabolic interpolation + median smoothing
const PITCH_BUF_LEN = 10;
let pitchHistory = [], centsHistory = [], lastGoodPitch = null;

function detectPitch(buf, sr) {
  const SZ = Math.min(buf.length, 4096); // analyse only 4096 samples for speed
  const src = buf.subarray(buf.length - SZ);
  let rms = 0;
  for (let i = 0; i < SZ; i++) rms += src[i] * src[i];
  rms = Math.sqrt(rms / SZ);
  if (rms < 0.008) return null; // silence threshold

  const HF = Math.floor(SZ / 2);
  // Compute difference function (YIN)
  const d = new Float32Array(HF);
  for (let tau = 0; tau < HF; tau++) {
    let s = 0;
    for (let j = 0; j < HF; j++) { const diff = src[j] - src[j + tau]; s += diff * diff; }
    d[tau] = s;
  }
  // Cumulative mean normalised difference
  const cd = new Float32Array(HF);
  cd[0] = 1; let sum = 0;
  for (let tau = 1; tau < HF; tau++) { sum += d[tau]; cd[tau] = d[tau] / (sum / tau); }

  // Find first dip below threshold
  const threshold = 0.15;
  let tau = 2;
  while (tau < HF - 1) {
    if (cd[tau] < threshold) {
      while (tau + 1 < HF - 1 && cd[tau + 1] < cd[tau]) tau++;
      break;
    }
    tau++;
  }
  if (tau >= HF - 1 || cd[tau] > 0.2) return null;

  // Parabolic interpolation for sub-sample accuracy
  const x0 = cd[tau - 1], x1 = cd[tau], x2 = cd[tau + 1];
  const denom = 2 * x1 - x0 - x2;
  const refined = denom !== 0 ? tau + (x2 - x0) / (2 * denom) : tau;
  const freq = sr / refined;
  if (freq < 40 || freq > 1500) return null;

  const clarity = 1 - cd[tau];
  return { freq, clarity };
}

// Smooth pitch via median of last N good readings
// Exponential moving average for frequency — much smoother than median
let freqEMA = null;
const FREQ_ALPHA = 0.15; // lower = smoother, higher = more responsive

function smoothPitch(freq) {
  if(freqEMA === null) freqEMA = freq;
  // Only update if within 2 semitones of current EMA (reject octave errors)
  const ratio = freq / freqEMA;
  if(ratio > 0.5 && ratio < 2.0) {
    freqEMA = FREQ_ALPHA * freq + (1 - FREQ_ALPHA) * freqEMA;
  } else {
    // Big jump — snap to new pitch slowly
    freqEMA = 0.4 * freq + 0.6 * freqEMA;
  }
  return freqEMA;
}

let centsEMA = 0;
const CENTS_ALPHA = 0.12; // very smooth cents for needle stability

function smoothCents(c) {
  centsEMA = CENTS_ALPHA * c + (1 - CENTS_ALPHA) * centsEMA;
  return centsEMA;
}

// ── Seismograph canvas ────────────────────────
const seismoCvs = document.getElementById('seismoCvs');
const seismoCtx = seismoCvs ? seismoCvs.getContext('2d') : null;
// Rolling waveform: store last N scaled-amplitude points
const SEISMO_LEN = 300;
let seismoData = new Float32Array(SEISMO_LEN); // cents deviation, range -50..+50
let seismoIdx = 0, seismoActive = false;
let seismoColor = '#888';

function drawSeismo() {
  if (!seismoCtx) return;
  const dpr = window.devicePixelRatio || 1;
  const W = seismoCvs.offsetWidth, H = seismoCvs.offsetHeight;
  if (!W || !H) return;
  if (seismoCvs.width !== W * dpr || seismoCvs.height !== H * dpr) {
    seismoCvs.width = W * dpr; seismoCvs.height = H * dpr;
    seismoCtx.setTransform(1, 0, 0, 1, 0, 0); seismoCtx.scale(dpr, dpr);
  }
  const dark = document.body.classList.contains('dark');

  // Background
  seismoCtx.fillStyle = dark ? '#0f0d09' : '#f5f1e8';
  seismoCtx.fillRect(0, 0, W, H);

  // Zone bands — subtle colour fields: ±5¢ = green, ±15¢ = amber, outside = red
  const zoneAlpha = 0.06;
  const tune5  = (5  / 50) * (H / 2);
  const tune15 = (15 / 50) * (H / 2);
  seismoCtx.fillStyle = `rgba(${dark?'94,196,122':'45,90,61'},${zoneAlpha*1.5})`;
  seismoCtx.fillRect(0, H/2 - tune5, W, tune5 * 2);
  seismoCtx.fillStyle = `rgba(${dark?'216,168,64':'122,85,21'},${zoneAlpha})`;
  seismoCtx.fillRect(0, H/2 - tune15, W, tune15 * 2);

  // Zone tick lines at ±5, ±15, ±25, ±50¢
  [5, 15, 25, 50].forEach(c => {
    const yOff = (c / 50) * (H / 2);
    seismoCtx.strokeStyle = dark ? 'rgba(200,175,130,0.08)' : 'rgba(55,40,20,0.07)';
    seismoCtx.lineWidth = 0.5; seismoCtx.setLineDash([3, 6]);
    [H/2 - yOff, H/2 + yOff].forEach(y => {
      seismoCtx.beginPath(); seismoCtx.moveTo(0, y); seismoCtx.lineTo(W, y); seismoCtx.stroke();
    });
  });
  seismoCtx.setLineDash([]);

  // Centre line (0¢)
  seismoCtx.strokeStyle = dark ? 'rgba(200,175,130,0.20)' : 'rgba(55,40,20,0.15)';
  seismoCtx.lineWidth = 1;
  seismoCtx.beginPath(); seismoCtx.moveTo(0, H / 2); seismoCtx.lineTo(W, H / 2); seismoCtx.stroke();

  // Draw rolling waveform — gradient stroke based on deviation
  seismoCtx.lineWidth = 2;
  seismoCtx.lineJoin = 'round';
  seismoCtx.lineCap = 'round';
  seismoCtx.shadowBlur = seismoActive ? 6 : 0;
  seismoCtx.shadowColor = seismoColor;
  seismoCtx.beginPath();
  let first = true;
  for (let i = 0; i < SEISMO_LEN; i++) {
    const idx = (seismoIdx + i) % SEISMO_LEN;
    const v = seismoData[idx]; // cents, -50..+50
    // Fade out older points slightly
    const age = i / SEISMO_LEN;
    const x = age * W;
    const y = H / 2 - (v / 50) * (H / 2 - 5);
    if (first) { seismoCtx.moveTo(x, y); first = false; }
    else seismoCtx.lineTo(x, y);
  }
  seismoCtx.strokeStyle = seismoColor;
  seismoCtx.stroke();
  seismoCtx.shadowBlur = 0;

  // Scan line (writing head)
  const scanX = ((seismoIdx) / SEISMO_LEN) * W;
  seismoCtx.strokeStyle = dark ? 'rgba(200,175,130,0.35)' : 'rgba(55,40,20,0.25)';
  seismoCtx.lineWidth = 1; seismoCtx.setLineDash([2, 4]);
  seismoCtx.beginPath(); seismoCtx.moveTo(scanX, 0); seismoCtx.lineTo(scanX, H);
  seismoCtx.stroke(); seismoCtx.setLineDash([]);
}

// Push a cents value into the seismograph ring buffer each frame
function pushSeismo(cents, active) {
  seismoActive = active;
  seismoData[seismoIdx] = active ? cents : 0;
  seismoIdx = (seismoIdx + 1) % SEISMO_LEN;
}

function updateTuner(n, freq) {
  // Smooth the cents value
  const rawC = Math.max(-50, Math.min(50, n.cents));
  const c = smoothCents(rawC);
  // Seismograph badge
  if (seismoCvs) {
    document.getElementById('seismoNote').textContent = n.note.replace('#', '♯');
    document.getElementById('seismoOct').textContent  = 'oct ' + n.oct;
    document.getElementById('seismoFreq').textContent = freq.toFixed(1) + ' Hz';
    // Update osc note badge
    const oscBadge = document.getElementById('oscNoteBadge');
    if(oscBadge){
      oscBadge.textContent = n.note.replace('#','♯') + n.oct + ' · ' + freq.toFixed(0) + 'Hz';
      oscBadge.style.display = '';
    }
    // Update generator detect bar
    const genNote = document.getElementById('genDetectNote');
    const genDot  = document.getElementById('genDetectDot');
    if(genNote){ genNote.textContent = n.note.replace('#','♯') + n.oct; }
    if(genDot)  { genDot.classList.add('active'); }
    // Color by in-tune-ness
    const dark = document.body.classList.contains('dark');
    if (Math.abs(c) < 5)       seismoColor = dark ? '#5ec47a' : '#2d5a3d';
    else if (Math.abs(c) < 15) seismoColor = dark ? '#d8a840' : '#7a5515';
    else                       seismoColor = dark ? '#e07060' : '#7a3020';
    pushSeismo(c, true);
  }
  // Legacy needle
  document.getElementById('needle').style.left = (50 + (c / 50) * 47) + '%';
  document.getElementById('cdisp').textContent = (c >= 0 ? '+' : '') + c.toFixed(1) + ' ¢';
  const nd = document.getElementById('needle'), it = document.getElementById('itlbl');
  nd.className = 'needle';
  if (Math.abs(c) < 5)  { nd.classList.add('intune'); it.classList.add('on'); }
  else if (c < 0) { nd.classList.add('flat'); it.classList.remove('on'); }
  else            { nd.classList.add('sharp'); it.classList.remove('on'); }
}

function hlNote(name){
  // Scale view: .sn elements
  document.querySelectorAll('.sn').forEach(e=>e.classList.toggle('det',e.dataset.note===name&&!e.classList.contains('root')));
  // Modes view: .mnt elements
  document.querySelectorAll('.mnt').forEach(e=>e.classList.toggle('det',e.textContent.trim().replace('♯','#')===name&&!e.classList.contains('mr')));
  // Thaat view: .tn elements
  document.querySelectorAll('.tn').forEach(e=>{
    const txt = e.firstChild?.textContent?.trim().replace('♯','#');
    e.classList.toggle('det', txt===name && !e.classList.contains('sa'));
  });
}

// Idle loop — only drives canvas when mic is OFF
// When mic is ON, startViz() drives all updates instead.
(function kickIdleLoop(){
  function idleLoop(){
    if (!micOn) {
      drawIdle();
      pushSeismo(0, false);
      drawSeismo();
      requestAnimationFrame(idleLoop);
    }
    // else: micOn=true, startViz's rAF loop is running — we stop here
  }
  idleLoop();
  window._restartIdleLoop = idleLoop; // called by stopMic to resume
})();

// ── PANEL RESIZE — dedicated drag handle appended to each panel ──
(function initResize(){
  let resizing = null;

  function attachResize(el) {
    // Avoid double-attaching
    if(el.querySelector('.resize-handle')) return;
    const handle = document.createElement('div');
    handle.className = 'resize-handle';
    handle.title = 'Drag to resize';
    el.appendChild(handle);

    handle.addEventListener('mousedown', e=>{
      e.preventDefault(); e.stopPropagation();
      resizing = { el, startX: e.clientX, startY: e.clientY,
                   startW: el.offsetWidth, startH: el.offsetHeight };
      el.classList.add('resizing');
    });
    handle.addEventListener('touchstart', e=>{
      e.preventDefault(); e.stopPropagation();
      const t = e.touches[0];
      resizing = { el, startX: t.clientX, startY: t.clientY,
                   startW: el.offsetWidth, startH: el.offsetHeight };
      el.classList.add('resizing');
    }, { passive: false });
  }

  function onMove(e) {
    if (!resizing) return;
    e.preventDefault();
    const cx = e.touches ? e.touches[0].clientX : e.clientX;
    const cy = e.touches ? e.touches[0].clientY : e.clientY;
    const newW = Math.max(260, resizing.startW + cx - resizing.startX);
    const newH = Math.max(120, resizing.startH + cy - resizing.startY);
    resizing.el.style.width  = newW + 'px';
    resizing.el.style.height = newH + 'px';
    setTimeout(resizeCanvases, 10);
  }
  function onUp() {
    if (resizing) { resizing.el.classList.remove('resizing'); resizing = null; }
  }

  document.querySelectorAll('.panel, .spl-panel').forEach(attachResize);
  const obs = new MutationObserver(muts => {
    muts.forEach(m => m.addedNodes.forEach(n => {
      if (n.nodeType === 1) {
        if (n.matches('.panel, .spl-panel')) attachResize(n);
        n.querySelectorAll && n.querySelectorAll('.panel, .spl-panel').forEach(attachResize);
      }
    }));
  });
  obs.observe(document.getElementById('panelGrid'), { childList: true, subtree: true });

  window.addEventListener('mousemove', onMove);
  window.addEventListener('mouseup',   onUp);
  window.addEventListener('touchmove', onMove, { passive: false });
  window.addEventListener('touchend',  onUp);
})();


// ── Build SPL tick marks — SPL scale 0–120 dB
(function buildSPLTicks(){
  const ticks=document.getElementById('splTicks');
  if(!ticks)return;
  const marks=[0,20,40,60,80,100,120];
  marks.forEach(db=>{
    const pct=(db/120)*100;
    const t=document.createElement('div');
    t.className='spl-tick';
    t.style.left=pct+'%';
    t.textContent=db;
    ticks.appendChild(t);
  });
})();

// SPL reference zones (estimated SPL: 0–120 dB)
// dBFS → SPL: SPL ≈ dbFS + 94 (0 dBFS ≈ 94 dBSPL for 1Pa reference)
// We display as positive SPL
const SPL_REFS=[
  {min:0,  max:40,  label:'🤫 Very Quiet',     cls:''},
  {min:40, max:60,  label:'📚 Library / Quiet', cls:''},
  {min:60, max:75,  label:'🏠 Conversation',    cls:''},
  {min:75, max:90,  label:'🎸 Rehearsal / Band',cls:''},
  {min:90, max:105, label:'🔊 Concert / Club',  cls:'warn'},
  {min:105,max:120, label:'🏟 Loud · ⚠ Protect ears', cls:'danger'},
];

// Offset to convert raw dBFS to estimated SPL
const SPL_OFFSET = 94; // dBFS + 94 ≈ dBSPL

let splPeak=0, splPeakSPL=0, splPeakTimer=null;

function dbfsToSPL(dbfs){ return Math.max(0, Math.min(120, dbfs + SPL_OFFSET)); }

function updateSPL(dbV){
  const el=document.getElementById('splVal');
  const refLbl=document.getElementById('splRefLbl');
  const fill=document.getElementById('splFill');
  const peakMark=document.getElementById('splPeakMark');
  const peakLbl=document.getElementById('splPeakLbl');
  if(!el)return;

  const spl = dbfsToSPL(dbV);

  if(dbV<=-99){
    el.textContent='---'; el.className='spl-val';
    refLbl.textContent='no signal';
    fill.style.width='100%';
    peakMark.style.left='0%';
    document.querySelectorAll('.spl-ref-tag').forEach(t=>t.classList.remove('active-ref'));
    return;
  }

  const pct=(spl/120)*100; // 0% = 0 dBSPL, 100% = 120 dBSPL
  el.textContent=Math.round(spl);

  // Colour and label by zone
  let zone=SPL_REFS[0];
  for(const r of SPL_REFS){ if(spl>=r.min && spl<r.max){ zone=r; break; } }
  el.className='spl-val '+(zone.cls||'');
  refLbl.textContent=zone.label;

  // Bar fill: right-side mask
  fill.style.width=(100-pct)+'%';

  // Active ref tag highlight (tags use SPL values now)
  document.querySelectorAll('.spl-ref-tag').forEach(t=>{
    const tMin=parseFloat(t.dataset.min), tMax=parseFloat(t.dataset.max);
    t.classList.toggle('active-ref', spl>=tMin && spl<tMax);
  });

  // Peak hold (5s decay)
  if(spl>splPeakSPL){
    splPeakSPL=spl;
    clearTimeout(splPeakTimer);
    splPeakTimer=setTimeout(()=>{ splPeakSPL=0; }, 5000);
  }
  const peakPct=(splPeakSPL/120)*100;
  peakMark.style.left=Math.max(0,Math.min(99,peakPct-0.15))+'%';
  if(peakLbl) peakLbl.textContent=`Peak: ${splPeakSPL>0?Math.round(splPeakSPL)+' dB':'---'}`;
}





// ════════════════════════════════════════════════
//  THEORY ENGINE
// ════════════════════════════════════════════════
const CHR=['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
const MAJ=[0,2,4,5,7,9,11];

const D3Q=['maj','min','min','maj','dom','min','dim'];
const D4Q=['maj7','min7','min7','maj7','dom7','min7','m7b5'];
const DROM=['I','ii','iii','IV','V','vi','vii°'];
const DROMF=['I — Tonic','ii — Supertonic','iii — Mediant','IV — Subdominant','V — Dominant','vi — Submediant','vii° — Leading Tone'];
const DFUNC=['Tonic','Supertonic','Mediant','Subdominant','Dominant','Submediant','Leading Tone'];
const DMOOD=['Home · stable rest','Soft tension · movement','Colour chord · mediant','Upward lift · subdominant','Strong tension · resolves to I','Relative minor · warmth','Unstable · wants resolution'];

const QI={maj:[0,4,7],min:[0,3,7],dom:[0,4,7,10],dim:[0,3,6],aug:[0,4,8],maj7:[0,4,7,11],min7:[0,3,7,10],dom7:[0,4,7,10],m7b5:[0,3,6,10]};
const QL={maj:'Major',min:'Minor',dom:'Dom7',dim:'Dim',aug:'Aug',maj7:'Maj7',min7:'Min7',dom7:'Dom7',m7b5:'m7♭5'};

let cRoot='C', cView='chords', use4=false, indianMode=false;
let dcLit=new Set(), openScale=null, openMode=null, openThaat=null;

function na(root,s){ return CHR[(CHR.indexOf(root)+s+120)%12]; }
function cn(root,q){ return (QI[q]||[0,4,7]).map(i=>na(root,i)); }
function cs(root,q){
  const m={maj:'',min:'m',dom:'7',dim:'°',aug:'+',maj7:'maj7',min7:'m7',dom7:'7',m7b5:'m7♭5'};
  return root+(m[q]??'');
}

function scaleChords(rootNote,ivArr,force4){
  const ivs=[...ivArr]; while(ivs.length<7)ivs.push((ivs[ivs.length-1]+2)%12);
  return ivs.slice(0,7).map((iv,i)=>{
    const cr=na(rootNote,iv);
    const t3=(ivs[(i+2)%7]-iv+12)%12;
    const t5=(ivs[(i+4)%7]-iv+12)%12;
    let q='maj';
    if(t3===3&&t5===7)q='min';
    else if(t3===3&&t5===6)q='dim';
    else if(t3===4&&t5===8)q='aug';
    if(force4){
      const t7=(ivs[(i+6)%7]-iv+12)%12;
      const map={maj:{11:'maj7',10:'dom7'},min:{10:'min7'},dim:{10:'m7b5'}};
      q=(map[q]&&map[q][t7])||q;
    }
    return{cr,q,notes:cn(cr,q),sym:cs(cr,q),rom:DROM[i]||String(i+1)};
  });
}

function miniChordGrid(chords){
  return`<div class="mc-grid">${chords.map(c=>`
    <div class="mcd" draggable="true" data-chord-sym="${c.sym}" data-chord-notes="${c.notes.join('\u00b7')}" data-chord-q="${c.q}" title="Drag to chord player">
      <div class="mdeg">${c.rom}</div>
      <div class="mcn">${c.sym}</div>
      <div class="mcno">${c.notes.join('\u00b7')}</div>
    </div>`).join('')}</div>`;
}

// ════════════════════════════════════════════════
//  INDIAN DATA — THAATS, RAGAS, SWARAS
// ════════════════════════════════════════════════
// Swara syllables to semitone offsets from Sa
const SWARA_MAP={
  'Sa':0, 'Re♭':1, 'Re':2, 'Ga♭':3, 'Ga':4,
  'Ma':5, 'Ma#':6, 'Pa':7, 'Dha♭':8, 'Dha':9, 'Ni♭':10, 'Ni':11
};
// Short forms for display
const SWARA_SHORT={0:'Sa',1:'re',2:'Re',3:'ga',4:'Ga',5:'Ma',6:'Ma#',7:'Pa',8:'dha',9:'Dha',10:'ni',11:'Ni'};

// 10 Thaats with semitone intervals, ragas, descriptions
const THAATS=[
  {
    name:'Bilawal',
    iv:[0,2,4,5,7,9,11],
    vibe:'Bright · Pure · Serene',
    swaras:'Sa Re Ga Ma Pa Dha Ni',
    desc:'The foundation thaat — all shuddha (natural) swaras. Equivalent to the Western major scale. <em>Calm, pure, auspicious.</em>',
    western:'Major Scale',
    ragas:[
      {n:'Alhaiya Bilawal', m:'Peaceful · morning joy', t:'Morning'},
      {n:'Bilawal',         m:'Pure · serene delight',  t:'Morning'},
      {n:'Bihag',           m:'Romantic · night bloom', t:'Late night'},
      {n:'Shankara',        m:'Devotional · powerful',  t:'Night'},
    ]
  },
  {
    name:'Kalyan',
    iv:[0,2,4,6,7,9,11],
    vibe:'Ethereal · Expansive · Romantic',
    swaras:'Sa Re Ga Ma# Pa Dha Ni',
    desc:'Uses tivra (sharp) Ma — the raised 4th creates an otherworldly, floating quality. <em>Romantic, longing, twilight.</em>',
    western:'Lydian Mode',
    ragas:[
      {n:'Yaman',      m:'Romantic · twilight longing', t:'Evening'},
      {n:'Bhupali',    m:'Sweet · joyful pentatonic',   t:'Evening'},
      {n:'Kedar',      m:'Devotional · gentle flow',    t:'Late night'},
      {n:'Hameer',     m:'Regal · dignified',           t:'Night'},
    ]
  },
  {
    name:'Khamaj',
    iv:[0,2,4,5,7,9,10],
    vibe:'Playful · Folk · Festive',
    swaras:'Sa Re Ga Ma Pa Dha ni',
    desc:'Komal (flat) Ni gives a dominant-7th flavour. Very popular in thumri, bhajan and folk. <em>Light-hearted, playful, festive.</em>',
    western:'Mixolydian Mode',
    ragas:[
      {n:'Khamaj',    m:'Playful · folk festivity',  t:'Late night'},
      {n:'Jhinjhoti', m:'Light · romantic longing',  t:'Night'},
      {n:'Des',       m:'Nostalgic · rain season',   t:'Late night'},
      {n:'Tilang',    m:'Tender · expressive',        t:'Night'},
    ]
  },
  {
    name:'Bhairav',
    iv:[0,1,4,5,7,8,11],
    vibe:'Grave · Devotional · Dawn',
    swaras:'Sa re Ga Ma Pa dha Ni',
    desc:'Komal Re and Dha with all else shuddha. The great morning raga of prayer and contemplation. <em>Solemn, devotional, peaceful dawn.</em>',
    western:'Similar to Double Harmonic / Byzantine',
    ragas:[
      {n:'Bhairav',      m:'Devotional · serene dawn', t:'Dawn'},
      {n:'Ramkali',      m:'Austere · meditative',      t:'Dawn'},
      {n:'Kalingada',    m:'Plaintive · sorrowful',     t:'Dawn'},
      {n:'Ahir Bhairav', m:'Romantic · peaceful',       t:'Morning'},
    ]
  },
  {
    name:'Purvi',
    iv:[0,1,4,6,7,8,11],
    vibe:'Intense · Yearning · Sunset',
    swaras:'Sa re Ga Ma# Pa dha Ni',
    desc:'Komal Re, Dha with tivra Ma — a powerful combination creating intense yearning. <em>Deep emotion, sunset, longing.</em>',
    western:'Unique — no Western equivalent',
    ragas:[
      {n:'Purvi',       m:'Intense yearning · sunset', t:'Sunset'},
      {n:'Shri',        m:'Austere · majestic',        t:'Sunset'},
      {n:'Basant',      m:'Spring · colourful',        t:'Sunset'},
      {n:'Paraj',       m:'Plaintive · evening',       t:'Sunset'},
    ]
  },
  {
    name:'Marwa',
    iv:[0,1,4,6,7,9,11],
    vibe:'Mysterious · Restless · Dusk',
    swaras:'Sa re Ga Ma# Pa Dha Ni',
    desc:'No Pa in main ragas, komal Re creates a very unique unsettled feel. <em>Mysterious, restless, late afternoon dusk.</em>',
    western:'No Western equivalent',
    ragas:[
      {n:'Marwa',     m:'Restless · introspective', t:'Late afternoon'},
      {n:'Puriya',    m:'Romantic · dreamy',        t:'Evening'},
      {n:'Sohini',    m:'Devotional · tender',      t:'Evening'},
      {n:'Bhatiyar',  m:'Heroic · majestic',        t:'Dawn'},
    ]
  },
  {
    name:'Kafi',
    iv:[0,2,3,5,7,9,10],
    vibe:'Melancholic · Seasonal · Folk',
    swaras:'Sa Re ga Ma Pa Dha ni',
    desc:'Komal Ga and Ni — the scale of holi songs and seasonal ragas. <em>Wistful, seasonal, rural beauty.</em>',
    western:'Dorian Mode',
    ragas:[
      {n:'Kafi',      m:'Wistful · seasonal folk',  t:'Midnight'},
      {n:'Pilu',      m:'Light · romantic folk',    t:'Night'},
      {n:'Bageshri',  m:'Longing · deep night',     t:'Late night'},
      {n:'Bhimpalasi',m:'Gentle · afternoon plea',  t:'Afternoon'},
    ]
  },
  {
    name:'Asavari',
    iv:[0,2,3,5,7,8,10],
    vibe:'Sorrowful · Morning · Meditative',
    swaras:'Sa Re ga Ma Pa dha ni',
    desc:'Komal Ga, Dha, Ni — a distinctly sorrowful morning thaat. <em>Prayerful, solitary, quietly melancholic.</em>',
    western:'Similar to Natural Minor / Aeolian',
    ragas:[
      {n:'Asavari',   m:'Sorrowful · morning plea',  t:'Morning'},
      {n:'Jaunpuri',  m:'Peaceful · melancholic',    t:'Morning'},
      {n:'Desi',      m:'Folk character · gentle',   t:'Morning'},
      {n:'Gandhari',  m:'Austere · meditative',      t:'Morning'},
    ]
  },
  {
    name:'Bhairavi',
    iv:[0,1,3,5,7,8,10],
    vibe:'Poignant · Farewell · All-hours',
    swaras:'Sa re ga Ma Pa dha ni',
    desc:'All komal (flat) except Ma and Pa — the raga of farewell and conclusion. Played last in concerts. <em>Tender, emotional, all-encompassing.</em>',
    western:'Similar to Phrygian Mode',
    ragas:[
      {n:'Bhairavi',  m:'Farewell · tender emotion',  t:'Morning / all hours'},
      {n:'Sindhu Bhairavi', m:'Romantic · folk',      t:'Any time'},
      {n:'Malkauns',  m:'Deep night · profound',      t:'Late night'},
      {n:'Dhani',     m:'Playful · light',            t:'Night'},
    ]
  },
  {
    name:'Todi',
    iv:[0,1,3,6,7,8,11],
    vibe:'Intense · Profound · Morning',
    swaras:'Sa re ga Ma# Pa dha Ni',
    desc:'Komal Re, Ga, Dha with tivra Ma — the most complex and revered thaat. <em>Intense concentration, supreme beauty, meditative depth.</em>',
    western:'No direct equivalent — closest to Phrygian ♯4',
    ragas:[
      {n:'Miyan ki Todi',m:'Supreme beauty · depth', t:'Late morning'},
      {n:'Gujari Todi',  m:'Gentle · lyrical',       t:'Morning'},
      {n:'Multani',      m:'Afternoon · contemplative',t:'Afternoon'},
      {n:'Bilaskhani Todi',m:'Sorrowful · plaintive', t:'Morning'},
    ]
  },
];

// Scale → Thaat cross-reference (for Scales & Modes views)
const SCALE_THAAT_MAP={
  'Major':         'Bilawal',
  'Natural Minor': 'Asavari',
  'Harmonic Minor': null,
  'Dorian':        'Kafi',
  'Mixolydian':    'Khamaj',
  'Phrygian':      'Bhairavi',
  'Lydian':        'Kalyan',
};
const MODE_THAAT_MAP={
  0:'Bilawal',   // Ionian
  1:'Kafi',      // Dorian
  2:'Bhairavi',  // Phrygian
  3:'Kalyan',    // Lydian
  4:'Khamaj',    // Mixolydian
  5:'Asavari',   // Aeolian
  6:null,        // Locrian
};

// ── CHORDS VIEW ──────────────────────────────
function renderDiatonic(){
  const v=document.getElementById('chordsV');
  const qs=use4?D4Q:D3Q;
  const cards=MAJ.map((iv,i)=>{
    const cr=na(cRoot,iv),q=qs[i];
    return{cr,q,notes:cn(cr,q),sym:cs(cr,q),rom:DROM[i],romf:DROMF[i],func:DFUNC[i],mood:DMOOD[i]};
  });
  const thaatRef=THAATS.find(t=>t.name==='Bilawal'); // Major = Bilawal
  const indianNote=indianMode?`<div style="margin-top:8px;padding:8px;background:var(--saffron-faint);border-left:3px solid var(--saffron);border-radius:0 2px 2px 0;font-family:var(--hand);font-size:12px;color:var(--saffron-dim)">🪔 In Indian music, <em style="color:var(--saffron)">${cRoot} Major = ${cRoot} Bilawal Thaat</em>. These 7 chords correspond to the svaras: Sa·Re·Ga·Ma·Pa·Dha·Ni. The V chord (${na(cRoot,7)}) is the <em style="color:var(--saffron)">Pancham (Pa)</em> — fundamental to tanpura tuning.</div>`:'';
  v.innerHTML=`<div>
    <div class="d-bar">
      <div class="d-hdr">7 diatonic chords of <em>${cRoot} Major</em><br><span style="font-size:11px;color:var(--pencil-hb2);font-family:var(--hand)">hover = degree info · click = mark chord</span></div>
      <button class="fn-btn${use4?' on':''}" id="fn4chord">${use4?'● Jazz Up ON':'○ Jazz Up'}</button>
    </div>
    ${indianNote}
    <div class="dgrid" style="margin-top:10px">${cards.map((c,i)=>`
      <div class="dc${i===0?' isr':''}${dcLit.has(i)?' dlit':''}" data-i="${i}" draggable="true" data-chord-sym="${c.sym}" data-chord-notes="${c.notes.join('·')}" data-chord-q="${c.q}">
        <div class="deg">${c.rom}</div>
        <div class="cn">${c.sym}</div>
        <div class="cq">${QL[c.q]}</div>
        <div class="cno">${c.notes.join('·')}</div>
        <div class="hov"><div class="hr">${c.romf}</div><div class="hf">${c.func}</div><div class="hm">${c.mood}</div></div>
      </div>`).join('')}
    </div>
  </div>`;
  document.getElementById('fn4chord').addEventListener('click',()=>{use4=!use4;renderAll();});
  v.querySelectorAll('.dc').forEach(d=>{
    d.addEventListener('click',()=>{
      const i=parseInt(d.dataset.i);
      dcLit.has(i)?dcLit.delete(i):dcLit.add(i);
      d.classList.toggle('dlit',dcLit.has(i));
    });
    // Drag start — store chord data
    d.addEventListener('dragstart', e => {
      const data = { sym: d.dataset.chordSym, notes: d.dataset.chordNotes, q: d.dataset.chordQ };
      e.dataTransfer.setData('application/x-chord', JSON.stringify(data));
      e.dataTransfer.effectAllowed = 'copy';
      d.classList.add('drag-preview');
    });
    d.addEventListener('dragend', () => d.classList.remove('drag-preview'));
  });
}

// ── SCALES VIEW ──────────────────────────────
const SCALES={
  'Major':         {iv:[0,2,4,5,7,9,11],  vibe:'Bright · Resolved',  desc:'The foundation of Western music. Bright and uplifting, fully resolved. Starting point for all harmonic study.',                    steps:['W','W','H','W','W','W','H']},
  'Natural Minor': {iv:[0,2,3,5,7,8,10],  vibe:'Dark · Emotional',    desc:'The most common minor scale. Dark and emotional yet stable. Used in almost every genre from classical to rock.',               steps:['W','H','W','W','H','W','W']},
  'Harmonic Minor':{iv:[0,2,3,5,7,8,11],  vibe:'Exotic · Dramatic',   desc:'Natural minor with a raised 7th. Creates the dramatic augmented 2nd interval. Very common in classical and metal.',           steps:['W','H','W','W','H','A','H']},
  'Dorian':        {iv:[0,2,3,5,7,9,10],  vibe:'Cool · Jazzy',        desc:'Minor with a natural 6th — brighter than natural minor. The most-used modal scale in jazz, funk and soul.',                   steps:['W','H','W','W','W','H','W']},
  'Mixolydian':    {iv:[0,2,4,5,7,9,10],  vibe:'Bluesy · Dominant',   desc:'Major with a ♭7. Has a dominant 7th built on the tonic. The backbone of blues, rock and country improvisation.',             steps:['W','W','H','W','W','H','W']},
  'Phrygian':      {iv:[0,1,3,5,7,8,10],  vibe:'Dark · Spanish',      desc:'Minor with a ♭2. Very dark and exotic. Foundational to flamenco, Spanish music and heavy metal.',                            steps:['H','W','W','W','H','W','W']},
  'Lydian':        {iv:[0,2,4,6,7,9,11],  vibe:'Dreamy · Floating',   desc:'Major with a ♯4 (tritone above root). Otherworldly, ethereal. Very common in film scores (Williams, Zimmer).',              steps:['W','W','W','H','W','W','H']},
  'Pentatonic Maj':{iv:[0,2,4,7,9],        vibe:'Open · Universal',    desc:'5-note major scale — completely consonant, no half steps. The most universally played scale across all world music.',        steps:['W','W','A','W','A']},
  'Pentatonic Min':{iv:[0,3,5,7,10],       vibe:'Gritty · Soulful',    desc:'5-note minor scale. The go-to for rock and blues soloing. Works over almost any minor or dominant chord.',                   steps:['A','W','W','A','W']},
  'Blues':         {iv:[0,3,5,6,7,10],     vibe:'Soulful · Gritty',    desc:'Pentatonic minor + ♭5 blue note. That characteristic blues tension and release. The ♭5 is the "money note".',             steps:['A','W','H','H','A','W']},
};

function renderScales(){
  const con=document.getElementById('scaleDisp'); con.innerHTML='';
  const tb=document.createElement('div');
  tb.style.cssText='display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap;gap:8px';
  tb.innerHTML=`<span style="font-size:12px;color:var(--pencil-hb2);font-family:var(--hand)">Click a scale to expand — notes, chords${indianMode?', Indian thaat':''}.</span>
    <button class="fn-btn${use4?' on':''}" id="fn4scale">${use4?'● Jazz Up ON':'○ Jazz Up'}</button>`;
  con.appendChild(tb);
  document.getElementById('fn4scale').addEventListener('click',()=>{use4=!use4;renderAll();});

  Object.entries(SCALES).forEach(([name,data])=>{
    const isOpen=openScale===name;
    const blk=document.createElement('div'); blk.className='sblk'+(isOpen?' open':'');
    const hdr=document.createElement('div'); hdr.className='sblk-hdr'+(isOpen?' open':'');
    const notes=data.iv.map((iv,i)=>{const n=na(cRoot,iv);return`<span class="sn${i===0?' root':''}" data-note="${n}">${n}</span>`;}).join('');
    const thaatName=SCALE_THAAT_MAP[name];
    const badge=indianMode&&thaatName?`<span class="indian-badge">🪔 ${thaatName}</span>`:'';
    hdr.innerHTML=`<span class="sblk-n">${name}${badge}</span><span class="sblk-v">${data.vibe}</span>`;
    hdr.addEventListener('click',()=>{ openScale=openScale===name?null:name; renderScales(); });
    const body=document.createElement('div'); body.className='sblk-body';
    const chords=scaleChords(cRoot,data.iv,use4);
    const stepsHtml=data.steps.map(s=>`<span class="sstep">${s}</span>`).join('');
    // Indian thaat cross-reference block
    let indianBlock='';
    if(indianMode&&thaatName){
      const thaat=THAATS.find(t=>t.name===thaatName);
      if(thaat){
        const swaraRow=data.iv.map((iv,i)=>`<div class="sw"><span class="syl">${SWARA_SHORT[iv]}</span><span class="wn">${na(cRoot,iv)}</span></div>`).join('');
        indianBlock=`
        <div class="swara-map" style="margin-bottom:10px">
          <div class="swara-map-t">🪔 SWARA MAPPING — ${cRoot} ${thaatName}</div>
          <div class="swara-row">${swaraRow}</div>
        </div>
        <div style="padding:8px;background:var(--saffron-faint);border-left:3px solid var(--saffron);border-radius:0 2px 2px 0;font-family:var(--hand);font-size:12px;color:var(--pencil-2b);margin-bottom:8px">
          <strong style="color:var(--saffron)">${thaat.name} Thaat:</strong> ${thaat.desc.replace(/<em>/g,'<em style="color:var(--saffron)">')}
        </div>`;
      }
    }
    body.innerHTML=`
      <div class="s-notes">${notes}</div>
      <div class="s-steps">${stepsHtml}</div>
      ${indianBlock}
      <div class="s-desc" style="margin-top:8px">${data.desc}</div>
      <div class="sec-lbl" style="margin-top:10px">DIATONIC CHORDS — ${cRoot} ${name.toUpperCase()}</div>
      ${miniChordGrid(chords)}`;
    blk.appendChild(hdr); blk.appendChild(body); con.appendChild(blk);
  });
}

// ── MODES VIEW ───────────────────────────────
const MODES=[
  {n:'Ionian',    g:'Natural Major',  i:[0,2,4,5,7,9,11], c:6, v:'Bright · Happy',    d:'The standard major scale — fully resolved and bright. The harmonic home of Western music.',                          s:['W','W','H','W','W','W','H']},
  {n:'Dorian',    g:'Minor + ♮6',     i:[0,2,3,5,7,9,10], c:5, v:'Cool · Jazzy',      d:'Minor with a raised 6th. Brighter than natural minor, cool and sophisticated. Core of jazz, funk and rock solos.',   s:['W','H','W','W','W','H','W']},
  {n:'Phrygian',  g:'Minor + ♭2',     i:[0,1,3,5,7,8,10], c:1, v:'Dark · Spanish',    d:'Minor with a flat 2nd. Exotic and intense. Foundational to flamenco, metal and Middle Eastern music.',               s:['H','W','W','W','H','W','W']},
  {n:'Lydian',    g:'Major + ♯4',     i:[0,2,4,6,7,9,11], c:3, v:'Dreamy · Cinematic',d:'Major with raised 4th. Ethereal and floating. Very common in film scores and progressive rock.',                     s:['W','W','W','H','W','W','H']},
  {n:'Mixolydian',g:'Major + ♭7',     i:[0,2,4,5,7,9,10], c:6, v:'Bluesy · Rock',     d:'Major with lowered 7th — dominant 7th built in on the tonic. Classic blues, rock and country feel.',                s:['W','W','H','W','W','H','W']},
  {n:'Aeolian',   g:'Natural Minor',  i:[0,2,3,5,7,8,10], c:5, v:'Sad · Emotional',   d:'The natural minor scale. Dark and emotional yet stable. Backbone of minor-key music in every genre.',                s:['W','H','W','W','H','W','W']},
  {n:'Locrian',   g:'Diminished',     i:[0,1,3,5,6,8,10], c:4, v:'Tense · Unstable',  d:'Most dissonant mode — diminished tonic chord, flat 5th. Rarely used as tonal centre; creates extreme unrest.',     s:['H','W','W','H','W','W','W']},
];

function renderModes(){
  const view=document.getElementById('modesV');
  view.innerHTML=`<div>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap;gap:8px">
      <div class="m-intro" style="margin:0">7 modes of <em>${cRoot} Major</em> — each degree as a new tonal centre.</div>
      <button class="fn-btn${use4?' on':''}" id="fn4mode">${use4?'● Jazz Up ON':'○ Jazz Up'}</button>
    </div>
    ${MODES.map((m,idx)=>{
      const mr=na(cRoot,MAJ[idx]);
      const nh=m.i.map((iv,i)=>{const n=na(mr,iv);return`<span class="mnt${i===0?' mr':i===m.c?' mc':''}">${n}</span>`;}).join('');
      const sh=m.s.map(s=>`<span class="mstep">${s}</span>`).join('');
      const isExp=openMode===idx;
      const chords=isExp?scaleChords(mr,m.i,use4):[];
      const thaatName=MODE_THAAT_MAP[idx];
      const badge=indianMode&&thaatName?`<span class="indian-badge">🪔 ${thaatName}</span>`:'';
      let indianBlock='';
      if(isExp&&indianMode&&thaatName){
        const thaat=THAATS.find(t=>t.name===thaatName);
        if(thaat){
          const swaraRow=m.i.map((iv,i)=>`<div class="sw"><span class="syl">${SWARA_SHORT[iv]}</span><span class="wn">${na(mr,iv)}</span></div>`).join('');
          indianBlock=`
          <div class="swara-map" style="margin:8px 0">
            <div class="swara-map-t">🪔 SWARA MAPPING — ${mr} ${thaatName}</div>
            <div class="swara-row">${swaraRow}</div>
          </div>
          <div style="padding:8px;background:var(--saffron-faint);border-left:3px solid var(--saffron);border-radius:0 2px 2px 0;font-family:var(--hand);font-size:12px;color:var(--pencil-2b);margin-bottom:8px">
            <strong style="color:var(--saffron)">${thaat.name} Thaat:</strong> ${thaat.desc.replace(/<em>/g,'<em style="color:var(--saffron)">')}
            <br><span style="color:var(--pencil-hb2)">Key ragas: ${thaat.ragas.map(r=>r.n).join(', ')}</span>
          </div>`;
        }
      }
      return`<div class="mcard${isExp?' exp':''}" data-mi="${idx}">
        <div class="m-row">
          <div><div class="mname">${m.n}${badge}</div><div class="mgreek">${m.g}</div></div>
          <div class="mnotes">${nh}</div>
          <div class="mvib">${m.v}</div>
        </div>
        <div class="m-det">
          <div class="m-det-t">
            ${m.d}<br>
            <em>Root: ${mr} · Degree ${idx+1} of ${cRoot} Major</em>
          </div>
          <div class="m-steps">${sh}</div>
          ${indianBlock}
          <div class="sec-lbl" style="margin-top:12px">DIATONIC CHORDS — ${mr} ${m.n.toUpperCase()}</div>
          ${isExp?miniChordGrid(chords):''}
        </div>
      </div>`;
    }).join('')}
  </div>`;
  document.getElementById('fn4mode').addEventListener('click',()=>{use4=!use4;renderAll();});
  view.querySelectorAll('.mcard').forEach(c=>{
    c.addEventListener('click',()=>{
      const i=parseInt(c.dataset.mi);
      openMode=openMode===i?null:i;
      renderModes();
    });
  });
}

// ── INDIAN THAATS VIEW ───────────────────────
function renderThaats(){
  const con=document.getElementById('thaatDisp'); con.innerHTML='';
  con.innerHTML=`<div class="thaat-intro">
    10 <em>Thaats</em> (parent scales) of Hindustani classical music. All notes shown in <em>${cRoot}</em> (Sa = ${cRoot}).
    Each thaat generates dozens of ragas — the ragas below are the most commonly performed.
  </div>`;
  THAATS.forEach(thaat=>{
    const isOpen=openThaat===thaat.name;
    const blk=document.createElement('div'); blk.className='thaat-blk'+(isOpen?' open':'');
    // Build notes from intervals
    const notes=thaat.iv.map((iv,i)=>{
      const n=na(cRoot,iv);
      const sw=SWARA_SHORT[iv];
      const cls=i===0?'sa':iv===1||iv===3||iv===8||iv===10?'vkr':iv===6?'pkr':'';
      return`<span class="tn ${cls}" title="${sw}">${n}<span style="font-size:9px;display:block;font-family:var(--mono);color:var(--saffron)">${sw}</span></span>`;
    }).join('');
    const hdr=document.createElement('div'); hdr.className='thaat-hdr'+(isOpen?' open':'');
    hdr.innerHTML=`
      <div>
        <span class="thaat-name">${thaat.name}</span>
        <span class="thaat-swaras" style="margin-left:8px;font-size:10px">${thaat.swaras}</span>
      </div>
      <span class="thaat-vibe">${thaat.vibe}</span>`;
    hdr.addEventListener('click',()=>{ openThaat=openThaat===thaat.name?null:thaat.name; renderThaats(); });

    const body=document.createElement('div'); body.className='thaat-body';
    const swaraRow=thaat.iv.map((iv,i)=>`<div class="sw"><span class="syl">${SWARA_SHORT[iv]}</span><span class="wn">${na(cRoot,iv)}</span></div>`).join('');
    const ragaCards=thaat.ragas.map(r=>`
      <div class="raga-card">
        <div class="raga-name">${r.n}</div>
        <div class="raga-mood">${r.m}</div>
        <div class="raga-time">⏱ ${r.t}</div>
      </div>`).join('');
    body.innerHTML=`
      <div class="thaat-notes-row">${notes}</div>
      <div class="swara-map" style="margin-bottom:10px">
        <div class="swara-map-t">SWARA → WESTERN (Sa = ${cRoot})</div>
        <div class="swara-row">${swaraRow}</div>
      </div>
      <div class="thaat-desc">${thaat.desc}<br><span style="color:var(--pencil-hb2);font-size:12px">Western equivalent: <em style="color:var(--green-ink)">${thaat.western}</em></span></div>
      <div class="raga-sec-lbl">Notable Ragas of ${thaat.name}</div>
      <div class="raga-grid">${ragaCards}</div>`;

    blk.appendChild(hdr); blk.appendChild(body); con.appendChild(blk);
  });
}

// ── ROOT / VIEW CONTROLS ─────────────────────
// Root is now controlled from universal bar
document.getElementById('ubarKeyBtns').addEventListener('click',e=>{
  const r=e.target.dataset.root; if(!r)return;
  cRoot=r; dcLit.clear();
  document.querySelectorAll('#ubarKeyBtns .ubar-key').forEach(b=>b.classList.toggle('on',b.dataset.root===r));
  renderAll();
});

document.getElementById('viewBtns').addEventListener('click',e=>{
  const v=e.target.dataset.view; if(!v)return;
  cView=v;
  document.querySelectorAll('#viewBtns .b').forEach(b=>b.classList.toggle('on',b.dataset.view===v));
  document.getElementById('chordsV').style.display=v==='chords'?'block':'none';
  document.getElementById('scalesV').style.display=v==='scales'?'block':'none';
  document.getElementById('modesV').style.display=v==='modes'?'block':'none';
  document.getElementById('indianV').style.display=v==='indian'?'block':'none';
});

function renderAll(){
  renderDiatonic();
  renderScales();
  renderModes();
  if(indianMode) renderThaats();
}
renderAll();

// ════════════════════════════════════════════════
//  INDIAN MODE MASTER TOGGLE
// ════════════════════════════════════════════════
document.getElementById('indianBtn').addEventListener('click',()=>{
  indianMode=!indianMode;
  const btn=document.getElementById('indianBtn');
  btn.classList.toggle('on',indianMode);
  btn.textContent=indianMode?'🪔 INDIAN ON':'🪔 INDIAN';
  document.getElementById('indianBanner').classList.toggle('show',indianMode);
  document.getElementById('indianTabBtn').style.display=indianMode?'':'none';
  document.querySelectorAll('.snd-b.dha-style').forEach(b=>b.style.display=indianMode?'':'none');
  // Show/hide Indian panel toggles in header
  document.querySelector('.indian-only-toggles').style.display = indianMode ? 'flex' : 'none';
  // Show/hide the new Indian panels
  document.getElementById('indianRhythmsPanel').style.display = indianMode ? '' : 'none';
  renderAll();
});

// ════════════════════════════════════════════════
//  METRONOME
// ════════════════════════════════════════════════
const TAALS={
  teental:    {beats:16, accents:[0,4,8,12], bols:'Dha Dhin Dhin Dha | Dha Dhin Dhin Dha | Dha Tin Tin Ta | Tete Dhin Dhin Dha', vibhag:[4,4,4,4], khali:[2]},
  rupak:      {beats:7,  accents:[0,3,5],     bols:'Tin Tin Na | Dhi Na | Dhi Na', vibhag:[3,2,2], khali:[]},
  jhaptal:    {beats:10, accents:[0,2,5,7],   bols:'Dhi Na | Dhi Dhi Na | Tin Na | Dhi Dhi Na', vibhag:[2,3,2,3], khali:[2]},
  ektal:      {beats:12, accents:[0,2,4,6,8,10], bols:'Dhin Dhin | DhaGe Tere | Kita Dha | Dhin Dhin | DhaGe Tere | Kita Dha', vibhag:[2,2,2,2,2,2], khali:[3]},
  dadra:      {beats:6,  accents:[0,3],        bols:'Dha Dhi Na | Dha Ti Na', vibhag:[3,3], khali:[1]},
  keherwa:    {beats:8,  accents:[0,4],        bols:'Dha Ge Na Ti | Na Ke Dhi Na', vibhag:[4,4], khali:[1]},
  'teen-taal-vilamba':{beats:16,accents:[0,4,8,12],bols:'Dha Dhin Dhin Dha | Dha Dhin Dhin Dha | Dha Tin Tin Ta | Tete Dhin Dhin Dha', vibhag:[4,4,4,4], khali:[2]},
  dhamar:     {beats:14, accents:[0,5,7,10],  bols:'Ka Da Hi Da | Dhi | Ta Ki Ta | Da Hi Da Dhi | Ta', vibhag:[5,2,3,4], khali:[1]},
};

let currentTaal=null;

function buildVibhagVis(taal){
  const vis=document.getElementById('vibhagVis'); vis.innerHTML='';
  const data=TAALS[taal];
  let beat=0;
  data.vibhag.forEach((len,vi)=>{
    for(let i=0;i<len;i++){
      const b=document.createElement('div');
      const isSam=beat===0;
      const isKhali=data.khali.includes(vi);
      b.className='vb'+(isSam?' sam':'')+(isKhali?' khali':'');
      b.textContent=beat+1;
      b.dataset.beat=beat;
      vis.appendChild(b);
      beat++;
    }
    // Divider
    const sep=document.createElement('div');
    sep.style.cssText='width:1.5px;background:rgba(200,82,10,0.25);align-self:stretch;flex:none';
    vis.appendChild(sep);
  });
}

// (taal section removed from metronome — handled by Indian Rhythms panel)

// Initialize vibhag vis stub (no-op since taalSection removed from metronome)
function buildVibhagVis(taal){}

// Override flashUI to also update vibhag display
const origFlashUI=function(bn,sn){
  if(sn===0){
    document.querySelectorAll('.bd').forEach((el,i)=>{
      el.classList.remove('lit','acclit');
      if(i===bn){ el.classList.add('lit'); if(M.accents.has(bn))el.classList.add('acclit'); }
    });
    // Also update vibhag vis
    document.querySelectorAll('.vb').forEach(el=>{
      el.classList.toggle('lit',parseInt(el.dataset.beat)===bn);
    });
  }
  document.querySelectorAll('.subdot').forEach((d,i)=>d.classList.toggle('lit',i===sn));
};

const M={ bpm:120, beats:4, sub:1, playing:false, sound:'click', vol:0.8, accents:new Set([0]), mCtx:null, nextT:0, beatN:0, subN:0, tid:null };

function getMCtx(){
  if(!M.mCtx)M.mCtx=new(window.AudioContext||window.webkitAudioContext)();
  if(M.mCtx.state==='suspended')M.mCtx.resume();
  return M.mCtx;
}

// ════════════════════════════════════════════════
//  PRE-BAKE TABLA BUFFERS (done once, at AudioContext init)
//  All noise/synthesis done offline, stored as AudioBuffers.
//  playClick() just schedules a buffer play — zero main-thread work.
// ════════════════════════════════════════════════
let tablaBuffers=null;  // {dha, dhaN, tin, tinN, na, ge, te}

function bakeTablaBuffers(ctx){
  if(tablaBuffers) return;
  const sr=ctx.sampleRate;
  tablaBuffers={};

  // ── Helper: offline bake ─────────────────────
  function bake(fn, durationSec){
    const len=Math.ceil(sr*durationSec);
    const buf=ctx.createBuffer(1,len,sr);
    const d=buf.getChannelData(0);
    fn(d,sr,len);
    return buf;
  }

  // ── Bayan (low skin) — DHA / GE / KA ────────
  // Physics: exponentially decaying pitch-swept sine + noise burst
  function bayanHit(d,sr,len, pitch, decay, noiseMix, pitchDrop){
    for(let i=0;i<len;i++){
      const t=i/sr;
      const env=Math.exp(-t*decay);
      const instF=pitch*(1+pitchDrop*Math.exp(-t*40)); // pitch glide up then settle
      const phi=2*Math.PI*instF*t;
      const tone=Math.sin(phi)+0.3*Math.sin(2*phi)+0.15*Math.sin(3*phi);
      const noise=(Math.random()*2-1)*Math.exp(-t*sr*0.4/len);
      d[i]=env*(tone*(1-noiseMix)+noise*noiseMix)*0.85;
    }
  }
  tablaBuffers.bayan=    bake((d,sr,len)=>bayanHit(d,sr,len,130,9,0.08,0.35),  0.55);
  tablaBuffers.bayanAcct=bake((d,sr,len)=>bayanHit(d,sr,len,155,7,0.06,0.45),  0.65);
  tablaBuffers.ge=       bake((d,sr,len)=>bayanHit(d,sr,len,100,14,0.12,0.2),  0.35);

  // ── Dayan (high skin, tuned resonant head) ───
  // Physics: tuned membrane = pitched resonance + attack transient
  // Dayan has syahi (black paste) creating a very characteristic
  // "throbbing" — modelled as fast-decaying pitched partials
  function dayanHit(d,sr,len, pitch, decay, bright){
    for(let i=0;i<len;i++){
      const t=i/sr;
      const env=Math.exp(-t*decay);
      const envFast=Math.exp(-t*decay*3.5);
      // Fundamental + harmonics with different decay rates
      // Syahi paste causes 2nd harmonic to be prominent
      const f1=pitch, f2=pitch*1.98, f3=pitch*2.95, f4=pitch*3.94;
      const tone = Math.sin(2*Math.PI*f1*t)*env*1.0
                 + Math.sin(2*Math.PI*f2*t)*envFast*bright*0.55
                 + Math.sin(2*Math.PI*f3*t)*Math.exp(-t*decay*5)*0.22
                 + Math.sin(2*Math.PI*f4*t)*Math.exp(-t*decay*8)*0.10;
      // Attack transient (smack)
      const attack=(Math.random()*2-1)*Math.exp(-i/(sr*0.003))*0.3;
      d[i]=(tone+attack)*0.9;
    }
  }
  // Na: open resonant (khali/open)
  tablaBuffers.na= bake((d,sr,len)=>dayanHit(d,sr,len,360,8,0.4),  0.45);
  // Tin: open resonant accent
  tablaBuffers.tin=bake((d,sr,len)=>dayanHit(d,sr,len,410,7,0.55), 0.50);
  // Ti: subdued dayan
  tablaBuffers.ti= bake((d,sr,len)=>dayanHit(d,sr,len,320,12,0.3), 0.30);
  // Te: quick light tap
  tablaBuffers.te= bake((d,sr,len)=>dayanHit(d,sr,len,390,16,0.2), 0.20);

  // ── DHA = bayan + na together ────────────────
  // (played simultaneously from separate buffers)

  // ── WOOD BLOCK (for western 'wood' sound) ────
  function woodHit(d,sr,len, pitch){
    for(let i=0;i<len;i++){
      const t=i/sr;
      const env=Math.exp(-t*60);
      d[i]=Math.sin(2*Math.PI*pitch*t)*env*0.8+(Math.random()*2-1)*Math.exp(-t*80)*0.2;
    }
  }
  tablaBuffers.wood=     bake((d,sr,len)=>woodHit(d,sr,len,900),  0.12);
  tablaBuffers.woodAcct= bake((d,sr,len)=>woodHit(d,sr,len,1300), 0.10);

  console.log('Tabla buffers pre-baked:', Object.keys(tablaBuffers));
}

// ── Lag-free buffer scheduler ─────────────────
// All audio uses pre-baked buffers. Main thread work = zero per beat.
function scheduleBuffer(ctx, buf, when, vol, out){
  if(!buf) return;
  const src=ctx.createBufferSource();
  const g=ctx.createGain();
  src.buffer=buf; src.connect(g); g.connect(out||ctx.destination);
  g.gain.setValueAtTime(vol,when);
  src.start(when); src.stop(when+buf.duration+0.005);
}

function playClick(when, accent, sub){
  const ctx=getMCtx();
  bakeTablaBuffers(ctx);   // no-op after first call
  const vol=M.vol*(sub?0.38:accent?1.0:0.68);
  const out=ctx.destination;

  if(M.sound==='click'){
    // Tuned click using small pre-generated buffer
    const f=accent?1400:sub?580:940;
    const dur=0.05, len=Math.ceil(ctx.sampleRate*dur);
    const buf=ctx.createBuffer(1,len,ctx.sampleRate);
    const d=buf.getChannelData(0);
    for(let i=0;i<len;i++) d[i]=Math.sin(2*Math.PI*f*(i/ctx.sampleRate))*Math.exp(-i/(len*0.3));
    scheduleBuffer(ctx,buf,when,vol,out);

  } else if(M.sound==='wood'){
    scheduleBuffer(ctx, accent?tablaBuffers.woodAcct:tablaBuffers.wood, when, vol, out);

  } else if(M.sound==='beep'){
    const osc=ctx.createOscillator(), g=ctx.createGain();
    osc.type='sine'; osc.frequency.value=accent?1046:sub?330:698;
    osc.connect(g); g.connect(out);
    g.gain.setValueAtTime(vol*0.7,when); g.gain.exponentialRampToValueAtTime(0.0001,when+0.09);
    osc.start(when); osc.stop(when+0.11);

  } else if(M.sound==='snap'){
    const osc=ctx.createOscillator(), g=ctx.createGain();
    osc.type='sine'; osc.frequency.value=accent?1800:1200;
    osc.connect(g); g.connect(out);
    g.gain.setValueAtTime(vol*0.9,when); g.gain.exponentialRampToValueAtTime(0.0001,when+0.022);
    osc.start(when); osc.stop(when+0.03);

  } else if(M.sound==='dha'){
    // DHA = bayan + na (both buffers at once)
    scheduleBuffer(ctx, accent?tablaBuffers.bayanAcct:tablaBuffers.bayan, when, vol*0.9, out);
    scheduleBuffer(ctx, accent?tablaBuffers.tin:tablaBuffers.na, when, vol*0.75, out);

  } else if(M.sound==='tin'){
    // TIN = dayan only (open/khali stroke)
    scheduleBuffer(ctx, accent?tablaBuffers.tin:tablaBuffers.na, when, vol*0.85, out);
  }
}

// ── Lag-free scheduler ──────────────────────
// Lookahead: 150ms. Interval: 25ms.
// Swing: odd sub-beats are delayed to create long-short feel
function sched(){
  const ctx=getMCtx();
  const LOOKAHEAD=0.15;
  const bd=60/M.bpm, sd=bd/M.sub;
  while(M.nextT < ctx.currentTime + LOOKAHEAD){
    const acc=M.accents.has(M.beatN), isSub=M.subN>0;
    // Apply swing offset to odd subdivisions (off-beats)
    const sw = typeof window._swingAmount !== 'undefined' ? window._swingAmount : 0;
    let swingOff = 0;
    if(sw > 0 && M.sub >= 2 && M.subN % 2 === 1){
      // Off-beat pushed late: creates the long-short swing feel
      // sw=0.2 → 20% extra delay = noticeably swung
      // sw=0.33 → 33% extra = triplet/jazz feel
      // Formula: off-beat shifts by sw * one-beat-duration
      // This is more audible than shifting within a sub-beat
      swingOff = sw * (60 / M.bpm);
    }
    const scheduledT = M.nextT + swingOff;
    playClick(scheduledT, acc, isSub);
    const delay=Math.max(0,(scheduledT-ctx.currentTime)*1000);
    const bn=M.beatN, sn=M.subN;
    setTimeout(()=>origFlashUI(bn,sn), delay);
    M.nextT+=sd; M.subN++;
    if(M.subN>=M.sub){ M.subN=0; M.beatN=(M.beatN+1)%M.beats; }
  }
}
function startM(){
  const ctx=getMCtx();
  // Pre-bake tabla on start so first beat isn't late
  bakeTablaBuffers(ctx);
  M.playing=true; M.beatN=0; M.subN=0;
  M.nextT=ctx.currentTime+0.05;
  M.tid=setInterval(sched,25);
  document.getElementById('playB').textContent='■  STOP';
  document.getElementById('playB').classList.add('playing');
}
function stopM(){
  M.playing=false; if(M.tid)clearInterval(M.tid);
  document.getElementById('playB').textContent='▶  START';
  document.getElementById('playB').classList.remove('playing');
  document.querySelectorAll('.bd,.subdot,.vb').forEach(d=>d.classList.remove('lit','acclit'));
}
document.getElementById('playB').addEventListener('click',()=>M.playing?stopM():startM());

function setBPM(v){
  M.bpm = Math.max(20, Math.min(300, Math.round(+v)));
  document.getElementById('ubarBpmNum').textContent = M.bpm;
  document.getElementById('ubarBpmSl').value = M.bpm;

  // Metronome: scheduler reads M.bpm on every 25ms tick — no restart needed.
  // The lookahead window auto-adapts within one scheduler cycle (~150ms).

  // Drums: live-swap the interval without losing the step position
  if (typeof window._drumSetBpm === 'function') window._drumSetBpm(M.bpm);

  // Indian Rhythms: live-swap the interval
  if (typeof window._irSetBpm === 'function') window._irSetBpm(M.bpm);
}
document.getElementById('ubarBd1').addEventListener('click',()=>setBPM(M.bpm-1));
document.getElementById('ubarBu1').addEventListener('click',()=>setBPM(M.bpm+1));
document.getElementById('ubarBd10').addEventListener('click',()=>setBPM(M.bpm-10));
document.getElementById('ubarBu10').addEventListener('click',()=>setBPM(M.bpm+10));
document.getElementById('ubarBpmSl').addEventListener('input',e=>setBPM(e.target.value));
document.getElementById('ubarBpmNum').addEventListener('dblclick',()=>{
  const v=parseInt(prompt('Enter BPM (20–300):',M.bpm)); if(!isNaN(v))setBPM(v);
});

let tapTimes=[];
document.getElementById('ubarTapBtn').addEventListener('click',()=>{
  const now=performance.now();
  tapTimes.push(now); tapTimes=tapTimes.filter(t=>now-t<4000);
  if(tapTimes.length>=2){
    const diffs=tapTimes.slice(1).map((t,i)=>t-tapTimes[i]);
    setBPM(Math.round(60000/(diffs.reduce((a,b)=>a+b)/diffs.length)));
  }
  const btn=document.getElementById('ubarTapBtn');
  btn.textContent=`⬤ ${M.bpm} BPM`;
  clearTimeout(btn._t); btn._t=setTimeout(()=>btn.textContent='⬤ TAP',1000);
});

function buildUI(){
  const vis=document.getElementById('beatVis'), acc=document.getElementById('accRow');
  vis.innerHTML=''; acc.innerHTML='';
  for(let i=0;i<M.beats;i++){
    const d=document.createElement('div');
    d.className='bd'+(M.accents.has(i)?' acc':''); d.textContent=i+1;
    vis.appendChild(d);
    const ab=document.createElement('button');
    ab.className='acc-b'+(M.accents.has(i)?' on':''); ab.textContent=i+1;
    ab.addEventListener('click',()=>{ M.accents.has(i)?M.accents.delete(i):M.accents.add(i); buildUI(); });
    acc.appendChild(ab);
  }
  document.getElementById('subDots').innerHTML=Array(M.sub).fill('<div class="subdot"></div>').join('');
}
document.getElementById('beatBtns').addEventListener('click',e=>{
  const b=parseInt(e.target.dataset.beats); if(!b)return;
  M.beats=b; M.accents=new Set([0]); M.beatN=0; M.subN=0; currentTaal=null;
  document.querySelectorAll('.taal-btn').forEach(x=>x.classList.remove('on'));
  document.querySelectorAll('#beatBtns .b').forEach(btn=>btn.classList.toggle('on',parseInt(btn.dataset.beats)===b));
  buildUI();
});
document.getElementById('subBtns').addEventListener('click',e=>{
  const s=parseInt(e.target.dataset.sub); if(!s)return;
  M.sub=s; M.beatN=0; M.subN=0;
  document.querySelectorAll('#subBtns .b').forEach(btn=>btn.classList.toggle('on',parseInt(btn.dataset.sub)===s));
  buildUI();
});
document.querySelectorAll('.snd-b:not(.dha-style)').forEach(b=>{
  b.addEventListener('click',()=>{
    document.querySelectorAll('.snd-b').forEach(x=>x.classList.remove('on'));
    b.classList.add('on'); M.sound=b.dataset.snd;
  });
});
document.querySelectorAll('.snd-b.dha-style').forEach(b=>{
  b.style.display='none'; // hidden until Indian mode
  b.addEventListener('click',()=>{
    document.querySelectorAll('.snd-b').forEach(x=>x.classList.remove('on'));
    b.classList.add('on'); M.sound=b.dataset.snd;
  });
});
document.getElementById('volSl').addEventListener('input',e=>{
  M.vol=parseInt(e.target.value)/100;
  document.getElementById('volLbl').textContent=e.target.value+'%';
});

buildUI();
buildXRow();

// ════════════════════════════════════════════════════════
//  PANEL COLLAPSE — every panel gets a ▾ toggle button
// ════════════════════════════════════════════════════════
// Collapse buttons are removed per user request
// addCollapseButtons is kept as no-op for compatibility
function addCollapseButtons() {}


// (liveMode declared above)

// ── Panel toggle pills (top bar) ──
function syncToggles(panelId, isOn) {
  document.querySelectorAll(`.ptog[data-panel="${panelId}"]`).forEach(b => {
    b.classList.toggle('on', isOn);
  });
  // Window manager hook
  if (isOn) {
    const p = document.getElementById(panelId);
    if (p && !p.dataset.wmSetup) {
      setTimeout(() => {
        if (window._wmInitPanel) window._wmInitPanel(p);
      }, 0);
    }
  }
}

document.querySelectorAll('.ptog[data-panel]').forEach(btn => {
  btn.addEventListener('click', () => {
    const panelId = btn.dataset.panel;
    const panelEl = document.getElementById(panelId);
    if (!panelEl) return;
    const hiding = btn.classList.contains('on');
    const newState = !hiding;
    syncToggles(panelId, newState);
    panelEl.style.display = newState ? '' : 'none';
  });
});

// Indian toggles sync handled in indianBtn listener above

// ════════════════════════════════════════════════════════
//  WINDOW MANAGER — draggable/resizable panels
// ════════════════════════════════════════════════════════
(function initWindowManager() {
  const grid = document.getElementById('panelGrid');
  let isMobile = () => window.innerWidth <= 768;

  // Default window positions — tile them in a grid on first open
  const COLS = 3;
  const COL_W = 370, COL_H = 430, GAP = 12, OFFSET_X = 12, OFFSET_Y = 12;
  let placedCount = 0;

  function getDefaultPos(panel) {
    const col = placedCount % COLS;
    const row = Math.floor(placedCount / COLS);
    return {
      x: OFFSET_X + col * (COL_W + GAP),
      y: OFFSET_Y + row * (COL_H + GAP)
    };
  }

  function bringToFront(panel) {
    let maxZ = 10;
    grid.querySelectorAll('.panel,.spl-panel').forEach(p => {
      const z = parseInt(p.style.zIndex || 10);
      if (z > maxZ) maxZ = z;
    });
    panel.style.zIndex = maxZ + 1;
  }

  function initPanel(panel) {
    if (panel.dataset.wmSetup) return;
    panel.dataset.wmSetup = '1';

    if (!isMobile()) {
      // Position absolutely
      const pos = getDefaultPos(panel);
      placedCount++;
      panel.style.left = pos.x + 'px';
      panel.style.top  = pos.y + 'px';
      panel.style.position = 'absolute';
      bringToFront(panel);
    }

    // Drag via title bar
    const titleBar = panel.querySelector('.ph');
    if (titleBar) {
      let dragging = false, startX, startY, startL, startT;

      function onDragStart(e) {
        if (isMobile()) return;
        if (e.target.closest('button,select,input')) return;
        dragging = true;
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        startX = clientX;
        startY = clientY;
        startL = parseInt(panel.style.left || 0);
        startT = parseInt(panel.style.top  || 0);
        panel.classList.add('dragging');
        bringToFront(panel);
        e.preventDefault();
      }

      function onDragMove(e) {
        if (!dragging) return;
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        const dx = clientX - startX;
        const dy = clientY - startY;
        const gridRect = grid.getBoundingClientRect();
        const newL = Math.max(0, Math.min(gridRect.width - 60,  startL + dx));
        const newT = Math.max(0, startT + dy);
        panel.style.left = newL + 'px';
        panel.style.top  = newT + 'px';
        e.preventDefault();
      }

      function onDragEnd() {
        if (dragging) {
          dragging = false;
          panel.classList.remove('dragging');
        }
      }

      titleBar.addEventListener('mousedown',  onDragStart);
      titleBar.addEventListener('touchstart', onDragStart, { passive: false });
      window.addEventListener('mousemove',  onDragMove);
      window.addEventListener('touchmove',  onDragMove, { passive: false });
      window.addEventListener('mouseup',    onDragEnd);
      window.addEventListener('touchend',   onDragEnd);
    }

    panel.addEventListener('mousedown', () => bringToFront(panel));
    panel.addEventListener('touchstart', () => bringToFront(panel), { passive: true });

    // SE-corner resize handle
    if (!panel.querySelector('.resize-handle')) {
      const rh = document.createElement('div');
      rh.className = 'resize-handle';
      panel.appendChild(rh);
      let resizing = false, rStartX, rStartY, rStartW, rStartH;
      rh.addEventListener('mousedown', e => {
        if (isMobile()) return;
        resizing = true;
        rStartX = e.clientX; rStartY = e.clientY;
        rStartW = panel.offsetWidth; rStartH = panel.offsetHeight;
        panel.classList.add('resizing');
        e.preventDefault(); e.stopPropagation();
      });
      window.addEventListener('mousemove', e => {
        if (!resizing) return;
        const newW = Math.max(260, rStartW + e.clientX - rStartX);
        const newH = Math.max(120, rStartH + e.clientY - rStartY);
        panel.style.width  = newW + 'px';
        panel.style.height = newH + 'px';
        setTimeout(resizeCanvases, 10);
      });
      window.addEventListener('mouseup', () => {
        if (resizing) { resizing = false; panel.classList.remove('resizing'); }
      });
    }

    // Expose globally for syncToggles
    window._wmInitPanel = function(p){ initPanel(p); addMinBtn(p); };
  }

  // Add minimize button to each panel's title bar
  function addMinBtn(panel) {
    if (panel.querySelector('.win-min-btn')) return;
    const ph = panel.querySelector('.ph');
    if (!ph) return;
    const btn = document.createElement('button');
    btn.className = 'win-min-btn';
    btn.title = 'Toggle compact view';
    btn.setAttribute('aria-label', 'Toggle compact view');
    // Only 2 states: full ↔ compact
    let isCompact = false;
    btn.textContent = '◻';
    btn.addEventListener('click', e => {
      e.stopPropagation();
      isCompact = !isCompact;
      panel.classList.toggle('win-compact', isCompact);
      panel.classList.remove('win-mini');
      btn.textContent = isCompact ? '▣' : '◻';
      btn.title = isCompact ? 'Restore full view' : 'Compact view';
      setTimeout(resizeCanvases, 50);
    });
    ph.appendChild(btn);
  }

  // Panel toggle: position before showing
  const observer = new MutationObserver(mutations => {
    mutations.forEach(m => {
      m.addedNodes.forEach(n => {
        if (n.nodeType === 1 && (n.matches?.('.panel,.spl-panel') || n.classList?.contains('panel'))) {
          initPanel(n);
          addMinBtn(n);
        }
      });
    });
    grid.querySelectorAll('.panel,.spl-panel').forEach(p => {
      if (p.style.display !== 'none' && !p.dataset.wmSetup) {
        initPanel(p);
        addMinBtn(p);
      }
    });
  });
  observer.observe(grid, { childList: true, subtree: true, attributes: true, attributeFilter: ['style'] });

  // Init visible panels on load
  grid.querySelectorAll('.panel,.spl-panel').forEach(p => {
    addMinBtn(p);
    if (p.style.display !== 'none') initPanel(p);
  });

  // Re-init on show — hook into syncToggles when it becomes available
  const wmSyncHook = function(panelId, isOn) {
    if (isOn) {
      const p = document.getElementById(panelId);
      if (p && !p.dataset.wmSetup) {
        initPanel(p);
        addMinBtn(p);
      }
    }
  };
  // Inject after page load when syncToggles is defined
  window.addEventListener('load', () => {
    const origSync = window.syncToggles;
    window.syncToggles = function(panelId, isOn) {
      if (origSync) origSync(panelId, isOn);
      wmSyncHook(panelId, isOn);
    };
  });

  // Handle resize → update grid height
  function updateGridHeight() {
    if (isMobile()) return;
    let maxBottom = 400;
    grid.querySelectorAll('.panel,.spl-panel').forEach(p => {
      if (p.style.display === 'none') return;
      const t = parseInt(p.style.top || 0);
      const h = p.offsetHeight;
      if (t + h > maxBottom) maxBottom = t + h;
    });
    grid.style.minHeight = (maxBottom + 40) + 'px';
  }
  setInterval(updateGridHeight, 1000);

  window.addEventListener('resize', () => {
    if (isMobile()) {
      grid.querySelectorAll('.panel,.spl-panel').forEach(p => {
        p.style.position = '';
        p.style.left = '';
        p.style.top = '';
      });
    }
  });
})();



// ════════════════════════════════════════════════════════
//  INSTRUMENT TUNING SYSTEM
// ════════════════════════════════════════════════════════
const INSTRUMENTS = {
  'Guitar (6-string)': {
    icon:'🎸', group:'Western String',
    tunings: {
      'Standard  E A D G B e':  ['E2','A2','D3','G3','B3','E4'],
      'Drop D    D A D G B e':  ['D2','A2','D3','G3','B3','E4'],
      'Open G    D G D G B D':  ['D2','G2','D3','G3','B3','D4'],
      'Open D    D A D F# A D': ['D2','A2','D3','F#3','A3','D4'],
      'Open E    E B E G# B E': ['E2','B2','E3','G#3','B3','E4'],
      'Open A    E A E A C# E': ['E2','A2','E3','A3','C#4','E4'],
      'DADGAD':                 ['D2','A2','D3','G3','A3','D4'],
      'Eb — half step down':    ['Eb2','Ab2','Db3','Gb3','Bb3','Eb4'],
      'D — full step down':     ['D2','G2','C3','F3','A3','D4'],
      'C#':                     ['C#2','F#2','B2','E3','G#3','C#4'],
    }
  },
  'Guitar (7-string)': {
    icon:'🎸', group:'Western String',
    tunings: {
      'Standard  B E A D G B e': ['B1','E2','A2','D3','G3','B3','E4'],
      'Drop A    A E A D G B e': ['A1','E2','A2','D3','G3','B3','E4'],
    }
  },
  'Bass (4-string)': {
    icon:'🎸', group:'Western String',
    tunings: {
      'Standard  E A D G': ['E1','A1','D2','G2'],
      'Drop D    D A D G': ['D1','A1','D2','G2'],
      'Eb':                ['Eb1','Ab1','Db2','Gb2'],
      'D':                 ['D1','G1','C2','F2'],
    }
  },
  'Bass (5-string)': {
    icon:'🎸', group:'Western String',
    tunings: { 'Standard  B E A D G': ['B0','E1','A1','D2','G2'] }
  },
  'Ukulele': {
    icon:'🪕', group:'Western String',
    tunings: {
      'Soprano / Concert  G C E A': ['G4','C4','E4','A4'],
      'Tenor (low G)  G C E A':     ['G3','C4','E4','A4'],
      'D tuning  A D F# B':         ['A4','D4','F#4','B4'],
      'Baritone  D G B E':          ['D3','G3','B3','E4'],
    }
  },
  'Violin':      { icon:'🎻', group:'Western String', tunings: { 'Standard  G D A E': ['G3','D4','A4','E5'] } },
  'Viola':       { icon:'🎻', group:'Western String', tunings: { 'Standard  C G D A': ['C3','G3','D4','A4'] } },
  'Cello':       { icon:'🎻', group:'Western String', tunings: { 'Standard  C G D A': ['C2','G2','D3','A3'] } },
  'Double Bass': {
    icon:'🎻', group:'Western String',
    tunings: {
      'Standard  E A D G':   ['E1','A1','D2','G2'],
      '5-string  B E A D G': ['B0','E1','A1','D2','G2'],
    }
  },
  'Mandolin': { icon:'🪕', group:'Western String', tunings: { 'Standard  G D A E': ['G3','D4','A4','E5'] } },
  'Banjo (5-string)': {
    icon:'🪕', group:'Western String',
    tunings: {
      'Open G  g D G B D':    ['G4','D3','G3','B3','D4'],
      'Double C  g C G C D':  ['G4','C3','G3','C4','D4'],
      'Open D  f# D F# A D':  ['F#4','D3','F#3','A3','D4'],
    }
  },
  'Oud': {
    icon:'🪕', group:'World String',
    tunings: {
      'Arabic  C G D A G C': ['C2','G2','D3','A3','G3','C4'],
      'Turkish  E A B E A E':['E2','A2','B2','E3','A3','E4'],
    }
  },
  'Bouzouki': {
    icon:'🪕', group:'World String',
    tunings: { 'Greek  C F A D': ['C2','F3','A3','D4'], 'Irish  G D A D': ['G2','D3','A3','D4'] }
  },
  // ── INDIAN CLASSICAL (only shown when Indian mode is on) ──
  'Sitar': {
    icon:'🪘', group:'Indian Classical',
    tunings: {
      'Kharaj Pancham  C G C G C G': ['C3','G3','C4','G4','C5','G5'],
      'Gandhar Pancham  E G E G E G': ['E3','G3','E4','G4','E5','G5'],
      'Madhyam  C F C F C F': ['C3','F3','C4','F4','C5','F5'],
    }
  },
  'Sarod': {
    icon:'🪘', group:'Indian Classical',
    tunings: {
      'Standard (Pa-Sa)  G C G C G': ['G2','C3','G3','C4','G4'],
      'Kharaj (Sa-Sa)  C G C G C':   ['C2','G2','C3','G3','C4'],
    }
  },
  'Tanpura': {
    icon:'🎵', group:'Indian Classical',
    tunings: {
      'Pa tuning  Sa Pa Sa sa': ['C2','G3','C4','C5'],
      'Ma tuning  Sa Ma Sa sa': ['C2','F3','C4','C5'],
      'Ni tuning  Sa Ni Sa sa': ['C2','B3','C4','C5'],
    }
  },
  'Sarangi': {
    icon:'🎻', group:'Indian Classical',
    tunings: { 'Standard  Sa Pa Sa': ['C4','G3','C4'] }
  },
  'Veena (Carnatic)': {
    icon:'🪘', group:'Indian Classical',
    tunings: { 'Standard  Sa Pa Sa': ['C3','G3','C4','G4','C5'] }
  },
  'Esraj / Dilruba': {
    icon:'🎻', group:'Indian Classical',
    tunings: { 'Standard': ['C4','G3','C4','F4'] }
  },
  'Tabla (pitch ref)': {
    icon:'🥁', group:'Indian Classical',
    tunings: {
      'Sa (C4)': ['C4'], 'Re (D4)': ['D4'], 'Ga (E4)': ['E4'],
      'Ma (F4)': ['F4'], 'Pa (G4)': ['G4'], 'Dha (A4)':['A4'], 'Ni (B4)': ['B4'],
    }
  },
};

function initTuningUI(instrId, tuningId, stringsId) {
  const instrSel  = document.getElementById(instrId);
  const tuningSel = document.getElementById(tuningId);
  const strDiv    = document.getElementById(stringsId);
  if (!instrSel || !tuningSel || !strDiv) return null;

  function populate() {
    const prev = instrSel.value;
    instrSel.innerHTML = '';
    const groups = {};
    Object.entries(INSTRUMENTS).forEach(([name, data]) => {
      if (data.group === 'Indian Classical' && !window.indianMode) return;
      if (!groups[data.group]) groups[data.group] = [];
      groups[data.group].push(name);
    });
    Object.entries(groups).forEach(([gname, names]) => {
      const og = document.createElement('optgroup');
      og.label = gname;
      names.forEach(n => {
        const opt = document.createElement('option');
        opt.value = n;
        opt.textContent = INSTRUMENTS[n].icon + '  ' + n;
        if (n === prev) opt.selected = true;
        og.appendChild(opt);
      });
      instrSel.appendChild(og);
    });
    populateTunings();
  }

  function populateTunings() {
    const instr = INSTRUMENTS[instrSel.value];
    if (!instr) return;
    const prev = tuningSel.value;
    tuningSel.innerHTML = '';
    Object.keys(instr.tunings).forEach(t => {
      const opt = document.createElement('option');
      opt.value = t; opt.textContent = t;
      if (t === prev) opt.selected = true;
      tuningSel.appendChild(opt);
    });
    renderStrings();
  }

  function renderStrings() {
    const instr = INSTRUMENTS[instrSel.value];
    if (!instr) return;
    const strings = instr.tunings[tuningSel.value];
    if (!strings) return;
    strDiv.innerHTML = '';
    strings.forEach(note => {
      const btn = document.createElement('div');
      btn.className = 'tstr';
      const nName = note.replace(/\d.*/,'').replace('#','♯').replace('b','♭');
      const oct   = note.match(/\d+/)?.[0] || '';
      btn.innerHTML = `${nName}<small>${oct ? 'oct'+oct : ''}</small>`;
      btn.addEventListener('click', () => {
        strDiv.querySelectorAll('.tstr').forEach(x => x.classList.remove('on'));
        btn.classList.add('on');
        cRoot = note.replace(/\d.*/, '');
        dcLit.clear();
        document.querySelectorAll('#ubarKeyBtns .ubar-key').forEach(x => x.classList.toggle('on', x.dataset.root === cRoot));
        renderAll();
      });
      strDiv.appendChild(btn);
    });
  }

  instrSel.addEventListener('change', populateTunings);
  tuningSel.addEventListener('change', renderStrings);
  populate();
  return { refresh: populate };
}

// Init tuning on the single instrument selector
const tuningUI = initTuningUI('instrSel', 'tuningSel', 'tuningStrings');

// Refresh instrument list (add/remove Indian instruments) when Indian mode changes
document.getElementById('indianBtn').addEventListener('click', () => {
  if (tuningUI) setTimeout(() => tuningUI.refresh(), 80);
});

// ════════════════════════════════════════════════════════
//  DRUM LOOPS ENGINE
// ════════════════════════════════════════════════════════
(function initDrums(){
  const GENRES = [
    { id:'rock',    label:'Rock',       icon:'🎸', bpm:120, feel:'straight' },
    { id:'jazz',    label:'Jazz',       icon:'🎷', bpm:138, feel:'swing'    },
    { id:'funk',    label:'Funk',       icon:'🕺', bpm:96,  feel:'16th'     },
    { id:'pop',     label:'Pop',        icon:'🎤', bpm:110, feel:'straight' },
    { id:'hiphop',  label:'Hip-Hop',    icon:'🎧', bpm:88,  feel:'straight' },
    { id:'reggae',  label:'Reggae',     icon:'🌴', bpm:80,  feel:'straight' },
    { id:'bossa',   label:'Bossa Nova', icon:'🌺', bpm:130, feel:'swing'    },
    { id:'metal',   label:'Metal',      icon:'🤘', bpm:160, feel:'straight' },
    { id:'blues',   label:'Blues',      icon:'🎵', bpm:76,  feel:'swing'    },
    { id:'latin',   label:'Latin',      icon:'💃', bpm:120, feel:'16th'     },
  ];

  const INSTRUMENTS = ['Kick','Snare','Hi-Hat','Open HH','Crash','Tom Hi','Tom Lo'];

  // Patterns per genre at complexity 3 (16 steps)
  const BASE_PATTERNS = {
    rock:   { Kick:[1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0], Snare:[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0], 'Hi-Hat':[1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0] },
    jazz:   { Kick:[1,0,0,0,0,0,1,0,0,0,1,0,0,0,0,0], Snare:[0,0,1,0,0,0,0,1,0,0,0,1,0,0,1,0], 'Hi-Hat':[1,1,0,1,1,0,1,0,1,1,0,1,1,0,1,0] },
    funk:   { Kick:[1,0,0,1,0,0,1,0,0,0,1,0,0,0,0,0], Snare:[0,0,0,0,1,0,0,1,0,0,0,0,1,0,0,1], 'Hi-Hat':[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1] },
    pop:    { Kick:[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0], Snare:[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0], 'Hi-Hat':[1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0] },
    hiphop: { Kick:[1,0,0,1,0,0,1,0,0,1,0,0,0,0,1,0], Snare:[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,1], 'Hi-Hat':[1,0,1,1,0,1,1,0,1,0,1,1,0,1,0,1] },
    reggae: { Kick:[0,0,1,0,0,0,1,0,0,0,1,0,0,0,0,0], Snare:[0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0], 'Hi-Hat':[0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1] },
    bossa:  { Kick:[1,0,0,1,0,0,1,0,0,0,1,0,0,1,0,0], Snare:[0,0,1,0,0,1,0,0,0,1,0,0,1,0,0,0], 'Hi-Hat':[1,0,1,0,1,0,1,1,1,0,1,0,1,0,1,1] },
    metal:  { Kick:[1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0], Snare:[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0], 'Hi-Hat':[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1] },
    blues:  { Kick:[1,0,0,1,0,0,1,0,0,0,1,0,0,1,0,0], Snare:[0,0,0,0,1,0,0,1,0,0,0,0,1,0,1,0], 'Hi-Hat':[1,0,1,1,0,1,1,0,1,1,0,1,1,0,1,1] },
    latin:  { Kick:[1,0,0,0,0,1,0,0,1,0,0,0,0,1,0,0], Snare:[0,0,1,0,1,0,0,1,0,0,1,0,1,0,0,0], 'Hi-Hat':[1,1,0,1,1,0,1,0,1,1,0,1,1,0,1,0] },
  };

  let currentGenre = 'rock', loopLen = 16, complexity = 3;
  let drumBpm = 100, drumPlaying = false, drumStep = 0, drumTimerId = null;
  let drumPatterns = {}; // current active pattern
  let drumACtx = null;

  function getDrumACtx(){ if(!drumACtx) drumACtx = new(window.AudioContext||window.webkitAudioContext)(); return drumACtx; }

  // Synthesize drum sounds
  function playDrumSound(type, time) {
    const ctx = getDrumACtx();
    const t = time || ctx.currentTime;
    if(type==='Kick'){
      const o=ctx.createOscillator(), g=ctx.createGain();
      o.connect(g); g.connect(ctx.destination);
      o.frequency.setValueAtTime(150,t); o.frequency.exponentialRampToValueAtTime(0.001,t+0.35);
      g.gain.setValueAtTime(1,t); g.gain.exponentialRampToValueAtTime(0.001,t+0.35);
      o.start(t); o.stop(t+0.35);
    } else if(type==='Snare'){
      const buf=ctx.createBuffer(1,ctx.sampleRate*0.15,ctx.sampleRate);
      const d=buf.getChannelData(0);
      for(let i=0;i<d.length;i++) d[i]=(Math.random()*2-1)*Math.exp(-i/(ctx.sampleRate*0.05));
      const s=ctx.createBufferSource(), g=ctx.createGain();
      s.buffer=buf; s.connect(g); g.connect(ctx.destination);
      g.gain.setValueAtTime(0.7,t); s.start(t);
      // tone layer
      const o=ctx.createOscillator(), g2=ctx.createGain();
      o.connect(g2); g2.connect(ctx.destination);
      o.frequency.value=200; g2.gain.setValueAtTime(0.3,t); g2.gain.exponentialRampToValueAtTime(0.001,t+0.08);
      o.start(t); o.stop(t+0.08);
    } else if(type==='Hi-Hat'||type==='Open HH'){
      const buf=ctx.createBuffer(1,ctx.sampleRate*(type==='Open HH'?0.3:0.04),ctx.sampleRate);
      const d=buf.getChannelData(0);
      for(let i=0;i<d.length;i++) d[i]=(Math.random()*2-1)*Math.exp(-i/(ctx.sampleRate*(type==='Open HH'?0.15:0.02)));
      const s=ctx.createBufferSource(), g=ctx.createGain(), f=ctx.createBiquadFilter();
      f.type='highpass'; f.frequency.value=8000;
      s.buffer=buf; s.connect(f); f.connect(g); g.connect(ctx.destination);
      g.gain.value=0.4; s.start(t);
    } else if(type==='Crash'){
      const buf=ctx.createBuffer(1,ctx.sampleRate*0.8,ctx.sampleRate);
      const d=buf.getChannelData(0);
      for(let i=0;i<d.length;i++) d[i]=(Math.random()*2-1)*Math.exp(-i/(ctx.sampleRate*0.3));
      const s=ctx.createBufferSource(), g=ctx.createGain(), f=ctx.createBiquadFilter();
      f.type='highpass'; f.frequency.value=5000;
      s.buffer=buf; s.connect(f); f.connect(g); g.connect(ctx.destination);
      g.gain.value=0.3; s.start(t);
    } else {
      const o=ctx.createOscillator(), g=ctx.createGain();
      o.connect(g); g.connect(ctx.destination);
      o.frequency.value = type==='Tom Hi' ? 200 : 120;
      g.gain.setValueAtTime(0.6,t); g.gain.exponentialRampToValueAtTime(0.001,t+0.2);
      o.start(t); o.stop(t+0.2);
    }
  }

  function generatePattern(genreId, len, cplx) {
    const base = BASE_PATTERNS[genreId] || BASE_PATTERNS.rock;
    const pat = {};
    INSTRUMENTS.forEach(inst => {
      const src = (base[inst] || []).slice(0, 16);
      const row = [];
      for(let i=0;i<len;i++){
        let val = src[i % 16] || 0;
        // Scale with complexity 1-5
        if(cplx <= 1) val = (inst==='Kick'||inst==='Snare') ? val : 0;
        else if(cplx === 2) val = (inst==='Tom Hi'||inst==='Tom Lo'||inst==='Crash') ? 0 : val;
        else if(cplx >= 4) {
          // Add extra ghost notes
          if(val===0 && Math.random() < (cplx-3)*0.15 && inst!=='Crash') val = Math.random()<0.5?1:0;
        }
        row.push(val);
      }
      pat[inst] = row;
    });
    return pat;
  }

  function renderDrumGrid() {
    const grid = document.getElementById('drumGrid');
    grid.innerHTML = '';
    INSTRUMENTS.forEach(inst => {
      const row = document.createElement('div');
      row.className = 'drum-row';
      const lbl = document.createElement('span');
      lbl.className = 'drum-row-lbl';
      lbl.textContent = inst.toUpperCase().slice(0,6);
      row.appendChild(lbl);
      const steps = document.createElement('div');
      steps.className = 'drum-steps';
      steps.id = 'drow-' + inst.replace(/\s/g,'_');
      for(let i=0;i<loopLen;i++){
        const s = document.createElement('div');
        s.className = 'dstep' + (drumPatterns[inst]?.[i] ? ' on' : '') + (i % 4 === 0 ? ' beat-start' : '');
        s.dataset.inst = inst; s.dataset.step = i;
        s.addEventListener('click', ()=>{
          drumPatterns[inst] = drumPatterns[inst] || Array(loopLen).fill(0);
          drumPatterns[inst][i] = drumPatterns[inst][i] ? 0 : 1;
          s.classList.toggle('on', !!drumPatterns[inst][i]);
        });
        steps.appendChild(s);
      }
      row.appendChild(steps);
      grid.appendChild(row);
    });
  }

  function advanceDrumStep() {
    // Remove playing highlights
    document.querySelectorAll('.dstep.playing').forEach(el => el.classList.remove('playing'));
    // Play current step
    INSTRUMENTS.forEach(inst => {
      if(drumPatterns[inst]?.[drumStep]) {
        playDrumSound(inst);
        const stepEl = document.querySelector(`#drow-${inst.replace(/\s/g,'_')} .dstep:nth-child(${drumStep+1})`);
        if(stepEl) stepEl.classList.add('playing');
      }
    });
    drumStep = (drumStep + 1) % loopLen;
    document.getElementById('drumsStatusLbl').textContent = `STEP ${drumStep+1}/${loopLen}`;
  }

  function startDrums() {
    drumPlaying = true;
    drumStep = 0;
    drumBpm = typeof M !== 'undefined' ? M.bpm : drumBpm;
    const interval = (60000 / drumBpm) / 4; // 16th note interval
    drumTimerId = setInterval(advanceDrumStep, interval);
    document.getElementById('drumPlayBtn').textContent = '■  STOP';
    document.getElementById('drumPlayBtn').classList.add('playing');
  }

  function stopDrums() {
    drumPlaying = false;
    clearInterval(drumTimerId);
    document.querySelectorAll('.dstep.playing').forEach(el => el.classList.remove('playing'));
    document.getElementById('drumPlayBtn').textContent = '▶  PLAY';
    document.getElementById('drumPlayBtn').classList.remove('playing');
    document.getElementById('drumsStatusLbl').textContent = 'STOPPED';
    drumStep = 0;
  }

  function refreshPattern() {
    drumPatterns = generatePattern(currentGenre, loopLen, complexity);
    renderDrumGrid();
  }

  // Build genre buttons
  const genreGrid = document.getElementById('drumGenreGrid');
  GENRES.forEach(g => {
    const btn = document.createElement('button');
    btn.className = 'drum-genre-btn' + (g.id===currentGenre ? ' on' : '');
    btn.dataset.genre = g.id;
    btn.innerHTML = `<span class="dg-icon">${g.icon}</span>${g.label}`;
    btn.addEventListener('click', () => {
      currentGenre = g.id;
      drumBpm = g.bpm;
      // Push genre BPM to global without triggering _drumSetBpm loop
      M.bpm = Math.max(20, Math.min(300, drumBpm));
      document.getElementById('ubarBpmNum').textContent = M.bpm;
      document.getElementById('ubarBpmSl').value = M.bpm;
      if(M.playing){ stopM(); startM(); }
      if(typeof window._irSetBpm === 'function') window._irSetBpm(M.bpm);
      document.querySelectorAll('.drum-genre-btn').forEach(b=>b.classList.toggle('on', b.dataset.genre===g.id));
      if(drumPlaying){ stopDrums(); }
      refreshPattern();
    });
    genreGrid.appendChild(btn);
  });

  // Complexity dots
  const cplxWrap = document.getElementById('complexityDots');
  for(let i=1;i<=5;i++){
    const d = document.createElement('div');
    d.className = 'cplx-dot' + (i<=complexity?' on':'');
    d.dataset.v = i;
    d.addEventListener('click', ()=>{
      complexity = i;
      document.querySelectorAll('.cplx-dot').forEach(x=>x.classList.toggle('on', parseInt(x.dataset.v)<=i));
      document.getElementById('complexityVal').textContent = i;
      refreshPattern();
    });
    cplxWrap.appendChild(d);
  }

  // Loop length
  document.getElementById('loopLenBtns').addEventListener('click', e=>{
    const len = parseInt(e.target.dataset.len); if(!len) return;
    loopLen = len;
    document.querySelectorAll('.loop-len-btn').forEach(b=>b.classList.toggle('on', parseInt(b.dataset.len)===len));
    if(drumPlaying) stopDrums();
    refreshPattern();
  });

  // Play/stop
  document.getElementById('drumPlayBtn').addEventListener('click', ()=>{
    drumPlaying ? stopDrums() : startDrums();
  });

  // Shuffle
  document.getElementById('drumShuffleBtn').addEventListener('click', ()=>{
    refreshPattern();
  });

  // Init
  refreshPattern();

  // ── Global BPM hook — called by setBPM when user changes tempo ──
  window._drumSetBpm = function(bpm) {
    drumBpm = bpm;
    if(drumPlaying){ clearInterval(drumTimerId); drumTimerId = setInterval(advanceDrumStep, (60000/drumBpm)/4); }
  };
})();


// ════════════════════════════════════════════════════════
//  INDIAN RHYTHMS ENGINE
// ════════════════════════════════════════════════════════
(function initIndianRhythms(){
  const TAALS = [
    { id:'teental', name:'Teental', beats:16, vibhags:[4,4,4,4], bols:'Dha Dhin Dhin Dha | Dha Dhin Dhin Dha | Dha Tin Tin Ta | Tete Dhin Dhin Dha', sam:0, khali:8 },
    { id:'rupak',   name:'Rupak',   beats:7,  vibhags:[3,2,2],   bols:'Tin Tin Na | Dhi Na | Dhi Na', sam:0, khali:null },
    { id:'jhaptal', name:'Jhaptal', beats:10, vibhags:[2,3,2,3], bols:'Dhi Na | Dhi Dhi Na | Ti Na | Dhi Dhi Na', sam:0, khali:6 },
    { id:'ektal',   name:'Ektal',   beats:12, vibhags:[2,2,2,2,2,2], bols:'Dhin Dhin | Dha Ge | Ti Ri | Ki Ta | Dha Ge | Ti Ri', sam:0, khali:6 },
    { id:'dadra',   name:'Dadra',   beats:6,  vibhags:[3,3], bols:'Dha Dhi Na | Dha Ti Na', sam:0, khali:3 },
    { id:'keherwa', name:'Keherwa', beats:8,  vibhags:[4,4], bols:'Dha Ge Na Ti | Na Ke Dhi Na', sam:0, khali:4 },
    { id:'dhamar',  name:'Dhamar',  beats:14, vibhags:[5,2,3,4], bols:'Ka Dhi Ta Dhi Ta | Dhi Ta | Ka Dhi Ta | Dhi Ta Dhi Ta', sam:0, khali:8 },
    { id:'teen-taal-vilamba', name:'Vilambit', beats:16, vibhags:[4,4,4,4], bols:'Dha — Dhin — | Dhin — Dha — | Dha — Tin — | Ta — Dhin —', sam:0, khali:8 },
  ];

  let currentTaal = TAALS[0];
  let irBpm = 60, irPlaying = false, irStep = 0, irTimerId = null;
  let irACtx = null;

  function getIrACtx(){ if(!irACtx) irACtx = new(window.AudioContext||window.webkitAudioContext)(); return irACtx; }

  function playBol(type, time){
    const ctx = getIrACtx();
    const t = time || ctx.currentTime;
    if(type==='sam') {
      // Sam — bright metallic
      const o=ctx.createOscillator(), g=ctx.createGain();
      o.connect(g); g.connect(ctx.destination);
      o.type='sine'; o.frequency.setValueAtTime(440,t); o.frequency.exponentialRampToValueAtTime(220,t+0.25);
      g.gain.setValueAtTime(0.5,t); g.gain.exponentialRampToValueAtTime(0.001,t+0.25);
      o.start(t); o.stop(t+0.25);
    } else if(type==='dha') {
      // Dha — low tabla
      const o=ctx.createOscillator(), g=ctx.createGain();
      o.connect(g); g.connect(ctx.destination);
      o.frequency.setValueAtTime(180,t); o.frequency.exponentialRampToValueAtTime(60,t+0.3);
      g.gain.setValueAtTime(0.6,t); g.gain.exponentialRampToValueAtTime(0.001,t+0.3);
      o.start(t); o.stop(t+0.3);
    } else if(type==='tin') {
      // Tin — tabla treble
      const o=ctx.createOscillator(), g=ctx.createGain();
      o.connect(g); g.connect(ctx.destination);
      o.frequency.setValueAtTime(320,t); o.frequency.exponentialRampToValueAtTime(200,t+0.12);
      g.gain.setValueAtTime(0.35,t); g.gain.exponentialRampToValueAtTime(0.001,t+0.12);
      o.start(t); o.stop(t+0.12);
    }
  }

  function renderVibhag(){
    const taal = currentTaal;
    const wrap = document.getElementById('irVibhag');
    wrap.innerHTML = '';
    let beat = 0;
    taal.vibhags.forEach((vlen, vi) => {
      for(let b=0;b<vlen;b++){
        const el = document.createElement('div');
        el.className = 'ir-beat' + (beat===taal.sam?' sam':'') + (beat===taal.khali?' khali':'');
        el.dataset.beat = beat;
        const bolList = taal.bols.replace(/\|/g,'').trim().split(/\s+/);
        el.textContent = bolList[beat] || (beat+1);
        wrap.appendChild(el);
        beat++;
      }
    });
  }

  function renderTaalBtns(){
    const grid = document.getElementById('irTaalGrid');
    grid.innerHTML = '';
    TAALS.forEach(t => {
      const btn = document.createElement('button');
      btn.className = 'ir-taal-btn' + (t.id===currentTaal.id?' on':'');
      btn.dataset.taalId = t.id;
      const vibStr = t.vibhags.join('+');
      btn.innerHTML = `${t.name}<small>${t.beats} beats · ${vibStr}</small>`;
      btn.addEventListener('click', ()=>{
        currentTaal = t;
        document.querySelectorAll('.ir-taal-btn').forEach(b=>b.classList.toggle('on',b.dataset.taalId===t.id));
        document.getElementById('irBolsRow').textContent = t.bols;
        renderVibhag();
        if(irPlaying){ stopIR(); startIR(); }
      });
      grid.appendChild(btn);
    });
  }

  function advanceIR(){
    const beats = document.querySelectorAll('#irVibhag .ir-beat');
    beats.forEach(b=>b.classList.remove('lit'));
    if(beats[irStep]) beats[irStep].classList.add('lit');
    // Play sound
    if(irStep === currentTaal.sam) playBol('sam');
    else {
      const bolList = currentTaal.bols.replace(/\|/g,'').trim().split(/\s+/);
      const bol = (bolList[irStep]||'').toLowerCase();
      if(bol.startsWith('dha')||bol.startsWith('dhi')||bol.startsWith('ge')||bol.startsWith('na')) playBol('dha');
      else if(bol.startsWith('tin')||bol.startsWith('ti')||bol.startsWith('ta')||bol.startsWith('ke')) playBol('tin');
    }
    irStep = (irStep + 1) % currentTaal.beats;
    document.getElementById('irStatusLbl').textContent = `BEAT ${irStep+1}/${currentTaal.beats}`;
  }

  function startIR(){
    irPlaying = true; irStep = 0;
    irBpm = typeof M !== 'undefined' ? M.bpm : irBpm;
    const interval = 60000 / irBpm;
    irTimerId = setInterval(advanceIR, interval);
    document.getElementById('irPlayBtn').textContent = '■  STOP TAAL';
    document.getElementById('irPlayBtn').classList.add('playing');
  }

  function stopIR(){
    irPlaying = false;
    clearInterval(irTimerId);
    document.querySelectorAll('#irVibhag .ir-beat').forEach(b=>b.classList.remove('lit'));
    document.getElementById('irPlayBtn').textContent = '▶  START TAAL';
    document.getElementById('irPlayBtn').classList.remove('playing');
    document.getElementById('irStatusLbl').textContent = 'STOPPED';
    irStep = 0;
  }

  document.getElementById('irPlayBtn').addEventListener('click', ()=> irPlaying ? stopIR() : startIR());

  // Init
  renderTaalBtns();
  document.getElementById('irBolsRow').textContent = currentTaal.bols;
  renderVibhag();

  // ── Global BPM hook ──
  window._irSetBpm = function(bpm) {
    irBpm = bpm;
    if(irPlaying){ clearInterval(irTimerId); irTimerId = setInterval(advanceIR, 60000/irBpm); }
  };
})();

// ════════════════════════════════════════════════
//  SQUARE PANELS — wrap inner content in scrollable div
// ════════════════════════════════════════════════
(function wrapPanelBodies(){
  // Only wrap panels that don't already have a panel-body and aren't spl-panel
  document.querySelectorAll('.panel').forEach(panel => {
    if(panel.querySelector('.panel-body')) return; // already wrapped
    // Collect all direct children that are NOT the panel-header (.ph), control bar (.ctrl),
    // or resize handle (.resize-handle)
    const children = Array.from(panel.children).filter(el =>
      !el.classList.contains('ph') &&
      !el.classList.contains('ctrl') &&
      !el.classList.contains('resize-handle') &&
      !el.classList.contains('panel-body') &&
      !el.classList.contains('win-min-btn')
    );
    if(children.length === 0) return;
    const body = document.createElement('div');
    body.className = 'panel-body';
    const firstChild = children[0];
    panel.insertBefore(body, firstChild);
    children.forEach(c => body.appendChild(c));
  });
})();

// Minimize buttons are added by the window manager above

// ════════════════════════════════════════════════
//  GLOBAL PLAY / STOP SYSTEM  (unified)
// ════════════════════════════════════════════════
let globalPlaying = false;

// ── Module registry ───────────────────────────
// Each module self-registers via window._gps.register(id, { isPlaying, start, stop })
// after it initialises. The global controller calls these directly.
window._gps = (function(){
  const modules = {};

  function register(id, api){ modules[id] = api; }

  function anyPlaying(){
    return Object.values(modules).some(m => m.isPlaying());
  }

  function stopAll(){
    Object.entries(modules).forEach(([id, m]) => {
      if(m.isPlaying()) m.stop();
    });
  }

  // Start every module whose panel is currently visible
  function startVisible(){
    Object.entries(modules).forEach(([id, m]) => {
      const panel = document.getElementById(m.panelId);
      if(panel && panel.style.display !== 'none' && !m.isPlaying()){
        m.start();
      }
    });
  }

  function refresh(){ updateGlobalPlayState(); }

  return { register, anyPlaying, stopAll, startVisible, refresh, modules };
})();

function updateGlobalPlayState(){
  const anyPlaying = window._gps.anyPlaying();
  globalPlaying = anyPlaying;

  const btn  = document.getElementById('globalPlayBtn');
  const icon = document.getElementById('globalPlayIcon');
  const lbl  = document.getElementById('globalPlayLbl');
  if(!btn) return;

  if(anyPlaying){
    btn.classList.add('playing');
    icon.textContent = '■';
    lbl.textContent  = 'STOP ALL';
  } else {
    btn.classList.remove('playing');
    icon.textContent = '▶';
    lbl.textContent  = 'PLAY ALL';
  }

  // Header playing pill
  const pill = document.getElementById('playingPill');
  if(pill) pill.classList.toggle('playing-active', anyPlaying);

  // Per-module dots on the button
  const dotMap = {
    metro: 'gpbDotMetro',
    drums: 'gpbDotDrums',
    ir:    'gpbDotIR',
    gen:   'gpbDotGen',
    lg:    'gpbDotLg',
  };
  Object.entries(dotMap).forEach(([id, dotId]) => {
    const m = window._gps.modules[id];
    const dot = document.getElementById(dotId);
    if(dot) dot.classList.toggle('active', !!(m && m.isPlaying()));
  });

  // Legacy panel toggle dots
  const panelDotMap = { metro:'dotMetro', drums:'dotDrums', ir:'dotIR' };
  Object.entries(panelDotMap).forEach(([id, dotId]) => {
    const m = window._gps.modules[id];
    const d = document.getElementById(dotId);
    if(d) d.classList.toggle('active', !!(m && m.isPlaying()));
  });
}

// ── Register: Metronome ───────────────────────
window._gps.register('metro', {
  panelId:   'metroPanel',
  isPlaying: () => typeof M !== 'undefined' && M.playing,
  start:     () => { if(typeof startM === 'function') startM(); },
  stop:      () => { if(typeof stopM  === 'function') stopM();  },
});

// ── Register: Drum Loops ──────────────────────
window._drumPlayingRef = false;
window._drumPlaying    = () => window._drumPlayingRef;
window._gps.register('drums', {
  panelId:   'drumsPanel',
  isPlaying: () => window._drumPlayingRef,
  start: () => {
    const btn = document.getElementById('drumPlayBtn');
    if(btn && !window._drumPlayingRef) btn.click();
  },
  stop: () => {
    const btn = document.getElementById('drumPlayBtn');
    if(btn && window._drumPlayingRef) btn.click();
  },
});

// ── Register: Indian Rhythms ──────────────────
window._irPlayingRef = false;
window._irPlaying    = () => window._irPlayingRef;
window._gps.register('ir', {
  panelId:   'indianRhythmsPanel',
  isPlaying: () => window._irPlayingRef,
  start: () => {
    const btn = document.getElementById('irPlayBtn');
    if(btn && !window._irPlayingRef) btn.click();
  },
  stop: () => {
    const btn = document.getElementById('irPlayBtn');
    if(btn && window._irPlayingRef) btn.click();
  },
});

// ── Register: Chord Generator player ─────────
window._genPlayingRef = false;
window._gps.register('gen', {
  panelId:   'theoryPanel',
  isPlaying: () => window._genPlayingRef,
  start: () => {
    const btn = document.getElementById('genPlayBtn');
    if(btn && !window._genPlayingRef) btn.click();
  },
  stop: () => {
    const btn = document.getElementById('genPlayBtn');
    if(btn && window._genPlayingRef) btn.click();
  },
});

// ── Register: Loop / Song Generator ──────────
// (startLg / stopLg / lgPlaying are available after initLoopSongGenerator runs)
window._lgPlayingRef = false;
window._gps.register('lg', {
  panelId:   'loopGenPanel',
  isPlaying: () => !!(window._lgIsPlaying && window._lgIsPlaying()),
  start: () => { if(window._lgStart) window._lgStart(); },
  stop:  () => { if(window._lgStop)  window._lgStop();  },
});

// ── MutationObserver hooks for all play buttons ──
(function wirePlayObservers(){
  function watchBtn(btnId, onchange){
    const btn = document.getElementById(btnId);
    if(!btn) return;
    new MutationObserver(onchange).observe(btn, { attributes: true, attributeFilter: ['class'] });
  }

  watchBtn('playB', () => updateGlobalPlayState());

  watchBtn('drumPlayBtn', () => {
    const btn = document.getElementById('drumPlayBtn');
    window._drumPlayingRef = !!(btn && btn.classList.contains('playing'));
    updateGlobalPlayState();
  });

  watchBtn('irPlayBtn', () => {
    const btn = document.getElementById('irPlayBtn');
    window._irPlayingRef = !!(btn && btn.classList.contains('playing'));
    updateGlobalPlayState();
  });

  watchBtn('genPlayBtn', () => {
    const btn = document.getElementById('genPlayBtn');
    window._genPlayingRef = !!(btn && (btn.classList.contains('playing') || btn.classList.contains('active')));
    updateGlobalPlayState();
  });

  watchBtn('lgPlayBtn', () => updateGlobalPlayState());
  // Also watch second lg play button if it exists
  watchBtn('lgPlayBtn2', () => updateGlobalPlayState());
})();

// ── Global button click ───────────────────────
document.getElementById('globalPlayBtn').addEventListener('click', () => {
  if(window._gps.anyPlaying()){
    window._gps.stopAll();
  } else {
    window._gps.startVisible();
  }
  // Small delay so module states settle before re-reading
  setTimeout(updateGlobalPlayState, 60);
});



// ════════════════════════════════════════════════
//  LISTENING INDICATOR SYSTEM
// ════════════════════════════════════════════════
function updateListeningState(){
  const isListening = micOn === true;
  const dots = ['dotTuner','dotLoudness','dotOsc','dotSpec'];
  dots.forEach(id => {
    const el = document.getElementById(id);
    if(el) el.classList.toggle('active', isListening);
  });
  const pill = document.getElementById('listeningPill');
  const dot  = document.getElementById('listeningDot');
  if(pill && dot){
    if(isListening) pill.classList.add('active');
    else pill.classList.remove('active');
  }
  const micDot = document.getElementById('mic-dot');
  if(micDot) micDot.classList.toggle('on', isListening);
  // Sync genDetectDot
  const genDot = document.getElementById('genDetectDot');
  if(genDot && !isListening) genDot.classList.remove('active');
}
// Call periodically
setInterval(updateListeningState, 500);

// ════════════════════════════════════════════════
//  MIC BUTTON — short click = toggle, right-click = input selector
// ════════════════════════════════════════════════
(function setupMicInput(){
  const micBtn = document.getElementById('micBtn');
  if(!micBtn) return;

  // Right-click to show input selector
  micBtn.addEventListener('contextmenu', async (e) => {
    e.preventDefault();
    const popup = document.getElementById('inputSelectPopup');
    const list  = document.getElementById('audioInputList');
    if(!popup || !list) return;
    list.innerHTML = '';
    try {
      // Use cached permission - don't call getUserMedia again just to enumerate
      let devices;
      if(_micPermissionGranted){
        devices = await navigator.mediaDevices.enumerateDevices();
      } else {
        // Need permission once to get labels
        await _getSharedMicStream(null);
        devices = await navigator.mediaDevices.enumerateDevices();
      }
      const inputs = devices.filter(d => d.kind === 'audioinput');
      if(inputs.length === 0){
        list.innerHTML = '<div class="input-popup-item muted">No audio inputs found</div>';
      } else {
        inputs.forEach(dev => {
          const item = document.createElement('div');
          item.className = 'input-popup-item';
          item.textContent = dev.label || `Microphone ${dev.deviceId.substring(0,8)}`;
          item.addEventListener('click', () => {
            popup.style.display = 'none';
            // Switch device without re-requesting permission
            _preferredAudioDeviceId = dev.deviceId;
            if(micOn){
              // Restart with new device using cached permission
              stopMic();
              startMic(dev.deviceId);
            }
          });
          list.appendChild(item);
        });
      }
    } catch(err) {
      list.innerHTML = '<div class="input-popup-item muted">Permission denied</div>';
    }
    popup.style.left = e.pageX + 'px';
    popup.style.top  = (e.pageY + 4) + 'px';
    popup.style.display = 'block';
  });

  document.addEventListener('click', () => {
    const p = document.getElementById('inputSelectPopup');
    if(p) p.style.display = 'none';
  });
})();

// ════════════════════════════════════════════════
//  MIDI SYSTEM
// ════════════════════════════════════════════════
(function setupMIDI(){
  const midiBtn  = document.getElementById('midiBtn');
  const midiDot  = document.getElementById('midi-dot');
  const midiTxt  = document.getElementById('midiBtnTxt');
  let midiAccess = null;
  let midiEnabled = false;
  let midiInputs = [];
  let lastMidiNotes = new Set(); // currently held MIDI notes

  async function enableMIDI(){
    if(!navigator.requestMIDIAccess){
      alert('Web MIDI API not supported in this browser. Use Chrome or Edge.');
      return;
    }
    try {
      midiAccess = await navigator.requestMIDIAccess();
      midiEnabled = true;
      midiBtn.classList.add('act');
      midiDot.style.background = 'var(--rust)';
      midiTxt.textContent = 'MIDI ON';
      populateMIDIDevices();
      // Listen to all inputs
      midiAccess.inputs.forEach(input => {
        input.onmidimessage = handleMIDIMessage;
        midiInputs.push(input);
      });
      // Watch for new connections
      midiAccess.onstatechange = (e) => {
        populateMIDIDevices();
        if(e.port.type === 'input' && e.port.state === 'connected'){
          e.port.onmidimessage = handleMIDIMessage;
        }
      };
    } catch(err){
      console.warn('MIDI access denied:', err);
      midiTxt.textContent = 'MIDI ✗';
    }
  }

  function disableMIDI(){
    midiEnabled = false;
    if(midiAccess){
      midiAccess.inputs.forEach(i => { i.onmidimessage = null; });
    }
    midiBtn.classList.remove('act');
    midiDot.style.background = '';
    midiTxt.textContent = 'MIDI';
    lastMidiNotes.clear();
  }

  function populateMIDIDevices(){
    const list = document.getElementById('midiDeviceList');
    if(!list || !midiAccess) return;
    list.innerHTML = '';
    if(midiAccess.inputs.size === 0){
      list.innerHTML = '<div class="input-popup-item muted">No MIDI devices connected</div>';
      return;
    }
    midiAccess.inputs.forEach(input => {
      const item = document.createElement('div');
      item.className = 'input-popup-item active';
      item.textContent = '● ' + (input.name || 'MIDI Input');
      list.appendChild(item);
    });
  }

  // MIDI note name lookup
  const MIDI_NOTE_NAMES = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
  function midiToNoteName(midi){ return MIDI_NOTE_NAMES[midi % 12] + Math.floor(midi/12 - 1); }
  function midiToRootName(midi){ return MIDI_NOTE_NAMES[midi % 12]; }

  function handleMIDIMessage(e){
    const [status, note, velocity] = e.data;
    const cmd = status & 0xf0;
    if(cmd === 0x90 && velocity > 0){
      // Note On
      lastMidiNotes.add(note);
    } else if(cmd === 0x80 || (cmd === 0x90 && velocity === 0)){
      // Note Off
      lastMidiNotes.delete(note);
    }
    // Update MIDI note display in generator panel
    const noteName = midiToNoteName(note);
    const genMidi = document.getElementById('genMidiNote');
    if(genMidi && cmd === 0x90 && velocity > 0){
      genMidi.textContent = '🎹 ' + noteName;
      // Highlight in theory if matching root
      highlightMidiInTheory(midiToRootName(note));
    } else if(genMidi && lastMidiNotes.size === 0){
      genMidi.textContent = '';
    }
  }

  function highlightMidiInTheory(rootName){
    // Flash matching chords in theory panel
    document.querySelectorAll('.dc .cn').forEach(el => {
      const txt = el.textContent.trim();
      if(txt.startsWith(rootName)){
        el.closest('.dc').style.boxShadow = '0 0 8px var(--indigo)';
        setTimeout(() => {
          const dc = el.closest('.dc');
          if(dc) dc.style.boxShadow = '';
        }, 600);
      }
    });
  }

  midiBtn.addEventListener('click', () => {
    if(midiEnabled) disableMIDI(); else enableMIDI();
  });

  midiBtn.addEventListener('contextmenu', (e) => {
    e.preventDefault();
    const popup = document.getElementById('midiSelectPopup');
    if(!popup) return;
    populateMIDIDevices();
    popup.style.left = e.pageX + 'px';
    popup.style.top  = (e.pageY + 4) + 'px';
    popup.style.display = 'block';
  });
  document.addEventListener('click', () => {
    const p = document.getElementById('midiSelectPopup');
    if(p) p.style.display = 'none';
  });
})();

// ════════════════════════════════════════════════
//  MASTER VOLUME KNOB
// ════════════════════════════════════════════════
(function setupMasterVol(){
  const knob = document.getElementById('masterVolKnob');
  if(!knob) return;
  knob.addEventListener('input', () => {
    const vol = parseInt(knob.value) / 100;
    // Apply to metronome
    const volSl = document.getElementById('volSl');
    if(volSl){ volSl.value = knob.value; volSl.dispatchEvent(new Event('input')); }
    // Store globally for other engines to read
    window._masterVolume = vol;
  });
  window._masterVolume = 0.8;
})();

// ════════════════════════════════════════════════
//  SWING SYSTEM
// ════════════════════════════════════════════════
let swingAmount = 0; // 0 = straight, 0.33 = hard swing
document.querySelectorAll('#swingBtns .b').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('#swingBtns .b').forEach(b => b.classList.remove('on'));
    btn.classList.add('on');
    swingAmount = parseFloat(btn.dataset.swing || 0);
    window._swingAmount = swingAmount;
    // The metronome scheduler reads window._swingAmount on each tick
  });
});

// Patch metronome scheduler to apply swing
if(typeof sched === 'function'){
  const origSched = sched;
  window._origSched = origSched;
}

// ════════════════════════════════════════════════
//  CLAP / TRANSIENT DETECTION for tempo
// ════════════════════════════════════════════════
(function setupClapDetect(){
  const btn = document.getElementById('ubarClapBtn');
  if(!btn) return;

  let listening = false, clapCtx = null, clapNode = null;
  let clapAnimId = null;

  // Hit detection state
  let clapTimes = [];         // wall-clock ms of detected hits
  let _prevRms = 0;           // RMS follower
  let _lastHit = 0;           // last detected hit time
  const HIT_THRESH = 0.06;    // RMS onset threshold (lower = more sensitive)
  const HIT_COOLDOWN = 160;   // ms min gap between hits
  const INACTIVITY_MS = 3000; // reset after this silence

  // BPM smoothing
  let _smoothBpm = 0;
  let _lastClapBpm = 0;
  let _inactivityTimer = null;

  function resetState(){
    clapTimes = [];
    _smoothBpm = 0;
    _lastClapBpm = 0;
    _prevRms = 0;
  }

  function updateBpmDisplay(bpm){
    btn.textContent = '\u2714 ' + bpm + ' BPM';
  }

  function processHit(now){
    // Flash glow on button
    btn.classList.remove('clap-hit');
    void btn.offsetWidth; // force reflow to restart animation
    btn.classList.add('clap-hit');
    setTimeout(() => btn.classList.remove('clap-hit'), 360);

    clapTimes.push(now);
    if(clapTimes.length > 10) clapTimes.shift();

    // Need at least 2 hits to compute BPM
    if(clapTimes.length < 2) return;

    // Use last 6 intervals, weighted toward recent
    const n = clapTimes.length;
    const intervals = [];
    for(let i = Math.max(1, n-6); i < n; i++){
      intervals.push(clapTimes[i] - clapTimes[i-1]);
    }

    // Filter out outliers (intervals > 3x median are spurious)
    const sorted = [...intervals].sort((a,b)=>a-b);
    const median = sorted[Math.floor(sorted.length/2)];
    const filtered = intervals.filter(iv => iv > 150 && iv < 3000 && iv < median*2.5);
    if(filtered.length === 0) return;

    const avgMs = filtered.reduce((s,v)=>s+v,0) / filtered.length;
    const rawBpm = 60000 / avgMs;

    // Smooth BPM toward detected value
    if(_smoothBpm === 0){
      _smoothBpm = rawBpm;
    } else {
      // Use stronger smoothing if change is small, lighter if big correction
      const diff = Math.abs(rawBpm - _smoothBpm);
      const alpha = diff > 10 ? 0.5 : 0.3;
      _smoothBpm = _smoothBpm * (1-alpha) + rawBpm * alpha;
    }

    const rounded = Math.round(_smoothBpm);
    if(rounded >= 20 && rounded <= 300 && rounded !== _lastClapBpm){
      _lastClapBpm = rounded;
      if(typeof setBPM === 'function'){
        setBPM(rounded); // full sync: updates M.bpm, UI sliders, metronome
      } else if(typeof M !== 'undefined'){
        M.bpm = rounded;
        const numEl = document.getElementById('ubarBpmNum');
        if(numEl) numEl.textContent = rounded;
        const slEl = document.getElementById('ubarBpmSl');
        if(slEl) slEl.value = rounded;
      }
      updateBpmDisplay(rounded);
    }
  }

  function detect(){
    if(!listening || !clapNode) return;
    const buf = new Float32Array(clapNode.fftSize);
    clapNode.getFloatTimeDomainData(buf);
    let sum = 0;
    for(let i = 0; i < buf.length; i++) sum += buf[i]*buf[i];
    const rms = Math.sqrt(sum / buf.length);

    const delta = rms - _prevRms;
    const now = Date.now();

    // Transient onset: RMS spikes up faster than decay
    if(delta > HIT_THRESH && now - _lastHit > HIT_COOLDOWN){
      _lastHit = now;
      processHit(now);

      // Schedule inactivity reset
      clearTimeout(_inactivityTimer);
      _inactivityTimer = setTimeout(() => {
        resetState();
        if(listening) btn.textContent = '\uD83D\uDC4F CLAP';
      }, INACTIVITY_MS);
    }

    // RMS decay: fast attack, slow decay for stable floor
    if(rms > _prevRms) _prevRms = rms;
    else _prevRms = _prevRms * 0.88 + rms * 0.12;

    clapAnimId = requestAnimationFrame(detect);
  }

  let _clapSrc = null; // track media stream source for cleanup

  async function startListening(){
    try {
      // Use shared stream to avoid re-requesting permission
      const stream = await _getSharedMicStream(null);
      if(!clapCtx) clapCtx = new (window.AudioContext||window.webkitAudioContext)();
      if(clapCtx.state === 'suspended') await clapCtx.resume();
      // Disconnect old source if any
      try{ if(_clapSrc){ _clapSrc.disconnect(); _clapSrc = null; } }catch(e){}
      if(clapNode) try{ clapNode.disconnect(); }catch(e){}
      clapNode = clapCtx.createAnalyser();
      clapNode.fftSize = 256;                // smaller = faster response
      clapNode.smoothingTimeConstant = 0;    // Raw data for transient detection
      _clapSrc = clapCtx.createMediaStreamSource(stream);
      _clapSrc.connect(clapNode);
      resetState();
      listening = true;
      btn.classList.add('listening');
      btn.textContent = '\uD83D\uDC4F CLAP...';
      detect();
    } catch(e){
      btn.textContent = '\uD83D\uDC4F CLAP';
      console.warn('Clap detect mic error:', e);
    }
  }

  function stopListening(){
    listening = false;
    if(clapAnimId) cancelAnimationFrame(clapAnimId); clapAnimId = null;
    clearTimeout(_inactivityTimer);
    try{ if(_clapSrc){ _clapSrc.disconnect(); _clapSrc = null; } }catch(e){}
    btn.classList.remove('listening');
    btn.textContent = '\uD83D\uDC4F CLAP';
    resetState();
  }

  btn.addEventListener('click', () => {
    if(listening) stopListening(); else startListening();
  });
})();


// ════════════════════════════════════════════════
//  LOUDNESS METER — seismograph + stats
// ════════════════════════════════════════════════
(function setupLoudnessExtras(){
  const canvas = document.getElementById('splSeismoCvs');
  if(!canvas) return;
  const ctx = canvas.getContext('2d');
  const history = []; // 30-second rolling window at ~10 samples/sec = 300 pts
  const MAX_HIST = 300;
  let startTime = Date.now();
  let peakVal = -Infinity, allVals = [];

  function resizeCanvas(){
    canvas.width = canvas.offsetWidth;
    canvas.height = canvas.offsetHeight || 50;
  }
  resizeCanvas();
  window.addEventListener('resize', resizeCanvas);

  const clock = document.getElementById('splClock');

  function drawSeismo(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    if(history.length < 2) return;
    const w = canvas.width, h = canvas.height;
    // Draw waveform
    ctx.beginPath();
    const step = w / MAX_HIST;
    history.forEach((v, i) => {
      // Normalize -90..0 to 0..1
      const norm = Math.max(0, Math.min(1, v / 120)); // SPL 0-120
      const y = h - norm * h;
      if(i === 0) ctx.moveTo(0, y);
      else ctx.lineTo(i * step, y);
    });
    ctx.strokeStyle = getComputedStyle(document.body).getPropertyValue('--forest') || '#2d5a3d';
    ctx.lineWidth = 1.5;
    ctx.stroke();
  }

  // Hook into the existing SPL updater by polling the splVal element
  setInterval(() => {
    const valEl = document.getElementById('splVal');
    if(!valEl || valEl.textContent === '---') return;
    const v = parseFloat(valEl.textContent);
    if(isNaN(v)) return;
    // Convert dBFS-style to positive display: add ~74dB offset
    const displayDb = Math.round(v + 74);
    // Update history
    history.push(displayDb);
    if(history.length > MAX_HIST) history.shift();
    // Track stats
    allVals.push(displayDb);
    if(allVals.length > 3000) allVals.shift();
    peakVal = Math.max(peakVal, displayDb);
    const avgVal = Math.round(allVals.reduce((a,b)=>a+b,0)/allVals.length);
    const minVal = Math.round(Math.min(...allVals.filter(v=>v>0).slice(-600)));
    // Update stat displays
    const ps = document.getElementById('splPeakStat');
    const as = document.getElementById('splAvgStat');
    const ms = document.getElementById('splMinStat');
    if(ps) ps.textContent = peakVal + ' dB';
    if(as) as.textContent = avgVal + ' dB';
    if(ms) ms.textContent = minVal + ' dB';
    // Update clock
    if(clock){
      const secs = Math.floor((Date.now() - startTime) / 1000);
      const m = String(Math.floor(secs/60)).padStart(2,'0');
      const s = String(secs % 60).padStart(2,'0');
      clock.textContent = m + ':' + s;
    }
    // Rewrite display value to show positive dB
    valEl.textContent = displayDb < 0 ? '0' : String(displayDb);
    drawSeismo();
  }, 100);
})();

// ════════════════════════════════════════════════
//  INDIAN RHYTHMS — speed multiplier + MIDI download
// ════════════════════════════════════════════════
(function setupIRExtras(){
  // Speed buttons
  document.querySelectorAll('#irSpeedBtns .b').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('#irSpeedBtns .b').forEach(b => b.classList.remove('on'));
      btn.classList.add('on');
      const mult = parseFloat(btn.dataset.irspeed || 1);
      if(typeof window._irSetBpm === 'function'){
        const baseBpm = typeof M !== 'undefined' ? M.bpm : 60;
        window._irSetBpm(baseBpm * mult);
      }
    });
  });

  // MIDI export — simple 4-bar MIDI file of the current taal pattern
  const dlBtn = document.getElementById('irDlBtn');
  if(dlBtn){
    dlBtn.addEventListener('click', () => {
      const taalEl = document.querySelector('.ir-taal-btn.on');
      const taalName = taalEl ? taalEl.textContent.trim() : 'taal';
      // Build a simple MIDI file (format 0, 1 track)
      const bpm = typeof M !== 'undefined' ? M.bpm : 60;
      exportSimpleMIDI(`ir_${taalName}`, buildIRMIDI(bpm));
    });
  }

  function buildIRMIDI(bpm){
    // Minimal MIDI format 0 builder
    const tpq = 480; // ticks per quarter
    const usecPerBeat = Math.round(60000000 / bpm);
    const events = [];
    // Tempo event
    events.push({ delta:0, type:'meta', meta:0x51, data:[
      (usecPerBeat>>16)&0xff, (usecPerBeat>>8)&0xff, usecPerBeat&0xff
    ]});
    // Generate 4 bars of downbeat + offbeats (simplified)
    const beatsPerBar = 4;
    for(let bar=0; bar<4; bar++){
      for(let beat=0; beat<beatsPerBar; beat++){
        const note = beat === 0 ? 61 : 60; // D#3 = sam, C3 = regular
        const vel  = beat === 0 ? 110 : 80;
        events.push({ delta: beat===0 && bar===0 ? 0 : tpq, type:'noteon',  ch:9, note, vel });
        events.push({ delta: tpq/4,                          type:'noteoff', ch:9, note, vel:0 });
      }
    }
    events.push({ delta:0, type:'meta', meta:0x2f, data:[] }); // end of track
    return buildMIDIBytes(events, tpq);
  }

  function buildMIDIBytes(events, tpq){
    function varLen(v){ const b=[]; do{let x=v&0x7f;v>>=7;b.unshift(v?x|0x80:x);}while(v);return b; }
    const track = [];
    events.forEach(ev => {
      track.push(...varLen(ev.delta));
      if(ev.type==='noteon')   track.push(0x90|ev.ch, ev.note, ev.vel);
      else if(ev.type==='noteoff') track.push(0x80|ev.ch, ev.note, ev.vel);
      else if(ev.type==='meta'){
        track.push(0xff, ev.meta, ev.data.length, ...ev.data);
      }
    });
    // Header chunk: MThd
    const header = [0x4d,0x54,0x68,0x64,0,0,0,6, 0,0, 0,1, 0,tpq>>8,tpq&0xff];
    // Wait—tpq is 480 = 0x01e0
    header[12]=0; header[13]=1; // format 0 = 1 track
    const hdr = [0x4d,0x54,0x68,0x64,0,0,0,6, 0,0, 0,1, (tpq>>8)&0xff, tpq&0xff];
    const tlen = track.length;
    const trk = [0x4d,0x54,0x72,0x6b, (tlen>>24)&0xff,(tlen>>16)&0xff,(tlen>>8)&0xff,tlen&0xff, ...track];
    return new Uint8Array([...hdr, ...trk]);
  }
})();

// ════════════════════════════════════════════════
//  DRUM LOOPS — MIDI download
// ════════════════════════════════════════════════
document.getElementById('drumDlBtn')?.addEventListener('click', () => {
  exportSimpleMIDI('drum_pattern', buildDrumMIDI());
});

function buildDrumMIDI(){
  const tpq = 480;
  const bpm = typeof M !== 'undefined' ? M.bpm : 120;
  const usecPerBeat = Math.round(60000000 / bpm);
  const events = [];
  events.push({ delta:0, type:'meta', meta:0x51, data:[
    (usecPerBeat>>16)&0xff, (usecPerBeat>>8)&0xff, usecPerBeat&0xff
  ]});
  const GM_MAP = {'Kick':36,'Snare':38,'Hi-Hat':42,'Open HH':46,'Crash':49,'Tom Hi':50,'Tom Lo':45};
  const patternEls = document.querySelectorAll('.drow');
  // Collect all events across 16 steps
  const noteEvents = [];
  patternEls.forEach(row => {
    const instEl = row.querySelector('.drow-lbl');
    if(!instEl) return;
    const inst = instEl.textContent.trim();
    const note = GM_MAP[inst] || 38;
    row.querySelectorAll('.dstep').forEach((step, i) => {
      if(step.classList.contains('on')){
        noteEvents.push({ tick: i * tpq/4, note });
      }
    });
  });
  // Sort by tick
  noteEvents.sort((a,b) => a.tick - b.tick);
  let lastTick = 0;
  noteEvents.forEach(ev => {
    const delta = ev.tick - lastTick;
    events.push({ delta, type:'noteon',  ch:9, note:ev.note, vel:100 });
    events.push({ delta: tpq/8,          type:'noteoff', ch:9, note:ev.note, vel:0 });
    lastTick = ev.tick;
  });
  events.push({ delta:0, type:'meta', meta:0x2f, data:[] });
  return buildMIDIBytesGlobal(events, tpq);
}

function buildMIDIBytesGlobal(events, tpq){
  function varLen(v){ const b=[]; do{let x=v&0x7f;v>>=7;b.unshift(v?x|0x80:x);}while(v);return b; }
  const track = [];
  events.forEach(ev => {
    track.push(...varLen(ev.delta));
    if(ev.type==='noteon')   track.push(0x90|ev.ch, ev.note, ev.vel);
    else if(ev.type==='noteoff') track.push(0x80|ev.ch, ev.note, ev.vel);
    else if(ev.type==='meta') track.push(0xff, ev.meta, ev.data.length, ...ev.data);
  });
  const tlen = track.length;
  const hdr = [0x4d,0x54,0x68,0x64,0,0,0,6, 0,0, 0,1, (tpq>>8)&0xff, tpq&0xff];
  const trk = [0x4d,0x54,0x72,0x6b, (tlen>>24)&0xff,(tlen>>16)&0xff,(tlen>>8)&0xff,tlen&0xff, ...track];
  return new Uint8Array([...hdr, ...trk]);
}

function exportSimpleMIDI(filename, bytes){
  const blob = new Blob([bytes], {type:'audio/midi'});
  const url  = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = filename + '.mid';
  a.click(); URL.revokeObjectURL(url);
}

// ════════════════════════════════════════════════
//  CHORD GENERATOR — basic player strip
// ════════════════════════════════════════════════
(function setupGenPlayer(){
  let genChords = [];    // array of {sym, notes, q} objects
  let genPlaying = false, genLooping = false, genStep = 0, genTimerId = null;

  function buildDefaultChords(){
    if(typeof renderAll !== 'undefined') renderAll(); // ensure theory is rendered
    const cards = document.querySelectorAll('#chordsV .dc');
    if(cards.length === 0) return;
    genChords = [];
    cards.forEach(card => {
      const sym  = card.querySelector('.cn')?.textContent.trim() || '';
      const notes = card.querySelector('.cno')?.textContent.trim() || '';
      if(sym) genChords.push({ sym, notes });
    });
    renderGenChords();
  }

  function renderGenChords(){
    const strip = document.getElementById('genPlayerChords');
    if(!strip) return;
    strip.innerHTML = '';
    genChords.forEach((ch, i) => {
      const chip = document.createElement('div');
      chip.className = 'gen-chord-chip';
      chip.textContent = ch.sym;
      chip.title = ch.notes;
      chip.dataset.i = i;
      chip.addEventListener('click', () => playGenChordAt(i));
      strip.appendChild(chip);
    });
    const strip2 = document.getElementById('genPlayerStrip');
    if(strip2 && genChords.length > 0) strip2.style.display = '';
    // Wire drop targets
    setupDropTarget(strip);
  }

  // Drop target setup for chord player
  function setupDropTarget(el){
    if(!el || el._dropWired) return;
    el._dropWired = true;
    el.addEventListener('dragover', e => {
      e.preventDefault(); e.dataTransfer.dropEffect = 'copy';
      el.classList.add('drag-over');
    });
    el.addEventListener('dragleave', () => el.classList.remove('drag-over'));
    el.addEventListener('drop', e => {
      e.preventDefault();
      el.classList.remove('drag-over');
      try {
        const data = JSON.parse(e.dataTransfer.getData('application/x-chord'));
        if(data && data.sym){
          genChords.push({ sym: data.sym, notes: data.notes || '' });
          renderGenChords();
        }
      } catch(err){}
    });
  }

  function playGenChordAt(i){
    genStep = i;
    document.querySelectorAll('.gen-chord-chip').forEach((c,ci) => c.classList.toggle('playing', ci===i));
    // Play audio via web audio if mic ctx is available
    playChordAudio(genChords[i]);
    // Highlight matching chord in theory panel
    const cards = document.querySelectorAll('#chordsV .dc');
    cards.forEach((card,ci) => card.classList.toggle('dlit', ci===i));
  }

  function playChordAudio(chord){
    try {
      const ctx = new (window.AudioContext||window.webkitAudioContext)();
      const notes = chord.notes.split(/[·,\s]+/).filter(Boolean);
      notes.forEach(n => {
        const freq = noteNameToFreq(n);
        if(!freq) return;
        const osc = ctx.createOscillator();
        const env = ctx.createGain();
        osc.type = 'triangle';
        osc.frequency.value = freq;
        env.gain.setValueAtTime(0,ctx.currentTime);
        env.gain.linearRampToValueAtTime(0.18, ctx.currentTime+0.05);
        env.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime+1.2);
        osc.connect(env); env.connect(ctx.destination);
        osc.start(ctx.currentTime); osc.stop(ctx.currentTime+1.3);
      });
      setTimeout(() => ctx.close(), 2000);
    } catch(e){}
  }

  const NOTE_FREQS = {C:261.63,'C#':277.18,D:293.66,'D#':311.13,E:329.63,F:349.23,'F#':369.99,G:392,'G#':415.3,A:440,'A#':466.16,B:493.88};
  function noteNameToFreq(name){
    const m = name.match(/^([A-G]#?)/);
    if(!m) return null;
    return (NOTE_FREQS[m[1]] || 0) * (name.includes('4') ? 1 : name.includes('3') ? 0.5 : name.includes('5') ? 2 : 1);
  }

  function startGenPlay(){
    genPlaying = true;
    const barsEl = document.getElementById('genBarsSel');
    const bars = barsEl ? parseInt(barsEl.value) : 8;
    const interval = typeof M !== 'undefined' ? (60000/M.bpm)*4 : 2000; // 1 bar
    playGenChordAt(genStep);
    genTimerId = setInterval(() => {
      genStep = (genStep + 1) % genChords.length;
      playGenChordAt(genStep);
    }, interval);
    const playBtn = document.getElementById('genPlayBtn');
    if(playBtn){ playBtn.textContent = '■ STOP'; playBtn.classList.add('active'); }
  }

  function stopGenPlay(){
    genPlaying = false;
    clearInterval(genTimerId);
    document.querySelectorAll('.gen-chord-chip').forEach(c => c.classList.remove('playing'));
    document.querySelectorAll('#chordsV .dc').forEach(c => c.classList.remove('dlit'));
    const playBtn = document.getElementById('genPlayBtn');
    if(playBtn){ playBtn.textContent = '▶ PLAY'; playBtn.classList.remove('active'); }
  }

  document.getElementById('genPlayBtn')?.addEventListener('click', () => {
    if(genChords.length === 0) buildDefaultChords();
    genPlaying ? stopGenPlay() : startGenPlay();
  });

  document.getElementById('genLoopBtn')?.addEventListener('click', (e) => {
    genLooping = !genLooping;
    e.target.classList.toggle('active', genLooping);
  });

  document.getElementById('genShuffleBtn')?.addEventListener('click', () => {
    buildDefaultChords();
    // Shuffle order
    for(let i=genChords.length-1;i>0;i--){
      const j=Math.floor(Math.random()*(i+1));
      [genChords[i],genChords[j]]=[genChords[j],genChords[i]];
    }
    renderGenChords();
  });

  document.getElementById('genDlBtn')?.addEventListener('click', () => {
    if(genChords.length === 0) buildDefaultChords();
    exportSimpleMIDI('chord_progression', buildChordMIDI(genChords));
  });

  function buildChordMIDI(chords){
    const tpq = 480;
    const bpm = typeof M !== 'undefined' ? M.bpm : 120;
    const usec = Math.round(60000000/bpm);
    const NOTE_MIDI = {C:60,'C#':61,D:62,'D#':63,E:64,F:65,'F#':66,G:67,'G#':68,A:69,'A#':70,B:71};
    const events = [];
    events.push({delta:0,type:'meta',meta:0x51,data:[(usec>>16)&0xff,(usec>>8)&0xff,usec&0xff]});
    let lastTick = 0;
    chords.forEach((ch, i) => {
      const tick = i * tpq * 4; // 1 chord per bar
      const notes = ch.notes.split(/[·,\s]+/).filter(Boolean).slice(0,4);
      const midiNotes = notes.map(n => { const r=n.match(/^([A-G]#?)/); return r ? (NOTE_MIDI[r[1]]||60) : 60; });
      midiNotes.forEach(n => {
        events.push({delta: i===0&&midiNotes[0]===n ? 0 : (tick-lastTick), type:'noteon', ch:0, note:n, vel:80});
        lastTick = tick;
      });
      midiNotes.forEach(n => {
        events.push({delta: tpq*4-10, type:'noteoff', ch:0, note:n, vel:0});
      });
    });
    events.push({delta:0,type:'meta',meta:0x2f,data:[]});
    return buildMIDIBytesGlobal(events, tpq);
  }

  // Auto-build when theory view changes
  const viewBtns = document.getElementById('viewBtns');
  if(viewBtns){
    viewBtns.addEventListener('click', () => {
      setTimeout(buildDefaultChords, 50);
    });
  }
  // Initial build after renderAll
  setTimeout(() => {
    buildDefaultChords();
    // Wire the gen player strip as drop target immediately
    const strip = document.getElementById('genPlayerChords');
    if(strip) setupDropTarget(strip);
    const strip2 = document.getElementById('genPlayerStrip');
    if(strip2) { strip2.style.display = ''; }
  }, 200);
})();

// Wire drag from mini chord tiles and mode chord grids via delegation
(function setupTheoryDrag(){
  const theoryPanel = document.getElementById('theoryPanel');
  if(!theoryPanel) return;
  theoryPanel.addEventListener('dragstart', e => {
    const tile = e.target.closest('[data-chord-sym]');
    if(!tile) return;
    const data = { sym: tile.dataset.chordSym, notes: tile.dataset.chordNotes || '', q: tile.dataset.chordQ || '' };
    e.dataTransfer.setData('application/x-chord', JSON.stringify(data));
    e.dataTransfer.effectAllowed = 'copy';
    tile.style.opacity = '0.5';
    tile.addEventListener('dragend', () => { tile.style.opacity = ''; }, { once: true });
  });
})();


// Initial state
updateGlobalPlayState();
updateListeningState();



// _wmInitPanel is exposed directly from the window manager above

// ════════════════════════════════════════════════════════════════
//  SPECTRUM CHORD DETECTOR
// ════════════════════════════════════════════════════════════════
(function setupSpectrumChordDetector(){
  const CHR_S = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
  const NOTE_MIDI = {C:0,'C#':1,D:2,'D#':3,E:4,F:5,'F#':6,G:7,'G#':8,A:9,'A#':10,B:11};

  // Common chord templates [semitone intervals from root]
  const CHORD_TEMPLATES = [
    {name:'maj', ivs:[0,4,7]},
    {name:'min', ivs:[0,3,7]},
    {name:'dim', ivs:[0,3,6]},
    {name:'aug', ivs:[0,4,8]},
    {name:'7',   ivs:[0,4,7,10]},
    {name:'maj7',ivs:[0,4,7,11]},
    {name:'m7',  ivs:[0,3,7,10]},
    {name:'sus2',ivs:[0,2,7]},
    {name:'sus4',ivs:[0,5,7]},
  ];

  let detectedNotes = [];
  let lastChordUpdate = 0;

  function freqToNoteClass(freq){
    if(freq < 20) return -1;
    const midi = Math.round(12 * Math.log2(freq / 440) + 69);
    return ((midi % 12) + 12) % 12;
  }

  function detectChordFromNotes(noteClasses){
    if(noteClasses.length < 2) return null;
    const present = new Set(noteClasses);
    let best = null, bestScore = 0;
    for(let root = 0; root < 12; root++){
      for(const tmpl of CHORD_TEMPLATES){
        const match = tmpl.ivs.filter(iv => present.has((root + iv) % 12)).length;
        const score = match / tmpl.ivs.length;
        if(match >= 2 && score > bestScore){
          bestScore = score;
          best = { root: CHR_S[root], quality: tmpl.name, score };
        }
      }
    }
    return best && bestScore >= 0.66 ? best : null;
  }

  // Hook into the spectrum drawing loop
  const origDrawSpec = window._specHook;

  function analyzeSpectrum(fd, sr){
    if(!fd || !sr) return;
    const now = Date.now();
    if(now - lastChordUpdate < 200) return; // throttle
    lastChordUpdate = now;

    const binCount = fd.length;
    // Find peaks in spectrum
    const peaks = [];
    const thresh = 120; // min amplitude (0-255)
    for(let i = 2; i < binCount - 2; i++){
      const freq = (i / binCount) * (sr / 2);
      if(freq < 60 || freq > 4200) continue; // musical range
      const v = fd[i];
      if(v > thresh && v > fd[i-1] && v > fd[i+1] && v > fd[i-2] && v > fd[i+2]){
        peaks.push({ freq, amp: v });
      }
    }

    // Sort by amplitude, take top 6
    peaks.sort((a,b) => b.amp - a.amp);
    const topPeaks = peaks.slice(0, 6);

    const noteClasses = [...new Set(topPeaks.map(p => freqToNoteClass(p.freq)).filter(n => n >= 0))];
    const chord = detectChordFromNotes(noteClasses);

    // Update UI
    const noteBadge = document.getElementById('specNoteBadge');
    const chordBadge = document.getElementById('specChordBadge');
    const peakFreqEl = document.getElementById('specPeakFreq');

    if(topPeaks.length > 0 && noteBadge){
      const dominant = topPeaks[0];
      const noteClass = freqToNoteClass(dominant.freq);
      const midi = Math.round(12 * Math.log2(dominant.freq / 440) + 69);
      const oct = Math.floor(midi / 12) - 1;
      noteBadge.textContent = noteClass >= 0 ? (CHR_S[noteClass] + oct) : '--';
      if(peakFreqEl) peakFreqEl.textContent = dominant.freq.toFixed(1) + ' Hz';
    } else if(noteBadge) {
      noteBadge.textContent = '--';
    }

    if(chordBadge){
      if(chord){
        chordBadge.textContent = chord.root + chord.quality;
        chordBadge.classList.add('visible');
      } else {
        chordBadge.classList.remove('visible');
      }
    }
  }

  // Register the analyzer to be called from the main viz loop
  window._spectrumAnalyzer = analyzeSpectrum;
})();

// ════════════════════════════════════════════════════════════════
//  PATCH startViz to call spectrum chord analyzer
// ════════════════════════════════════════════════════════════════
(function patchVizForSpectrum(){
  const origStartViz = window.startViz;
  if(typeof startViz !== 'undefined'){
    // startViz is defined at module scope, we patch via the draw callback
    // We'll hook into the frequency data extraction
  }
  // Direct patch: override the fd processing in startViz by monkey-patching
  // the analyser.getByteFrequencyData function
  const origGetByteFreq = AnalyserNode.prototype.getByteFrequencyData;
  let lastFd = null, lastSr = null;
  AnalyserNode.prototype.getByteFrequencyData = function(arr){
    origGetByteFreq.call(this, arr);
    lastFd = arr;
    if(window._spectrumAnalyzer && this.context){
      lastSr = this.context.sampleRate;
      window._spectrumAnalyzer(arr, lastSr);
    }
  };
})();

// ════════════════════════════════════════════════════════════════
//  METRONOME OSCILLOSCOPE / RUSH-DRAG DETECTOR
//  — Real waveform display, BPM-aligned tempo grid, live mic transient detection
// ════════════════════════════════════════════════════════════════
(function setupMetroOsc(){
  const cvs = document.getElementById('metroOscCvs');
  if(!cvs) return;
  const ctx = cvs.getContext('2d');
  const statusEl = document.getElementById('metroOscStatus');

  let metroBeats = [];        // {t: ms} — metronome click timestamps
  let inputTransients = [];   // {t: ms} — detected user hit timestamps
  const WINDOW = 4000;        // ms to display

  // Waveform ring buffer for display
  const WAVE_CAP = 1024;
  const waveBuf = new Float32Array(WAVE_CAP);
  let waveHead = 0;

  // Transient detection state
  let _prevRms = 0;
  const TRANSIENT_THRESH = 0.10;
  const TRANSIENT_COOLDOWN = 80;   // ms min gap between detected hits
  let _lastHitMs = 0;
  let _smoothedOffset = 0;

  // ── Public API called by other subsystems ──────────────────
  window._metroOscBeat = function(tMs){
    metroBeats.push({ t: tMs });
    if(metroBeats.length > 128) metroBeats.shift();
  };

  window._metroOscPushWave = function(samples){
    for(let i = 0; i < samples.length; i++){
      waveBuf[waveHead % WAVE_CAP] = samples[i];
      waveHead++;
    }
  };

  window._metroOscRms = function(rms){
    const now = Date.now();
    const delta = rms - _prevRms;
    if(delta > TRANSIENT_THRESH && now - _lastHitMs > TRANSIENT_COOLDOWN){
      inputTransients.push({ t: now });
      if(inputTransients.length > 128) inputTransients.shift();
      _lastHitMs = now;
    }
    _prevRms = _prevRms * 0.5 + rms * 0.5;
  };

  // ── Dedicated mic analyser for when main mic is off ────────
  let _mNode = null, _mCtx = null, _mRunning = false;

  function startMetroMicInput(){
    if(_mRunning) return;
    if(typeof micOn !== 'undefined' && micOn && typeof analyser !== 'undefined' && analyser) return;
    (async () => {
      try {
        const stream = await _getSharedMicStream(null);
        _mCtx = _mCtx || new (window.AudioContext||window.webkitAudioContext)();
        if(_mCtx.state === 'suspended') await _mCtx.resume();
        _mNode = _mCtx.createAnalyser();
        _mNode.fftSize = 512;
        _mCtx.createMediaStreamSource(stream).connect(_mNode);
        _mRunning = true;
        const buf = new Float32Array(512);
        (function tick(){
          if(!_mRunning) return;
          _mNode.getFloatTimeDomainData(buf);
          window._metroOscPushWave(buf.subarray(0, 64));
          let s = 0;
          for(let i = 0; i < buf.length; i++) s += buf[i]*buf[i];
          window._metroOscRms(Math.sqrt(s / buf.length));
          requestAnimationFrame(tick);
        })();
      } catch(e){ /* mic permission denied — visuals work, transients won't */ }
    })();
  }

  // Hook: auto-start mic when metronome starts
  window.addEventListener('load', () => {
    const _origStartM = window.startM;
    if(typeof _origStartM === 'function'){
      window.startM = function(){
        _origStartM.apply(this, arguments);
        startMetroMicInput();
      };
    }
  });

  // ── Resize canvas ──────────────────────────────────────────
  function resize(){
    const dpr = window.devicePixelRatio || 1;
    const w = cvs.offsetWidth, h = cvs.offsetHeight || 80;
    const tw = Math.round(w*dpr), th = Math.round(h*dpr);
    if(cvs.width !== tw || cvs.height !== th){
      cvs.width = tw; cvs.height = th;
      ctx.setTransform(1,0,0,1,0,0); ctx.scale(dpr,dpr);
    }
  }
  resize();
  window.addEventListener('resize', resize);

  // ── Main draw loop ─────────────────────────────────────────
  function draw(){
    resize();
    const w = cvs.offsetWidth, h = cvs.offsetHeight || 80;
    const dark = document.body.classList.contains('dark');
    const now = Date.now();
    const tStart = now - WINDOW;

    ctx.fillStyle = dark ? 'rgba(18,14,8,0.96)' : 'rgba(250,247,241,0.96)';
    ctx.fillRect(0, 0, w, h);

    // ─ TEMPO GRID ───────────────────────────────────────────
    const bpm = (typeof M !== 'undefined') ? M.bpm : 120;
    const sub  = (typeof M !== 'undefined') ? M.sub  : 1;
    const beatMs = 60000 / bpm;
    const subMs  = beatMs / Math.max(sub, 1);
    const lastBeat = metroBeats.length > 0 ? metroBeats[metroBeats.length-1].t : now;

    // Subdivision lines (lighter)
    if(sub > 1){
      let subT = lastBeat;
      while(subT > tStart - subMs) subT -= subMs;
      ctx.lineWidth = 0.5;
      ctx.strokeStyle = dark ? 'rgba(200,178,140,0.06)' : 'rgba(55,40,20,0.04)';
      ctx.beginPath();
      for(let t = subT; t <= now + beatMs; t += subMs){
        const x = ((t - tStart) / WINDOW) * w;
        if(x >= 0 && x <= w){ ctx.moveTo(x,0); ctx.lineTo(x,h); }
      }
      ctx.stroke();
    }

    let gridT = lastBeat;
    while(gridT > tStart) gridT -= beatMs;
    gridT += beatMs;

    ctx.lineWidth = 1;
    for(let t = gridT; t <= now + beatMs; t += beatMs){
      const x = ((t - tStart) / WINDOW) * w;
      if(x < -2 || x > w + 2) continue;
      const isClick = metroBeats.some(b => Math.abs(b.t - t) < 15);
      ctx.lineWidth = isClick ? 1.5 : 1;
      ctx.strokeStyle = isClick
        ? (dark ? 'rgba(200,178,140,0.3)' : 'rgba(55,40,20,0.22)')
        : (dark ? 'rgba(200,178,140,0.10)' : 'rgba(55,40,20,0.07)');
      ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,h); ctx.stroke();
    }

    // Center line
    ctx.strokeStyle = dark ? 'rgba(200,178,140,0.12)' : 'rgba(55,40,20,0.10)';
    ctx.beginPath(); ctx.moveTo(0,h/2); ctx.lineTo(w,h/2); ctx.stroke();

    // ─ WAVEFORM ─────────────────────────────────────────────
    const dispN = Math.min(waveHead, WAVE_CAP);
    if(dispN > 4){
      ctx.beginPath();
      ctx.strokeStyle = dark ? 'rgba(94,196,122,0.80)' : 'rgba(45,90,61,0.70)';
      ctx.lineWidth = 1.5;
      const rStart = ((waveHead - dispN) + WAVE_CAP) % WAVE_CAP;
      for(let i = 0; i < dispN; i++){
        const idx = (rStart + i) % WAVE_CAP;
        const x = (i / (dispN-1)) * w;
        const y = h/2 - waveBuf[idx] * h * 0.44;
        if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      }
      ctx.stroke();
      ctx.lineWidth = 1;
    }

    // ─ BEAT CLICK MARKERS (green — top) ────────────────────
    metroBeats.filter(b => b.t >= tStart).forEach(b => {
      const x = ((b.t - tStart) / WINDOW) * w;
      ctx.fillStyle = dark ? 'rgba(0,215,105,0.9)' : 'rgba(40,125,60,0.9)';
      ctx.fillRect(x-1,0,2,h*0.38);
      ctx.beginPath(); ctx.arc(x,5,3.5,0,Math.PI*2); ctx.fill();
    });

    // ─ INPUT TRANSIENT MARKERS (amber — bottom) ────────────
    inputTransients.filter(t => t.t >= tStart).forEach(t => {
      const x = ((t.t - tStart) / WINDOW) * w;
      ctx.fillStyle = dark ? 'rgba(255,170,0,0.9)' : 'rgba(185,75,0,0.9)';
      ctx.fillRect(x-1,h*0.62,2,h*0.38);
      ctx.beginPath(); ctx.arc(x,h-5,3.5,0,Math.PI*2); ctx.fill();
    });

    // ─ RUSH/DRAG STATUS ─────────────────────────────────────
    if(statusEl){
      const rb = metroBeats.filter(b => b.t >= tStart);
      const rh = inputTransients.filter(t => t.t >= now - beatMs*4 && t.t >= tStart);
      if(rb.length >= 1 && rh.length >= 1){
        let total = 0, cnt = 0;
        rh.slice(-6).forEach(tr => {
          const nearest = rb.reduce((best, b) =>
            Math.abs(b.t-tr.t) < Math.abs(best.t-tr.t) ? b : best
          );
          const off = tr.t - nearest.t;
          if(Math.abs(off) < beatMs * 0.55){ total += off; cnt++; }
        });
        if(cnt > 0){
          _smoothedOffset = _smoothedOffset * 0.65 + (total/cnt) * 0.35;
          const ms = Math.round(_smoothedOffset);
          statusEl.className = 'metro-osc-status';
          if(_smoothedOffset < -25){
            statusEl.textContent = '\u26A1 RUSHING  ' + Math.abs(ms) + 'ms early';
            statusEl.classList.add('rushing');
          } else if(_smoothedOffset > 25){
            statusEl.textContent = '\u23F3 DRAGGING  ' + ms + 'ms late';
            statusEl.classList.add('dragging');
          } else {
            statusEl.textContent = '\u2713 IN GROOVE  ' + (ms>0?'+':'') + ms + 'ms';
            statusEl.classList.add('intune');
          }
        }
      } else if(rb.length === 0){
        statusEl.textContent = '';
        statusEl.className = 'metro-osc-status';
      }
    }

    requestAnimationFrame(draw);
  }
  requestAnimationFrame(draw);
})();

// ── Patch playClick to emit beat timestamps ────────────────────
(function patchMetroForOsc(){
  const _orig = window.playClick;
  if(typeof playClick !== 'function') return;
  window.playClick = function(when, accent, sub){
    if(_orig) _orig.call(this, when, accent, sub);
    if(!sub && window._metroOscBeat){
      const mctx = typeof getMCtx === 'function' ? getMCtx() : null;
      if(mctx){
        const delay = Math.max(0, (when - mctx.currentTime) * 1000);
        setTimeout(() => window._metroOscBeat(Date.now()), delay);
      }
    }
  };
})();

// ── Feed main mic data to metro osc when main mic is active ───
(function hookMainMicIntoMetroOsc(){
  let _lastFeed = 0;
  (function poll(){
    if(typeof micOn !== 'undefined' && micOn &&
       typeof analyser !== 'undefined' && analyser &&
       typeof window._metroOscPushWave === 'function'){
      const now = Date.now();
      if(now - _lastFeed > 22){
        const buf = new Float32Array(256);
        analyser.getFloatTimeDomainData(buf);
        window._metroOscPushWave(buf.subarray(0,64));
        let s = 0;
        for(let i = 0; i < buf.length; i++) s += buf[i]*buf[i];
        if(window._metroOscRms) window._metroOscRms(Math.sqrt(s/buf.length));
        _lastFeed = now;
      }
    }
    requestAnimationFrame(poll);
  })();
})();

// ════════════════════════════════════════════════════════════════
//  LOOP / SONG GENERATOR ENGINE
// ════════════════════════════════════════════════════════════════
(function initLoopSongGenerator(){
  if(!document.getElementById('loopGenPanel')) return;

  // ── Theory engine (re-uses CHR, QI, na, cn etc. from parent scope) ──
  const CHR_G = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
  function naG(root, s){ return CHR_G[(CHR_G.indexOf(root)+s+120)%12]; }
  function cnG(root, q){ return (window.QI&&window.QI[q]||[0,4,7]).map(i=>naG(root,i)); }
  function csG(root, q){
    const m={maj:'',min:'m',dom:'7',dim:'°',aug:'+',maj7:'maj7',min7:'m7',dom7:'7',m7b5:'m7♭5'};
    return root+(m[q]??'');
  }

  // ── Genre chord vocabulary ──
  const GENRE_DATA = {
    pop: {
      progressions: [
        [{d:0,q:'maj'},{d:5,q:'min'},{d:9,q:'min'},{d:7,q:'maj'}],  // I-vi-IV-V
        [{d:0,q:'maj'},{d:7,q:'maj'},{d:5,q:'min'},{d:9,q:'min'}],  // I-V-vi-IV
        [{d:0,q:'maj'},{d:9,q:'min'},{d:5,q:'min'},{d:7,q:'maj'}],  // I-vi-IV-V alt
        [{d:0,q:'maj'},{d:5,q:'maj'},{d:7,q:'maj'},{d:5,q:'maj'}],  // I-IV-V-IV
      ],
      sections: ['Intro','Verse','Chorus','Bridge','Chorus','Outro'],
      jazzProgs: [
        [{d:0,q:'maj7'},{d:5,q:'min7'},{d:9,q:'min7'},{d:7,q:'dom7'}],
      ]
    },
    rock: {
      progressions: [
        [{d:0,q:'maj'},{d:7,q:'maj'},{d:5,q:'maj'},{d:4,q:'maj'}],  // I-V-IV-III
        [{d:0,q:'maj'},{d:3,q:'maj'},{d:7,q:'maj'},{d:4,q:'maj'}],
        [{d:0,q:'min'},{d:7,q:'maj'},{d:5,q:'maj'},{d:3,q:'maj'}],
        [{d:0,q:'maj'},{d:0,q:'maj'},{d:7,q:'maj'},{d:5,q:'maj'}],
      ],
      sections: ['Intro','Verse','Verse','Chorus','Solo','Chorus','Outro'],
      jazzProgs: []
    },
    jazz: {
      progressions: [
        [{d:0,q:'maj7'},{d:5,q:'dom7'},{d:9,q:'min7'},{d:2,q:'dom7'}],  // I-IV7-ii7-V7
        [{d:0,q:'maj7'},{d:9,q:'min7'},{d:2,q:'dom7'},{d:0,q:'maj7'}],  // ii-V-I
        [{d:0,q:'min7'},{d:5,q:'dom7'},{d:3,q:'maj7'},{d:10,q:'dom7'}], // i-IV-bIII-bVII
        [{d:9,q:'min7'},{d:2,q:'dom7'},{d:0,q:'maj7'},{d:5,q:'dom7'}],
      ],
      sections: ['Intro','Head A','Head B','Solo','Head A','Outro'],
      jazzProgs: []
    },
    blues: {
      progressions: [
        // 12-bar blues
        [{d:0,q:'dom'},{d:0,q:'dom'},{d:0,q:'dom'},{d:0,q:'dom'},
         {d:5,q:'dom'},{d:5,q:'dom'},{d:0,q:'dom'},{d:0,q:'dom'},
         {d:7,q:'dom'},{d:5,q:'dom'},{d:0,q:'dom'},{d:7,q:'dom'}],
      ],
      sections: ['Intro','Blues A','Blues B','Blues C','Solo','Blues A','Outro'],
      jazzProgs: []
    },
    classical: {
      progressions: [
        [{d:0,q:'maj'},{d:7,q:'maj'},{d:0,q:'maj'},{d:7,q:'maj'}],
        [{d:0,q:'maj'},{d:5,q:'maj'},{d:2,q:'min'},{d:7,q:'maj'}],
        [{d:0,q:'maj'},{d:9,q:'min'},{d:7,q:'maj'},{d:0,q:'maj'}],
      ],
      sections: ['Introduction','Exposition A','Exposition B','Development','Recapitulation','Coda'],
      jazzProgs: []
    },
    edm: {
      progressions: [
        [{d:9,q:'min'},{d:0,q:'maj'},{d:7,q:'maj'},{d:5,q:'maj'}],
        [{d:0,q:'min'},{d:7,q:'maj'},{d:3,q:'maj'},{d:5,q:'dom'}],
        [{d:0,q:'maj'},{d:7,q:'maj'},{d:5,q:'maj'},{d:9,q:'min'}],
      ],
      sections: ['Intro','Build','Drop','Break','Build','Drop','Outro'],
      jazzProgs: []
    },
    rnb: {
      progressions: [
        [{d:0,q:'maj7'},{d:9,q:'min7'},{d:5,q:'min7'},{d:7,q:'dom7'}],
        [{d:0,q:'min7'},{d:3,q:'maj7'},{d:5,q:'dom7'},{d:0,q:'min7'}],
        [{d:0,q:'maj7'},{d:5,q:'dom7'},{d:9,q:'min7'},{d:2,q:'dom7'}],
      ],
      sections: ['Intro','Verse','Pre-Chorus','Chorus','Bridge','Chorus','Outro'],
      jazzProgs: []
    },
    folk: {
      progressions: [
        [{d:0,q:'maj'},{d:7,q:'maj'},{d:5,q:'maj'},{d:0,q:'maj'}],
        [{d:0,q:'maj'},{d:5,q:'maj'},{d:0,q:'maj'},{d:7,q:'maj'}],
        [{d:0,q:'maj'},{d:2,q:'min'},{d:5,q:'maj'},{d:7,q:'maj'}],
      ],
      sections: ['Intro','Verse','Chorus','Verse','Chorus','Outro'],
      jazzProgs: []
    },
    hindustani: {
      progressions: [
        [{d:0,q:'maj'},{d:5,q:'maj'},{d:7,q:'maj'},{d:0,q:'maj'}],    // Sa-Ma-Pa-Sa
        [{d:0,q:'min'},{d:1,q:'maj'},{d:5,q:'maj'},{d:0,q:'min'}],    // Bhairav feel
        [{d:0,q:'maj'},{d:6,q:'maj'},{d:7,q:'maj'},{d:0,q:'maj'}],    // Kalyan feel
      ],
      sections: ['Alap','Jod','Gat (slow)','Gat (fast)','Jhala','Coda'],
      jazzProgs: []
    }
  };

  const NOTE_MIDI_G = {C:60,'C#':61,D:62,'D#':63,E:64,F:65,'F#':66,G:67,'G#':68,A:69,'A#':70,B:71};

  let lgGenre = 'pop', lgType = 'loop', lgComplexity = 3, lgJazzUp = false;
  let lgLoopBars = 8, lgSongMins = 3;
  let lgStructure = []; // array of {name, bars, chords:[{root,quality,sym,notes,rom}]}
  let lgPlaying = false, lgLooping = false, lgStep = 0, lgSectionStep = 0, lgTimerId = null;
  let lgGenACtx = null;

  function getLgACtx(){
    if(!lgGenACtx) lgGenACtx = new(window.AudioContext||window.webkitAudioContext)();
    return lgGenACtx;
  }

  function bpmToBarMs(){
    const bpm = (typeof M !== 'undefined' && M.bpm) ? M.bpm : 120;
    return (60000 / bpm) * 4;
  }

  function progressionToChords(prog){
    const root = (typeof cRoot !== 'undefined') ? cRoot : 'C';
    const useJazz = lgJazzUp;
    return prog.map((p, i) => {
      const r = naG(root, p.d);
      let q = p.q;
      if(useJazz && q === 'maj') q = 'maj7';
      if(useJazz && q === 'min') q = 'min7';
      if(useJazz && q === 'dom') q = 'dom7';
      const notes = cnG(r, q);
      return {
        root: r, quality: q,
        sym: csG(r, q),
        notes: notes.join('·'),
        rom: ['I','II','III','IV','V','VI','VII'][i % 7] || String(i+1)
      };
    });
  }

  function pickProgression(){
    const data = GENRE_DATA[lgGenre] || GENRE_DATA.pop;
    const progs = (lgJazzUp && data.jazzProgs && data.jazzProgs.length > 0)
      ? data.jazzProgs : data.progressions;
    const idx = Math.floor(Math.random() * progs.length);
    return progressionToChords(progs[idx]);
  }

  function barCount(sectionName){
    // Different sections get different bar lengths
    const short = ['Intro','Outro','Coda','Alap','Jhala'];
    const long  = ['Development','Recapitulation','Solo','Gat (fast)'];
    if(lgType === 'loop') return lgLoopBars;
    if(short.some(s => sectionName.includes(s))) return 4;
    if(long.some(s => sectionName.includes(s)))  return 16;
    return 8;
  }

  function generate(){
    const data = GENRE_DATA[lgGenre] || GENRE_DATA.pop;
    const sectionNames = [...data.sections];

    // For song: create sections; for loop: single section
    if(lgType === 'loop'){
      const chords = pickProgression();
      lgStructure = [{
        name: 'Loop',
        bars: lgLoopBars,
        chords: chords,
        open: false
      }];
    } else {
      // Estimate bars per section to fill song duration
      const bpm = (typeof M !== 'undefined' && M.bpm) ? M.bpm : 120;
      const totalBars = Math.round((lgSongMins * 60 * bpm) / (4 * bpm / bpm) * bpm / bpm);
      // Simpler: totalBars ≈ (lgSongMins * 60) / (4 bars * (60/bpm))
      const secCount = sectionNames.length;

      lgStructure = sectionNames.map(name => ({
        name,
        bars: barCount(name),
        chords: pickProgression(),
        open: false
      }));
    }

    renderStructure();
    updateLgStatus('READY');
  }

  function renderStructure(){
    const el = document.getElementById('lgStructure');
    if(!el) return;
    el.innerHTML = '';
    lgStructure.forEach((sec, si) => {
      const div = document.createElement('div');
      div.className = 'lg-section' + (sec.open ? ' open' : '');
      div.dataset.si = si;

      const preview = sec.chords.map(c => c.sym).join(' → ');
      div.innerHTML = `
        <div class="lg-sec-hdr">
          <span class="lg-sec-name">${sec.name}</span>
          <span class="lg-sec-bars">${sec.bars} bars</span>
          <span class="lg-sec-chords-preview">${preview}</span>
          <span style="font-size:9px;color:var(--t4);margin-left:auto">${sec.open?'▲':'▼'}</span>
        </div>
        <div class="lg-sec-body">
          <div class="chord-edit-row" id="lgChords-${si}"></div>
        </div>`;

      div.querySelector('.lg-sec-hdr').addEventListener('click', () => {
        sec.open = !sec.open;
        div.classList.toggle('open', sec.open);
        if(sec.open) renderSectionChords(sec, si);
        const arr = div.querySelector('.lg-sec-hdr span:last-child');
        if(arr) arr.textContent = sec.open ? '▲' : '▼';
      });

      el.appendChild(div);
    });
  }

  function renderSectionChords(sec, si){
    const row = document.getElementById('lgChords-' + si);
    if(!row) return;
    row.innerHTML = '';
    sec.chords.forEach((ch, ci) => {
      const chip = document.createElement('div');
      chip.className = 'lg-chord-chip';
      chip.dataset.si = si; chip.dataset.ci = ci;
      chip.innerHTML = `
        <span class="chip-rom">${ch.rom}</span>
        <span class="chip-name">${ch.sym}</span>
        <span class="chip-notes">${ch.notes}</span>`;
      chip.addEventListener('click', () => openChordEditor(si, ci));
      row.appendChild(chip);
    });
    // Add + button
    const addBtn = document.createElement('button');
    addBtn.className = 'lg-chord-chip';
    addBtn.innerHTML = '<span class="chip-name" style="font-size:18px;line-height:1">+</span>';
    addBtn.title = 'Add chord';
    addBtn.addEventListener('click', () => {
      // Add a IV chord by default
      const root = (typeof cRoot !== 'undefined') ? cRoot : 'C';
      const newCh = { root: naG(root,5), quality: 'maj', sym: naG(root,5), notes: cnG(naG(root,5),'maj').join('·'), rom: 'NEW' };
      sec.chords.push(newCh);
      renderSectionChords(sec, si);
    });
    row.appendChild(addBtn);
  }

  // Chord editor modal
  function openChordEditor(si, ci){
    const sec = lgStructure[si];
    if(!sec) return;
    const ch = sec.chords[ci];

    let modal = document.getElementById('lgChordEditModal');
    let overlay = document.getElementById('lgChordEditOverlay');
    if(!modal){
      modal = document.createElement('div'); modal.id = 'lgChordEditModal';
      overlay = document.createElement('div'); overlay.id = 'lgChordEditOverlay';
      document.body.appendChild(overlay);
      document.body.appendChild(modal);
      overlay.addEventListener('click', closeChordEditor);
    }

    const roots = CHR_G;
    const qualities = lgJazzUp
      ? ['maj','min','maj7','min7','dom7','m7b5','dim','aug','sus2','sus4']
      : ['maj','min','dom','dim','aug','sus2','sus4'];

    modal.innerHTML = `
      <div style="font-family:var(--mono);font-size:10px;letter-spacing:2px;color:var(--t3);margin-bottom:10px">EDIT CHORD — ${sec.name} · chord ${ci+1}</div>
      <div style="font-family:var(--mono);font-size:10px;color:var(--t4);margin-bottom:4px">ROOT</div>
      <div class="chord-edit-row" id="ceRoots">${roots.map(r=>`<button class="chord-edit-opt${ch.root===r?' on':''}" data-root="${r}">${r}</button>`).join('')}</div>
      <div style="font-family:var(--mono);font-size:10px;color:var(--t4);margin:8px 0 4px">QUALITY</div>
      <div class="chord-edit-row" id="ceQualities">${qualities.map(q=>`<button class="chord-edit-opt${ch.quality===q?' on':''}" data-qual="${q}">${q}</button>`).join('')}</div>
      <div style="display:flex;gap:8px;margin-top:12px">
        <button class="gen-btn" id="ceApply" style="flex:1">✓ APPLY</button>
        <button class="gen-btn" id="ceRemove" style="flex:1;background:var(--panel2)">✕ REMOVE</button>
        <button class="gen-btn" id="ceClose" style="flex:1;background:var(--panel2)">CANCEL</button>
      </div>`;

    let selRoot = ch.root, selQual = ch.quality;
    modal.querySelector('#ceRoots').addEventListener('click', e => {
      const r = e.target.dataset.root; if(!r) return;
      selRoot = r;
      modal.querySelectorAll('#ceRoots .chord-edit-opt').forEach(b=>b.classList.toggle('on',b.dataset.root===r));
    });
    modal.querySelector('#ceQualities').addEventListener('click', e => {
      const q = e.target.dataset.qual; if(!q) return;
      selQual = q;
      modal.querySelectorAll('#ceQualities .chord-edit-opt').forEach(b=>b.classList.toggle('on',b.dataset.qual===q));
    });
    modal.querySelector('#ceApply').addEventListener('click', () => {
      const notes = cnG(selRoot, selQual);
      sec.chords[ci] = { root: selRoot, quality: selQual, sym: csG(selRoot,selQual), notes: notes.join('·'), rom: ch.rom };
      renderSectionChords(sec, si);
      renderStructure();
      closeChordEditor();
    });
    modal.querySelector('#ceRemove').addEventListener('click', () => {
      sec.chords.splice(ci, 1);
      renderSectionChords(sec, si);
      closeChordEditor();
    });
    modal.querySelector('#ceClose').addEventListener('click', closeChordEditor);

    modal.classList.add('open'); overlay.classList.add('open');
  }

  function closeChordEditor(){
    const modal = document.getElementById('lgChordEditModal');
    const overlay = document.getElementById('lgChordEditOverlay');
    if(modal) modal.classList.remove('open');
    if(overlay) overlay.classList.remove('open');
  }

  // ── Playback ──
  function getAllChords(){
    const all = [];
    lgStructure.forEach(sec => sec.chords.forEach(ch => all.push(ch)));
    return all;
  }

  function playChordAudioLg(chord){
    try {
      const ctx = getLgACtx();
      if(ctx.state === 'suspended') ctx.resume();
      const root = (typeof cRoot !== 'undefined') ? cRoot : 'C';
      const notes = chord.notes.split('·').filter(Boolean).slice(0,4);
      const masterVol = (typeof document !== 'undefined' && document.getElementById('masterVolKnob'))
        ? parseInt(document.getElementById('masterVolKnob').value || 80) / 100 : 0.7;
      notes.forEach(n => {
        const base = NOTE_MIDI_G[n] || 60;
        const freq = 440 * Math.pow(2, (base - 69) / 12);
        const osc = ctx.createOscillator();
        const env = ctx.createGain();
        osc.type = 'triangle';
        osc.frequency.value = freq;
        env.gain.setValueAtTime(0, ctx.currentTime);
        env.gain.linearRampToValueAtTime(masterVol * 0.18, ctx.currentTime + 0.02);
        env.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 2.5);
        osc.connect(env); env.connect(ctx.destination);
        osc.start(ctx.currentTime); osc.stop(ctx.currentTime + 2.6);
      });
    } catch(e) {}
  }

  let lgAllChords = [];
  let lgChordIdx = 0, lgTotalBars = 0;

  function startLg(){
    lgAllChords = getAllChords();
    if(!lgAllChords.length){ generate(); lgAllChords = getAllChords(); }
    lgChordIdx = 0;
    playLgChord();
    updateLgStatus('PLAYING');
    lgPlaying = true;
    updateLgBtns();
    if(typeof updateGlobalPlayState === 'function') updateGlobalPlayState();
  }

  function playLgChord(){
    if(!lgPlaying) return;
    if(lgChordIdx >= lgAllChords.length){
      if(lgLooping){ lgChordIdx = 0; } else { stopLg(); return; }
    }
    const ch = lgAllChords[lgChordIdx];
    playChordAudioLg(ch);
    // Highlight playing chip
    document.querySelectorAll('.lg-chord-chip').forEach(c => c.classList.remove('playing'));
    // Find current section/chord index
    let cumulative = 0;
    lgStructure.forEach((sec, si) => {
      sec.chords.forEach((_, ci) => {
        if(cumulative === lgChordIdx){
          const chip = document.querySelector(`#lgChords-${si} .lg-chord-chip:nth-child(${ci+1})`);
          if(chip) chip.classList.add('playing');
        }
        cumulative++;
      });
    });
    lgChordIdx++;
    const barMs = bpmToBarMs();
    lgTimerId = setTimeout(playLgChord, barMs);
  }

  function stopLg(){
    lgPlaying = false;
    clearTimeout(lgTimerId);
    document.querySelectorAll('.lg-chord-chip').forEach(c => c.classList.remove('playing'));
    updateLgStatus('STOPPED');
    updateLgBtns();
    if(typeof updateGlobalPlayState === 'function') updateGlobalPlayState();
  }

  function updateLgStatus(txt){
    const el = document.getElementById('loopGenStatus');
    if(el) el.textContent = txt;
  }

  function updateLgBtns(){
    const playBtn = document.getElementById('lgPlayBtn');
    const loopBtn = document.getElementById('lgLoopBtn');
    if(playBtn) playBtn.textContent = lgPlaying ? '■ STOP' : '▶ PLAY';
    if(loopBtn) loopBtn.classList.toggle('on', lgLooping);
  }

  // ── MIDI Export ──
  function buildLgMIDI(){
    const tpq = 480;
    const bpm = (typeof M !== 'undefined' && M.bpm) ? M.bpm : 120;
    const usec = Math.round(60000000 / bpm);
    const events = [];
    let tick = 0;
    const barTicks = tpq * 4;

    lgStructure.forEach(sec => {
      const chordDuration = Math.round(barTicks * sec.bars / Math.max(1, sec.chords.length));
      sec.chords.forEach(ch => {
        const notes = ch.notes.split('·').filter(Boolean).slice(0,4);
        const midiNotes = notes.map(n => (NOTE_MIDI_G[n] || 60));
        midiNotes.forEach(mn => events.push({ tick, type: 'on',  note: mn, vel: 80 }));
        midiNotes.forEach(mn => events.push({ tick: tick + chordDuration - 10, type: 'off', note: mn, vel: 0 }));
        tick += chordDuration;
      });
    });

    events.sort((a,b) => a.tick - b.tick || (a.type==='off'?-1:1));
    return typeof buildMIDIBytesGlobal === 'function'
      ? buildMIDIBytesGlobal(events, tpq)
      : buildMIDIBytesSimple(events, tpq, usec);
  }

  function buildMIDIBytesSimple(events, tpq, usec){
    function varLen(v){ const b=[]; do{let x=v&0x7f;v>>=7;b.unshift(v?x|0x80:x);}while(v);return b; }
    const track = [0,0,0,0, 0xff,0x51,3,(usec>>16)&0xff,(usec>>8)&0xff,usec&0xff]; // tempo
    let last = 0;
    events.forEach(ev => {
      const delta = ev.tick - last; last = ev.tick;
      track.push(...varLen(delta));
      if(ev.type==='on')  track.push(0x90, ev.note, ev.vel||80);
      else                track.push(0x80, ev.note, 0);
    });
    track.push(0,0xff,0x2f,0); // EOT
    const tlen = track.length;
    const hdr = [0x4d,0x54,0x68,0x64,0,0,0,6,0,0,0,1,(tpq>>8)&0xff,tpq&0xff];
    const trk = [0x4d,0x54,0x72,0x6b,(tlen>>24)&0xff,(tlen>>16)&0xff,(tlen>>8)&0xff,tlen&0xff,...track];
    return new Uint8Array([...hdr,...trk]);
  }

  // ── Complexity dots ──
  const cplxDots = document.getElementById('lgComplexityDots');
  if(cplxDots){
    for(let i = 1; i <= 5; i++){
      const d = document.createElement('div');
      d.className = 'complexity-dot' + (i <= lgComplexity ? ' on' : '');
      d.dataset.v = i;
      d.addEventListener('click', () => {
        lgComplexity = i;
        document.querySelectorAll('#lgComplexityDots .complexity-dot').forEach(x => x.classList.toggle('on', parseInt(x.dataset.v) <= lgComplexity));
        const val = document.getElementById('lgComplexityVal');
        if(val) val.textContent = lgComplexity;
      });
      cplxDots.appendChild(d);
    }
  }

  // ── Event listeners ──
  const lgGenreBtns = document.getElementById('lgGenreBtns');
  if(lgGenreBtns){
    lgGenreBtns.addEventListener('click', e => {
      const g = e.target.dataset.genre; if(!g) return;
      lgGenre = g;
      lgGenreBtns.querySelectorAll('.b').forEach(b => b.classList.toggle('on', b.dataset.genre === g));
    });
  }

  const lgTypeBtns = document.getElementById('lgTypeBtns');
  if(lgTypeBtns){
    lgTypeBtns.addEventListener('click', e => {
      const t = e.target.dataset.lgtype; if(!t) return;
      lgType = t;
      lgTypeBtns.querySelectorAll('.b').forEach(b => b.classList.toggle('on', b.dataset.lgtype === t));
      const loopWrap = document.getElementById('lgLoopLenWrap');
      const songWrap = document.getElementById('lgSongLenWrap');
      if(loopWrap) loopWrap.style.display = t === 'loop' ? 'flex' : 'none';
      if(songWrap) songWrap.style.display = t === 'song' ? 'flex' : 'none';
    });
  }

  const lgLoopBarsSel = document.getElementById('lgLoopBars');
  if(lgLoopBarsSel) lgLoopBarsSel.addEventListener('change', e => { lgLoopBars = parseInt(e.target.value); });

  const lgSongMinsSel = document.getElementById('lgSongMins');
  if(lgSongMinsSel) lgSongMinsSel.addEventListener('change', e => { lgSongMins = parseInt(e.target.value); });

  const lgJazzBtn = document.getElementById('lgJazzUpBtn');
  if(lgJazzBtn){
    lgJazzBtn.addEventListener('click', () => {
      lgJazzUp = !lgJazzUp;
      lgJazzBtn.textContent = lgJazzUp ? '● Jazz+' : '○ Jazz+';
      lgJazzBtn.classList.toggle('on', lgJazzUp);
    });
  }

  const lgGenBtn = document.getElementById('lgGenerateBtn');
  if(lgGenBtn) lgGenBtn.addEventListener('click', () => { if(lgPlaying) stopLg(); generate(); });

  const lgPlayBtn2 = document.getElementById('lgPlayBtn');
  if(lgPlayBtn2) lgPlayBtn2.addEventListener('click', () => lgPlaying ? stopLg() : startLg());

  const lgLoopBtn2 = document.getElementById('lgLoopBtn');
  if(lgLoopBtn2) lgLoopBtn2.addEventListener('click', () => {
    lgLooping = !lgLooping;
    lgLoopBtn2.classList.toggle('on', lgLooping);
  });

  const lgShuffleBtn = document.getElementById('lgShuffleBtn');
  if(lgShuffleBtn) lgShuffleBtn.addEventListener('click', () => {
    const wasPlaying = lgPlaying;
    if(wasPlaying) stopLg();
    generate();
    if(wasPlaying) startLg();
  });

  const lgDlBtn = document.getElementById('lgDlBtn');
  if(lgDlBtn) lgDlBtn.addEventListener('click', () => {
    if(!lgStructure.length){ generate(); }
    const bytes = buildLgMIDI();
    if(typeof exportSimpleMIDI === 'function') exportSimpleMIDI('vaikhari-loop.mid', bytes);
  });

  // Global play/stop integration
  window._lgStart = startLg;
  window._lgStop  = stopLg;
  window._lgIsPlaying = () => lgPlaying;

  // Generate on open
  document.getElementById('togLoopGen')?.addEventListener('click', () => {
    if(!lgStructure.length) generate();
  });
})();



</script>
</body>
</html>
